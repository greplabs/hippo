name: Nightly Builds

on:
  schedule:
    # Run at 2 AM UTC every day
    - cron: '0 2 * * *'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  # Build nightly releases
  nightly-build:
    name: Nightly Build - ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact_name: hippo-nightly-linux-x86_64
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact_name: hippo-nightly-macos-x86_64
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact_name: hippo-nightly-macos-aarch64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact_name: hippo-nightly-windows-x86_64
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly
        with:
          targets: ${{ matrix.target }}

      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            librsvg2-dev \
            patchelf \
            libssl-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            libsoup-3.0-dev \
            libjavascriptcoregtk-4.1-dev

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-${{ matrix.target }}-cargo-nightly-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-${{ matrix.target }}-cargo-nightly-

      - name: Build nightly release
        run: |
          cargo +nightly build --release --target ${{ matrix.target }}

      - name: Prepare artifacts (Unix)
        if: runner.os != 'Windows'
        run: |
          mkdir -p nightly
          DATE=$(date +%Y%m%d)
          cp target/${{ matrix.target }}/release/hippo-tauri nightly/hippo-tauri-${DATE} || true
          cp target/${{ matrix.target }}/release/hippo nightly/hippo-cli-${DATE} || true
          chmod +x nightly/* || true

      - name: Prepare artifacts (Windows)
        if: runner.os == 'Windows'
        run: |
          mkdir nightly
          $DATE = Get-Date -Format "yyyyMMdd"
          Copy-Item "target\${{ matrix.target }}\release\hippo-tauri.exe" "nightly\hippo-tauri-${DATE}.exe" -ErrorAction SilentlyContinue
          Copy-Item "target\${{ matrix.target }}\release\hippo.exe" "nightly\hippo-cli-${DATE}.exe" -ErrorAction SilentlyContinue
        shell: pwsh

      - name: Upload nightly artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: nightly/*
          retention-days: 7

  # Create nightly release
  create-nightly-release:
    name: Create Nightly Release
    needs: nightly-build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare nightly release
        run: |
          DATE=$(date +%Y%m%d)
          mkdir -p nightly-release

          # Collect all nightly builds
          for dir in artifacts/*/; do
            cp "$dir"* nightly-release/ 2>/dev/null || true
          done

          # Create checksums
          cd nightly-release
          sha256sum * > SHA256SUMS-nightly-${DATE}.txt
          cd ..

          ls -lh nightly-release/

      - name: Delete old nightly releases
        run: |
          # Keep only last 7 nightly releases
          gh release list --limit 100 | grep "nightly-" | tail -n +8 | while read -r line; do
            TAG=$(echo "$line" | awk '{print $3}')
            echo "Deleting old nightly release: $TAG"
            gh release delete "$TAG" --yes || true
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create nightly release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DATE=$(date +%Y%m%d)
          TAG="nightly-${DATE}"

          # Delete existing nightly release for today if it exists
          gh release delete "$TAG" --yes || true
          git push origin :refs/tags/$TAG || true

          # Create new nightly release
          gh release create "$TAG" \
            --title "Nightly Build ${DATE}" \
            --notes "Automated nightly build from main branch

          **⚠️ Warning**: This is a pre-release build and may be unstable.

          **Commit**: ${{ github.sha }}
          **Date**: $(date)

          ### Download
          Choose the binary for your platform from the assets below.

          ### Verification
          Verify downloads using SHA256SUMS file.

          ---
          *This is an automated nightly build. It will be automatically deleted after 7 days.*" \
            --prerelease \
            --latest=false \
            nightly-release/*

  # Test nightly builds
  test-nightly:
    name: Test Nightly Build
    needs: nightly-build
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly

      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            librsvg2-dev \
            patchelf \
            libssl-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            libsoup-3.0-dev \
            libjavascriptcoregtk-4.1-dev

      - name: Run nightly tests
        run: cargo +nightly test --workspace
        continue-on-error: true

  # Notify on failure
  notify-failure:
    name: Notify on Failure
    needs: [nightly-build, create-nightly-release, test-nightly]
    runs-on: ubuntu-latest
    if: failure() && github.event_name == 'schedule'
    steps:
      - name: Create issue on failure
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Nightly build failed on ${date}`,
              body: `The nightly build workflow failed. Please investigate.

              **Workflow run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
              **Date**: ${date}

              cc: @maintainers`,
              labels: ['automated', 'nightly', 'build-failure']
            });
