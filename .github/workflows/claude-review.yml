name: Code Review

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  review:
    name: AI Review
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed
        run: |
          FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep -E '\.(rs|toml)$' | head -5 | tr '\n' ' ')
          echo "files=$FILES" >> $GITHUB_OUTPUT

      - name: Run Claude Review
        if: steps.changed.outputs.files != ''
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Skip if no API key
          if [ -z "$ANTHROPIC_API_KEY" ]; then
            echo "No API key configured, skipping review"
            exit 0
          fi

          # Get diff and truncate to avoid argument limits (max 50KB)
          git diff ${{ github.event.pull_request.base.sha }} ${{ github.sha }} -- ${{ steps.changed.outputs.files }} | head -c 50000 > /tmp/diff.txt

          # Check if diff is empty
          if [ ! -s /tmp/diff.txt ]; then
            echo "No diff to review"
            exit 0
          fi

          # Build JSON payload using file input (avoids argument length issues)
          jq -n --rawfile diff /tmp/diff.txt '{
            model: "claude-sonnet-4-20250514",
            max_tokens: 2048,
            messages: [{
              role: "user",
              content: ("Review this Rust code diff for bugs, security issues, and improvements. Be concise. If the diff is truncated, just review what you can see.\n\n```diff\n" + $diff + "\n```")
            }]
          }' > /tmp/request.json

          # Call Claude API
          RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d @/tmp/request.json)

          # Extract review text
          REVIEW=$(echo "$RESPONSE" | jq -r '.content[0].text // empty')

          # Check if we got a valid review
          if [ -z "$REVIEW" ]; then
            ERROR=$(echo "$RESPONSE" | jq -r '.error.message // "Unknown error"')
            echo "API error: $ERROR"
            echo -e "## Code Review\n\n⚠️ Review unavailable: $ERROR\n\n---\n*Powered by Claude*" > /tmp/comment.md
          else
            echo -e "## Code Review\n\n$REVIEW\n\n---\n*Powered by Claude*" > /tmp/comment.md
          fi

          gh pr comment ${{ github.event.pull_request.number }} --body-file /tmp/comment.md

  audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - run: cargo install cargo-audit || true
      - run: cargo audit || true
