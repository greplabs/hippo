name: Code Review

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  review:
    name: AI Review
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed
        run: |
          FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep -E '\.(rs|toml)$' | head -10 | tr '\n' ' ')
          echo "files=$FILES" >> $GITHUB_OUTPUT

      - name: Run Claude Review
        if: steps.changed.outputs.files != '' && env.ANTHROPIC_API_KEY != ''
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git diff ${{ github.event.pull_request.base.sha }} ${{ github.sha }} -- ${{ steps.changed.outputs.files }} > /tmp/diff.txt

          REVIEW=$(curl -s https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d "$(jq -n --arg diff "$(cat /tmp/diff.txt)" '{
              model: "claude-sonnet-4-20250514",
              max_tokens: 2048,
              messages: [{
                role: "user",
                content: ("Review this Rust code diff for bugs, security issues, and improvements. Be concise.\n\n```diff\n" + $diff + "\n```")
              }]
            }')" | jq -r '.content[0].text')

          echo -e "## Code Review\n\n$REVIEW\n\n---\n*Powered by Claude*" > /tmp/comment.md
          gh pr comment ${{ github.event.pull_request.number }} --body-file /tmp/comment.md

  audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - run: cargo install cargo-audit || true
      - run: cargo audit || true
