name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  claude-review:
    name: AI Code Review
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        run: |
          echo "files=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep -E '\.(rs|toml)$' | head -20 | tr '\n' ' ')" >> $GITHUB_OUTPUT

      - name: Install Claude Code
        if: steps.changed-files.outputs.files != ''
        run: |
          npm install -g @anthropic-ai/claude-code

      - name: Run Claude Review
        if: steps.changed-files.outputs.files != ''
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Create review request
          cat > /tmp/review_prompt.txt << 'EOF'
          Please review the following code changes for this Hippo project PR.
          Focus on:
          1. Code correctness and potential bugs
          2. Performance implications
          3. Security concerns
          4. Rust best practices and idiomatic code
          5. Error handling
          6. Documentation completeness

          Provide a concise, actionable review with specific line references where applicable.
          Format your response as markdown suitable for a GitHub PR comment.
          EOF

          # Get the diff
          git diff ${{ github.event.pull_request.base.sha }} ${{ github.sha }} -- ${{ steps.changed-files.outputs.files }} > /tmp/diff.txt

          # Use Claude API directly for review
          if [ -n "$ANTHROPIC_API_KEY" ]; then
            curl -s https://api.anthropic.com/v1/messages \
              -H "Content-Type: application/json" \
              -H "x-api-key: $ANTHROPIC_API_KEY" \
              -H "anthropic-version: 2023-06-01" \
              -d "$(jq -n --arg prompt "$(cat /tmp/review_prompt.txt)" --arg diff "$(cat /tmp/diff.txt)" '{
                model: "claude-sonnet-4-20250514",
                max_tokens: 4096,
                messages: [{
                  role: "user",
                  content: ($prompt + "\n\nCode diff:\n```diff\n" + $diff + "\n```")
                }]
              }')" | jq -r '.content[0].text' > /tmp/review.md

            echo "## ðŸ¤– Claude Code Review" > /tmp/comment.md
            echo "" >> /tmp/comment.md
            cat /tmp/review.md >> /tmp/comment.md
            echo "" >> /tmp/comment.md
            echo "---" >> /tmp/comment.md
            echo "*Powered by Claude Sonnet 4*" >> /tmp/comment.md
          else
            echo "ANTHROPIC_API_KEY not set, skipping review"
            exit 0
          fi

      - name: Post Review Comment
        if: steps.changed-files.outputs.files != '' && env.ANTHROPIC_API_KEY != ''
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -f /tmp/comment.md ]; then
            gh pr comment ${{ github.event.pull_request.number }} --body-file /tmp/comment.md
          fi

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Security audit
        run: cargo audit || true  # Don't fail on advisories, just report
