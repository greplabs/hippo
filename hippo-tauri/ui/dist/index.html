<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hippo</title>
  <!-- Prism.js for syntax highlighting -->
  <link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/line-numbers/prism-line-numbers.min.css" rel="stylesheet" />
  <!-- D3.js for graph visualization -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    /* ===== DESIGN TOKENS ===== */
    :root {
      --space-xs: 4px;
      --space-sm: 8px;
      --space-md: 12px;
      --space-lg: 16px;
      --space-xl: 24px;
      --btn-height: 40px;
      --btn-height-lg: 44px;
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 14px;
      --transition-fast: 0.15s ease;
      --transition-normal: 0.2s ease;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    /* Smooth global transitions */
    html { scroll-behavior: smooth; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;
      background: #f8f8f7;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      letter-spacing: -0.01em;
      line-height: 1.5;
    }
    body.dark { background: #0f0e0d; }

    /* Targeted transitions - NOT on * (causes layout shift) */
    body, button, input, .card, .list-item, .sidebar-btn, .filter-btn, .tag-btn, .action-btn {
      transition: background-color var(--transition-fast), border-color var(--transition-fast),
                  color var(--transition-fast), box-shadow var(--transition-fast), transform var(--transition-fast);
    }

    /* Global animation keyframes */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeInScale {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    @keyframes scaleIn {
      from { transform: scale(0.9); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    @keyframes rotateIcon {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* Skeleton loader base */
    .skeleton {
      background: linear-gradient(90deg, #e7e5e4 25%, #f5f5f4 50%, #e7e5e4 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s ease-in-out infinite;
      border-radius: 6px;
    }
    body.dark .skeleton {
      background: linear-gradient(90deg, #292524 25%, #44403c 50%, #292524 75%);
      background-size: 200% 100%;
    }

    /* Loading state for containers */
    .loading-state {
      position: relative;
      pointer-events: none;
    }
    .loading-state::after {
      content: '';
      position: absolute;
      inset: 0;
      background: rgba(248, 248, 247, 0.7);
      backdrop-filter: blur(2px);
      border-radius: inherit;
    }
    body.dark .loading-state::after {
      background: rgba(15, 14, 13, 0.7);
    }

    /* Custom icon styles */
    .icon { display: inline-flex; align-items: center; justify-content: center; width: 1em; height: 1em; flex-shrink: 0; }
    .icon svg { width: 100%; height: 100%; }
    .icon-sm { width: 16px; height: 16px; }
    .icon-md { width: 20px; height: 20px; }
    .icon-lg { width: 24px; height: 24px; }
    .icon-xl { width: 32px; height: 32px; }
    .icon-2xl { width: 48px; height: 48px; }
    .filter-btn .icon { margin-right: 2px; }
    .sidebar-btn .icon { opacity: 0.7; }
    .card-star .icon { color: inherit; }
    .card-star.active .icon { color: white; }
    body.dark .icon { color: #a8a29e; }
    body.dark .card-preview .icon { color: #78716c; }
    body.dark .card-star .icon { color: #57534e; }
    body.dark .card-star.active .icon { color: white; }

    .app { display: flex; height: 100vh; width: 100%; }

    /* Sidebar */
    .sidebar {
      width: 240px;
      background: white;
      border-right: 1px solid rgba(0,0,0,0.06);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 1px 0 10px rgba(0,0,0,0.02);
    }
    body.dark .sidebar { background: #1a1918; border-color: rgba(255,255,255,0.06); box-shadow: 1px 0 10px rgba(0,0,0,0.2); }
    .sidebar-header { padding: 20px; border-bottom: 1px solid rgba(0,0,0,0.04); }
    body.dark .sidebar-header { border-color: rgba(255,255,255,0.04); }
    .sidebar-header h1 { font-size: 17px; font-weight: 700; color: #1c1917; letter-spacing: -0.02em; }
    body.dark .sidebar-header h1 { color: #fafaf9; }
    .sidebar-header p { font-size: 12px; color: #a8a29e; margin-top: 2px; }
    .sidebar-content { flex: 1; padding: 16px; overflow-y: auto; }
    .sidebar-footer { padding: 16px; border-top: 1px solid rgba(0,0,0,0.04); }
    body.dark .sidebar-footer { border-color: rgba(255,255,255,0.04); }
    .sidebar-footer p { font-size: 12px; color: #a8a29e; }
    .sidebar-actions { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }
    .sidebar-icon-btn {
      width: 40px;
      height: 40px;
      border: none;
      border-radius: 10px;
      background: rgba(0,0,0,0.04);
      color: #57534e;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
    }
    .sidebar-icon-btn:hover { background: rgba(0,0,0,0.08); color: #292524; transform: translateY(-1px); }
    .sidebar-icon-btn:active { transform: translateY(0) scale(0.95); }
    body.dark .sidebar-icon-btn { background: rgba(255,255,255,0.06); color: #a8a29e; }
    body.dark .sidebar-icon-btn:hover { background: rgba(255,255,255,0.1); color: #d6d3d1; }
    .sidebar-icon-btn.danger { color: #dc2626; }
    .sidebar-icon-btn.danger:hover { background: rgba(220,38,38,0.1); }
    body.dark .sidebar-icon-btn.danger { color: #f87171; }
    .sidebar-icon-btn.primary {
      background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(99,102,241,0.25);
    }
    .sidebar-icon-btn.primary:hover { box-shadow: 0 4px 12px rgba(99,102,241,0.35); }
    .sidebar-icon-btn .icon { width: 18px; height: 18px; }
    .section-title { font-size: 10px; color: #a8a29e; text-transform: uppercase; margin-bottom: 10px; letter-spacing: 0.08em; font-weight: 600; }

    .source-item {
      padding: 10px 12px;
      font-size: 13px;
      color: #57534e;
      border-radius: 10px;
      margin-bottom: 6px;
      background: rgba(0,0,0,0.02);
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid transparent;
    }
    .source-item:hover { background: rgba(0,0,0,0.04); transform: translateX(2px); }
    .source-item:active { transform: translateX(2px) scale(0.98); }
    body.dark .source-item { background: rgba(255,255,255,0.04); color: #d6d3d1; }
    body.dark .source-item:hover { background: rgba(255,255,255,0.08); }
    .source-dot { width: 8px; height: 8px; border-radius: 50%; background: #22c55e; flex-shrink: 0; box-shadow: 0 0 8px rgba(34, 197, 94, 0.4); }

    /* Status indicators */
    .status-row { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; font-size: 11px; color: #78716c; }
    body.dark .status-row { color: #a8a29e; }
    .status-indicator { display: flex; align-items: center; gap: 4px; }
    .status-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
    .status-dot.online { background: #22c55e; box-shadow: 0 0 6px rgba(34, 197, 94, 0.5); }
    .status-dot.offline { background: #a8a29e; }
    .status-dot.loading { background: #f59e0b; animation: pulse 1s ease-in-out infinite; }

    .add-btn {
      width: 100%;
      padding: 12px 14px;
      background: transparent;
      border: 2px dashed rgba(0,0,0,0.1);
      border-radius: 10px;
      color: #78716c;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      text-align: left;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .add-btn:hover { background: rgba(0,0,0,0.02); color: #57534e; border-color: rgba(0,0,0,0.2); transform: translateY(-1px); }
    .add-btn:active { transform: translateY(0) scale(0.98); }
    body.dark .add-btn { background: transparent; border-color: rgba(255,255,255,0.1); color: #a8a29e; }
    body.dark .add-btn:hover { background: rgba(255,255,255,0.04); color: #d6d3d1; border-color: rgba(255,255,255,0.2); }

    .sidebar-btn {
      width: 100%;
      padding: 10px 12px;
      background: transparent;
      border: none;
      border-radius: 8px;
      color: #78716c;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      text-align: left;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .sidebar-btn:hover { background: rgba(0,0,0,0.04); color: #44403c; transform: translateX(2px); }
    .sidebar-btn:active { transform: translateX(2px) scale(0.98); }
    body.dark .sidebar-btn { color: #a8a29e; }
    body.dark .sidebar-btn:hover { background: rgba(255,255,255,0.06); color: #e7e5e4; }
    .sidebar-btn.danger:hover { background: rgba(220, 38, 38, 0.08); color: #dc2626; }
    body.dark .sidebar-btn.danger:hover { background: rgba(248, 113, 113, 0.1); color: #f87171; }
    .sidebar-btn.ai-chat-btn {
      background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.25);
      margin-bottom: 8px;
    }
    .sidebar-btn.ai-chat-btn:hover { background: linear-gradient(135deg, #7c3aed 0%, #4f46e5 100%); color: white; box-shadow: 0 6px 16px rgba(99, 102, 241, 0.35); transform: translateY(-1px); }
    .sidebar-btn.ai-chat-btn:active { transform: translateY(0) scale(0.98); box-shadow: 0 2px 8px rgba(99, 102, 241, 0.25); }
    .sidebar-btn.ai-chat-btn .icon { opacity: 1; }

    /* Main area */
    .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; min-width: 0; }

    .search-bar {
      background: white;
      border-bottom: 1px solid rgba(0,0,0,0.05);
      padding: 20px 24px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    body.dark .search-bar { background: #1a1918; border-color: rgba(255,255,255,0.05); }

    /* Theme toggle button in header */
    .theme-toggle-btn {
      width: 40px;
      height: 40px;
      border: none;
      border-radius: 10px;
      background: rgba(0,0,0,0.04);
      color: #57534e;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      flex-shrink: 0;
      margin-left: 12px;
    }
    .theme-toggle-btn:hover {
      background: rgba(0,0,0,0.08);
      color: #1c1917;
      transform: translateY(-1px);
    }
    .theme-toggle-btn:active {
      transform: translateY(0) scale(0.95);
    }
    .theme-toggle-btn .icon {
      transition: transform 0.2s ease;
    }
    .theme-toggle-btn.rotating .icon {
      animation: rotateIcon 0.5s ease;
    }
    body.dark .theme-toggle-btn {
      background: rgba(255,255,255,0.06);
      color: #d6d3d1;
    }
    body.dark .theme-toggle-btn:hover {
      background: rgba(255,255,255,0.1);
      color: #fafaf9;
    }

    .search-container {
      display: flex;
      align-items: center;
      gap: 10px;
      max-width: 640px;
      padding: 12px 18px;
      background: rgba(0,0,0,0.03);
      border: 1px solid transparent;
      border-radius: 14px;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .search-container:focus-within {
      background: white;
      border-color: rgba(99, 102, 241, 0.3);
      box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.08), 0 4px 16px rgba(0,0,0,0.06);
    }
    body.dark .search-container { background: rgba(255,255,255,0.04); }
    body.dark .search-container:focus-within { background: #292524; border-color: rgba(99, 102, 241, 0.4); box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1), 0 4px 16px rgba(0,0,0,0.2); }
    .search-icon { color: #a8a29e; font-size: 16px; transition: color 0.2s; }
    .search-container:focus-within .search-icon { color: #6366f1; }
    .search-input { flex: 1; border: none; background: transparent; font-size: 14px; outline: none; color: #1c1917; font-weight: 400; }
    .search-input::placeholder { color: #a8a29e; }
    body.dark .search-input { color: #fafaf9; }

    /* AI badge for natural language search */
    .ai-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
      color: white;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.02em;
      animation: scaleIn 0.2s ease;
      flex-shrink: 0;
    }
    .ai-badge .icon { font-size: 12px; }

    /* NL interpretation display */
    .nl-interpretation {
      display: none;
      margin-top: 10px;
      padding: 10px 14px;
      background: rgba(99, 102, 241, 0.08);
      border-left: 3px solid #6366f1;
      border-radius: 8px;
      font-size: 13px;
      color: #4338ca;
      animation: fadeInUp 0.2s ease;
    }
    .nl-interpretation.show { display: block; }
    body.dark .nl-interpretation { background: rgba(99, 102, 241, 0.15); color: #a5b4fc; }
    .nl-interpretation-label { font-weight: 600; margin-right: 6px; }

    /* Recent searches dropdown */
    .search-wrapper { position: relative; }
    .recent-searches {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid rgba(0,0,0,0.08);
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.12);
      padding: 8px;
      z-index: 100;
      animation: fadeInUp 0.15s ease;
      display: none;
    }
    .recent-searches.show { display: block; }
    body.dark .recent-searches { background: #1c1917; border-color: rgba(255,255,255,0.08); }
    .recent-search-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      color: #57534e;
      transition: all 0.15s;
    }
    .recent-search-item:hover { background: #f5f5f4; color: #1c1917; }
    body.dark .recent-search-item { color: #a8a29e; }
    body.dark .recent-search-item:hover { background: #292524; color: #fafaf9; }
    .recent-search-icon { opacity: 0.5; }
    .recent-search-text { flex: 1; font-weight: 500; }
    .recent-search-meta { display: flex; align-items: center; gap: 8px; font-size: 11px; color: #a8a29e; }
    body.dark .recent-search-meta { color: #78716c; }
    .recent-search-count { padding: 2px 6px; background: rgba(0,0,0,0.04); border-radius: 4px; }
    body.dark .recent-search-count { background: rgba(255,255,255,0.06); }
    .recent-search-time { opacity: 0.7; }
    .recent-search-remove { padding: 4px; background: none; border: none; color: #a8a29e; cursor: pointer; border-radius: 4px; transition: all 0.15s; opacity: 0; flex-shrink: 0; }
    .recent-search-item:hover .recent-search-remove { opacity: 1; }
    .recent-search-remove:hover { background: rgba(0,0,0,0.06); color: #dc2626; }
    body.dark .recent-search-remove:hover { background: rgba(255,255,255,0.08); color: #f87171; }
    .search-dropdown-section { padding: 8px 0; border-bottom: 1px solid rgba(0,0,0,0.06); }
    .search-dropdown-section:last-child { border-bottom: none; }
    body.dark .search-dropdown-section { border-color: rgba(255,255,255,0.06); }
    .search-dropdown-header { display: flex; align-items: center; justify-content: space-between; padding: 4px 8px; font-size: 10px; font-weight: 600; color: #a8a29e; text-transform: uppercase; letter-spacing: 0.08em; }
    .search-dropdown-clear { padding: 4px 8px; background: none; border: none; color: #78716c; font-size: 11px; font-weight: 500; cursor: pointer; border-radius: 4px; transition: all 0.15s; text-transform: none; letter-spacing: 0; }
    .search-dropdown-clear:hover { background: rgba(0,0,0,0.04); color: #dc2626; }
    body.dark .search-dropdown-clear:hover { background: rgba(255,255,255,0.06); color: #f87171; }
    .save-search-btn { padding: 6px 12px; background: rgba(99, 102, 241, 0.08); border: 1px solid rgba(99, 102, 241, 0.2); border-radius: 8px; color: #6366f1; font-size: 12px; font-weight: 500; cursor: pointer; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); display: flex; align-items: center; gap: 4px; flex-shrink: 0; }
    .save-search-btn:hover { background: rgba(99, 102, 241, 0.12); border-color: rgba(99, 102, 241, 0.3); transform: translateY(-1px); }
    .save-search-btn:active { transform: translateY(0) scale(0.98); }
    body.dark .save-search-btn { background: rgba(99, 102, 241, 0.15); border-color: rgba(99, 102, 241, 0.3); }
    body.dark .save-search-btn:hover { background: rgba(99, 102, 241, 0.2); border-color: rgba(99, 102, 241, 0.4); }
    .saved-search-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 8px; cursor: pointer; font-size: 13px; color: #57534e; transition: all 0.15s; border: 1px solid rgba(99, 102, 241, 0.1); background: rgba(99, 102, 241, 0.02); margin-bottom: 4px; }
    .saved-search-item:hover { background: rgba(99, 102, 241, 0.08); border-color: rgba(99, 102, 241, 0.2); color: #1c1917; }
    body.dark .saved-search-item { color: #a8a29e; background: rgba(99, 102, 241, 0.05); border-color: rgba(99, 102, 241, 0.15); }
    body.dark .saved-search-item:hover { background: rgba(99, 102, 241, 0.12); border-color: rgba(99, 102, 241, 0.25); color: #fafaf9; }
    .saved-search-icon { color: #6366f1; flex-shrink: 0; }
    .saved-search-name { flex: 1; font-weight: 600; }
    .saved-search-query { font-size: 11px; color: #a8a29e; opacity: 0.8; }

    /* Date filter pills */
    .date-filters {
      display: flex;
      gap: 6px;
      margin-left: 12px;
      padding-left: 12px;
      border-left: 1px solid rgba(0,0,0,0.08);
    }
    body.dark .date-filters { border-left-color: rgba(255,255,255,0.08); }
    .date-filter-btn {
      padding: 6px 12px;
      border: none;
      background: transparent;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 500;
      color: #78716c;
      cursor: pointer;
      transition: all 0.15s;
    }
    .date-filter-btn:hover { background: #f5f5f4; color: #1c1917; }
    .date-filter-btn.active { background: #6366f1; color: white; }
    body.dark .date-filter-btn { color: #a8a29e; }
    body.dark .date-filter-btn:hover { background: #292524; color: #fafaf9; }
    body.dark .date-filter-btn.active { background: #6366f1; color: white; }

    .active-tags { display: flex; gap: 6px; flex-wrap: wrap; }
    .active-tag {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 5px 10px;
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      color: white;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 500;
      animation: scaleIn 0.2s ease;
    }
    .active-tag button { background: none; border: none; color: rgba(255,255,255,0.7); cursor: pointer; font-size: 14px; line-height: 1; transition: all 0.15s; }
    .active-tag button:hover { color: white; transform: scale(1.1); }
    .tag-bar { display: flex; gap: 8px; margin-top: 14px; flex-wrap: wrap; align-items: center; }
    .tag-label { font-size: 11px; color: #a8a29e; font-weight: 500; }
    .tag-btn {
      padding: 6px 12px;
      background: rgba(0,0,0,0.04);
      border: none;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 500;
      color: #57534e;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .tag-btn:hover { background: rgba(0,0,0,0.08); transform: translateY(-1px); }
    .tag-btn:active { transform: translateY(0) scale(0.98); }
    .tag-btn.active { background: #1c1917; color: white; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
    body.dark .tag-btn { background: rgba(255,255,255,0.06); color: #d6d3d1; }
    body.dark .tag-btn:hover { background: rgba(255,255,255,0.1); }
    body.dark .tag-btn.active { background: #fafaf9; color: #1c1917; }

    .filter-bar {
      background: white;
      border-bottom: 1px solid rgba(0,0,0,0.04);
      padding: 12px 24px;
      display: flex;
      gap: 8px;
      align-items: center;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    body.dark .filter-bar { background: #1a1918; border-color: rgba(255,255,255,0.04); }
    .filter-btn {
      height: var(--btn-height);
      padding: 0 var(--space-lg);
      border-radius: var(--radius-md);
      font-size: 13px;
      font-weight: 500;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    .filter-btn.active {
      background: #1c1917;
      color: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.12);
    }
    body.dark .filter-btn.active { background: #fafaf9; color: #1c1917; }
    .filter-btn:not(.active) { background: rgba(0,0,0,0.04); color: #57534e; }
    .filter-btn:not(.active):hover { background: rgba(0,0,0,0.08); transform: translateY(-1px); }
    .filter-btn:not(.active):active { transform: translateY(0) scale(0.98); }
    body.dark .filter-btn:not(.active) { background: rgba(255,255,255,0.06); color: #d6d3d1; }
    body.dark .filter-btn:not(.active):hover { background: rgba(255,255,255,0.1); }
    .filter-spacer { flex: 1; }
    .result-count { font-size: 13px; color: #a8a29e; font-weight: 500; }
    .view-toggle {
      display: flex;
      gap: 4px;
      background: rgba(0,0,0,0.04);
      padding: 4px;
      border-radius: 10px;
    }
    body.dark .view-toggle { background: rgba(255,255,255,0.06); }
    .view-btn {
      width: var(--btn-height);
      height: var(--btn-height);
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      background: transparent;
      color: #78716c;
      font-size: 16px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .view-btn:hover:not(.active) { background: rgba(0,0,0,0.04); }
    .view-btn.active { background: white; color: #1c1917; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    body.dark .view-btn.active { background: #292524; color: #fafaf9; }

    .content { flex: 1; overflow-y: auto; padding: 24px 28px; scroll-behavior: smooth; }

    /* Grid */
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(190px, 1fr)); gap: 20px; }
    .list { display: flex; flex-direction: column; gap: 6px; max-width: 900px; }

    /* Virtual scrolling */
    .virtual-scroll-container { position: relative; width: 100%; }
    .virtual-scroll-spacer { width: 100%; }
    .virtual-scroll-content { position: absolute; top: 0; left: 0; right: 0; }
    .virtual-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(190px, 1fr)); gap: 20px; }
    .virtual-list { display: flex; flex-direction: column; gap: 6px; max-width: 900px; }

    .card {
      background: white;
      border-radius: 16px;
      border: 1px solid rgba(0,0,0,0.04);
      overflow: hidden;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }
    .card:hover {
      box-shadow: 0 20px 40px -12px rgba(0,0,0,0.12), 0 0 0 1px rgba(0,0,0,0.02);
      transform: translateY(-4px);
    }
    .card:active { transform: translateY(-2px) scale(0.99); }
    .card.keyboard-focused {
      outline: 2px solid #3b82f6;
      outline-offset: 2px;
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15);
      transform: translateY(-2px);
    }
    body.dark .card { background: #1c1917; border-color: rgba(255,255,255,0.04); }
    body.dark .card:hover { box-shadow: 0 20px 40px -12px rgba(0,0,0,0.4); }
    body.dark .card.keyboard-focused { box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.25); }

    .card-preview {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 36px;
      position: relative;
      overflow: hidden;
      background: linear-gradient(135deg, #fafaf9 0%, #f5f5f4 100%);
    }
    body.dark .card-preview { background: linear-gradient(135deg, #292524 0%, #1c1917 100%); }
    .card-preview img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .card:hover .card-preview img { transform: scale(1.05); }

    .card-info { padding: 14px 16px; }
    .card-title { font-size: 13px; font-weight: 600; color: #1c1917; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; letter-spacing: -0.01em; }
    body.dark .card-title { color: #f5f5f4; }
    .card-size { font-size: 11px; color: #a8a29e; margin-top: 4px; font-weight: 500; }

    .card-star {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 32px;
      height: 32px;
      border-radius: 10px;
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(8px);
      border: none;
      cursor: pointer;
      font-size: 14px;
      opacity: 0;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .card:hover .card-star { opacity: 1; }
    .card-star.active { opacity: 1; background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: white; }
    .card-star:hover { transform: scale(1.15); }
    .card-star:active { transform: scale(1.05); }

    /* List view */
    .list-item {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 12px 14px;
      background: transparent;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .list-item:hover { background: white; transform: translateX(4px); box-shadow: 0 4px 16px rgba(0,0,0,0.06); }
    .list-item:active { transform: translateX(4px) scale(0.99); }
    .list-item.keyboard-focused { background: white; outline: 2px solid #3b82f6; outline-offset: -2px; }
    body.dark .list-item:hover { background: #1c1917; box-shadow: 0 4px 16px rgba(0,0,0,0.2); }
    body.dark .list-item.keyboard-focused { background: #1c1917; }
    .list-thumb {
      width: 48px;
      height: 48px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      flex-shrink: 0;
      position: relative;
      overflow: hidden;
      background: linear-gradient(135deg, #fafaf9 0%, #f5f5f4 100%);
    }
    body.dark .list-thumb { background: linear-gradient(135deg, #292524 0%, #1c1917 100%); }
    .list-thumb img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s ease; }
    .list-item:hover .list-thumb img { transform: scale(1.08); }
    .list-info { flex: 1; min-width: 0; }
    .list-title { font-size: 14px; font-weight: 600; color: #1c1917; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; letter-spacing: -0.01em; }
    body.dark .list-title { color: #f5f5f4; }
    .list-path { font-size: 12px; color: #a8a29e; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 2px; }
    .list-meta { text-align: right; flex-shrink: 0; }
    .list-size { font-size: 13px; color: #57534e; font-weight: 500; }
    body.dark .list-size { color: #a8a29e; }
    .list-type { font-size: 11px; color: #a8a29e; margin-top: 2px; }

    /* Detail panel */
    .detail {
      width: 360px;
      background: white;
      border-left: 1px solid rgba(0,0,0,0.05);
      flex-shrink: 0;
      display: none;
      flex-direction: column;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: -4px 0 24px rgba(0,0,0,0.03);
    }
    .detail.open { display: flex; animation: slideInRight 0.3s ease; }
    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(20px); }
      to { opacity: 1; transform: translateX(0); }
    }
    body.dark .detail { background: #1a1918; border-color: rgba(255,255,255,0.05); box-shadow: -4px 0 24px rgba(0,0,0,0.15); }
    .detail-header { padding: 18px 20px; border-bottom: 1px solid rgba(0,0,0,0.04); display: flex; justify-content: space-between; align-items: center; }
    body.dark .detail-header { border-color: rgba(255,255,255,0.04); }
    .detail-header h2 { font-size: 15px; font-weight: 700; color: #1c1917; letter-spacing: -0.02em; }
    body.dark .detail-header h2 { color: #f5f5f4; }
    .close-btn {
      background: none;
      border: none;
      color: #a8a29e;
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .close-btn:hover { color: #57534e; background: rgba(0,0,0,0.04); transform: rotate(90deg); }
    body.dark .close-btn:hover { background: rgba(255,255,255,0.06); color: #d6d3d1; }
    .detail-preview {
      height: 220px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 52px;
      position: relative;
      overflow: hidden;
      background: linear-gradient(135deg, #fafaf9 0%, #f5f5f4 100%);
    }
    body.dark .detail-preview { background: linear-gradient(135deg, #292524 0%, #1c1917 100%); }
    .detail-preview img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; }
    .detail-preview video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; background: #000; }
    .detail-content { flex: 1; padding: 20px; overflow-y: auto; }
    .detail-title { font-size: 17px; font-weight: 700; color: #1c1917; word-break: break-word; letter-spacing: -0.02em; line-height: 1.3; }
    body.dark .detail-title { color: #fafaf9; }
    .detail-path { font-size: 11px; color: #a8a29e; margin-top: 6px; word-break: break-all; font-family: 'SF Mono', Monaco, monospace; padding: 8px 10px; background: rgba(0,0,0,0.02); border-radius: 8px; }
    body.dark .detail-path { background: rgba(255,255,255,0.04); }
    .detail-actions { display: flex; gap: var(--space-sm); margin-top: 18px; align-items: center; }
    .action-btn {
      flex: 1;
      height: var(--btn-height-lg);
      padding: 0 var(--space-lg);
      border-radius: var(--radius-md);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-sm);
    }
    .action-btn.primary { background: #1c1917; color: white; }
    .action-btn.primary:hover { background: #292524; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .action-btn.primary:active { transform: translateY(0) scale(0.98); }
    body.dark .action-btn.primary { background: #fafaf9; color: #1c1917; }
    .action-btn.secondary { background: rgba(0,0,0,0.04); color: #44403c; }
    .action-btn.secondary:hover { background: rgba(0,0,0,0.08); transform: translateY(-1px); }
    .action-btn.secondary:active { transform: translateY(0) scale(0.98); }
    body.dark .action-btn.secondary { background: rgba(255,255,255,0.06); color: #d6d3d1; }
    body.dark .action-btn.secondary:hover { background: rgba(255,255,255,0.1); }
    .action-btn.star { width: var(--btn-height-lg); height: var(--btn-height-lg); flex: none; font-size: 18px; padding: 0; }
    .action-btn.star.active { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); color: #f59e0b; }

    .detail-section { margin-top: 20px; }
    .detail-section-title { font-size: 11px; color: #a8a29e; text-transform: uppercase; margin-bottom: 8px; letter-spacing: 0.5px; }
    .detail-tags { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px; }
    .detail-tag { padding: 4px 10px; background: #f5f5f4; border-radius: 6px; font-size: 12px; color: #57534e; cursor: pointer; transition: all 0.15s; }
    .detail-tag:hover { background: #e7e5e4; }
    body.dark .detail-tag { background: #44403c; color: #d6d3d1; }
    .tag-input-container { display: flex; gap: var(--space-sm); align-items: center; }
    .tag-input { flex: 1; padding: 8px 10px; border: 1px solid #e7e5e4; border-radius: 6px; font-size: 12px; outline: none; }
    .tag-input:focus { border-color: #a8a29e; }
    body.dark .tag-input { background: #1c1917; border-color: #44403c; color: #fafaf9; }
    .tag-add-btn { padding: 8px 12px; background: #292524; color: white; border: none; border-radius: 6px; font-size: 12px; cursor: pointer; }
    body.dark .tag-add-btn { background: #fafaf9; color: #292524; }

    .info-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #fafaf9; font-size: 13px; }
    body.dark .info-row { border-color: #44403c; }
    .info-label { color: #a8a29e; }
    .info-value { color: #57534e; text-align: right; max-width: 60%; overflow: hidden; text-overflow: ellipsis; }
    body.dark .info-value { color: #d6d3d1; }

    /* Toast - Enhanced */
    .toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
    .toast {
      padding: 14px 20px;
      background: #1c1917;
      color: white;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 500;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2), 0 0 0 1px rgba(255,255,255,0.05);
      animation: toastSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      pointer-events: auto;
      display: flex;
      align-items: center;
      gap: 10px;
      backdrop-filter: blur(8px);
    }
    .toast::before { content: ''; width: 8px; height: 8px; border-radius: 50%; background: currentColor; flex-shrink: 0; }
    .toast.success { background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); }
    .toast.success::before { background: #86efac; }
    .toast.error { background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); }
    .toast.error::before { background: #fca5a5; }
    .toast.info { background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); }
    .toast.info::before { background: #93c5fd; }
    @keyframes toastSlideIn {
      from { opacity: 0; transform: translateY(16px) scale(0.95); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    .toast.hiding {
      animation: toastSlideOut 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }
    @keyframes toastSlideOut {
      from { opacity: 1; transform: translateY(0) scale(1); }
      to { opacity: 0; transform: translateY(-8px) scale(0.95); }
    }

    /* Bulk Selection */
    .card.selected, .list-item.selected { outline: 2px solid #3b82f6; outline-offset: -2px; }
    body.dark .card.selected, body.dark .list-item.selected { outline-color: #60a5fa; }
    .card-checkbox, .list-checkbox { position: absolute; top: 8px; left: 8px; width: 20px; height: 20px; border-radius: 4px; background: rgba(255,255,255,0.9); border: 2px solid #d6d3d1; cursor: pointer; display: flex; align-items: center; justify-content: center; opacity: 0; transition: all 0.15s; z-index: 5; }
    .card:hover .card-checkbox, .list-item:hover .list-checkbox, .card-checkbox.visible, .list-checkbox.visible { opacity: 1; }
    .card-checkbox.checked, .list-checkbox.checked { background: #3b82f6; border-color: #3b82f6; opacity: 1; }
    .card-checkbox.checked .icon, .list-checkbox.checked .icon { color: white; }
    .list-checkbox { position: relative; top: auto; left: auto; flex-shrink: 0; }

    /* Bulk Action Bar */
    .bulk-bar { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); background: #292524; border-radius: 12px; padding: 12px 20px; display: none; align-items: center; gap: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 900; animation: bulkSlideUp 0.2s ease; }
    .bulk-bar.open { display: flex; }
    body.dark .bulk-bar { background: #fafaf9; }
    @keyframes bulkSlideUp { from { opacity: 0; transform: translateX(-50%) translateY(20px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
    .bulk-count { color: white; font-size: 14px; font-weight: 500; white-space: nowrap; }
    body.dark .bulk-count { color: #292524; }
    .bulk-divider { width: 1px; height: 24px; background: #57534e; }
    body.dark .bulk-divider { background: #d6d3d1; }
    .bulk-btn { padding: 8px 14px; background: #44403c; border: none; border-radius: 8px; color: white; font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.15s; }
    .bulk-btn:hover { background: #57534e; }
    body.dark .bulk-btn { background: #e7e5e4; color: #292524; }
    body.dark .bulk-btn:hover { background: #d6d3d1; }
    .bulk-btn.danger { background: #dc2626; }
    .bulk-btn.danger:hover { background: #b91c1c; }
    body.dark .bulk-btn.danger { background: #dc2626; color: white; }
    .bulk-close { padding: 6px; background: transparent; border: none; color: #a8a29e; cursor: pointer; border-radius: 6px; display: flex; align-items: center; justify-content: center; }
    .bulk-close:hover { background: #44403c; color: white; }
    body.dark .bulk-close:hover { background: #e7e5e4; color: #292524; }

    /* Bulk Tag Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      z-index: 1001;
      display: none;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(8px);
    }
    .modal-overlay.open { display: flex; animation: fadeIn 0.2s ease; }
    .modal {
      background: white;
      border-radius: 20px;
      padding: 28px;
      width: 380px;
      max-width: 90vw;
      animation: modalSlide 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 24px 64px rgba(0,0,0,0.2);
    }
    body.dark .modal { background: #1c1917; }
    @keyframes modalSlide {
      from { opacity: 0; transform: translateY(-20px) scale(0.95); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    .modal-title { font-size: 18px; font-weight: 700; color: #1c1917; margin-bottom: 20px; letter-spacing: -0.02em; }
    body.dark .modal-title { color: #fafaf9; }
    .modal-input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid rgba(0,0,0,0.08);
      border-radius: 12px;
      font-size: 14px;
      outline: none;
      margin-bottom: 20px;
      transition: all 0.2s ease;
    }
    .modal-input:focus { border-color: #6366f1; box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1); }
    body.dark .modal-input { background: #0f0e0d; border-color: rgba(255,255,255,0.08); color: #fafaf9; }
    body.dark .modal-input:focus { border-color: #6366f1; }
    .modal-actions { display: flex; gap: var(--space-sm); justify-content: flex-end; align-items: center; }
    .modal-btn {
      padding: 12px 20px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .modal-btn.primary { background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white; }
    .modal-btn.primary:hover { transform: translateY(-2px); box-shadow: 0 4px 16px rgba(99, 102, 241, 0.35); }
    .modal-btn.primary:active { transform: translateY(0) scale(0.98); }
    .modal-btn.secondary { background: rgba(0,0,0,0.04); color: #44403c; }
    .modal-btn.secondary:hover { background: rgba(0,0,0,0.08); }
    body.dark .modal-btn.secondary { background: rgba(255,255,255,0.06); color: #d6d3d1; }

    /* Empty state */
    .empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #a8a29e;
      text-align: center;
      animation: fadeIn 0.4s ease;
      padding: 40px 20px;
    }
    .empty-mascot {
      font-size: 64px;
      margin-bottom: 16px;
      filter: grayscale(0.3);
      animation: gentleBounce 2s ease-in-out infinite;
    }
    @keyframes gentleBounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-8px); }
    }
    .empty-icon { font-size: 56px; margin-bottom: 20px; opacity: 0.6; }
    .empty-title { font-size: 18px; font-weight: 600; color: #57534e; margin-bottom: 6px; letter-spacing: -0.01em; }
    body.dark .empty-title { color: #d6d3d1; }
    .empty-text { font-size: 14px; max-width: 280px; line-height: 1.5; }

    /* AI Features */
    .ai-section { margin-top: 16px; padding-top: 16px; border-top: 1px solid #e7e5e4; }
    body.dark .ai-section { border-color: #44403c; }
    .ai-btn { width: 100%; padding: 10px 14px; background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); border: none; border-radius: 8px; color: white; font-size: 13px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.15s; }
    .ai-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(99,102,241,0.3); }
    .ai-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: none; }
    .ai-btn.loading { pointer-events: none; }
    .ai-btn.loading::after { content: ''; width: 14px; height: 14px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .ai-summary { margin-top: 12px; padding: 12px; background: #faf5ff; border-radius: 8px; font-size: 13px; line-height: 1.5; color: #57534e; }
    body.dark .ai-summary { background: #2e1065; color: #e9d5ff; }
    .ai-summary-label { font-size: 11px; color: #8b5cf6; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
    .ai-topics { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 8px; }
    .ai-topic { padding: 3px 8px; background: #ede9fe; border-radius: 4px; font-size: 11px; color: #6366f1; }
    body.dark .ai-topic { background: #4c1d95; color: #c4b5fd; }

    /* AI Actions Grid */
    .ai-actions-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px; }
    .ai-action-btn {
      padding: 10px 8px;
      background: #f5f5f4;
      border: 1px solid #e7e5e4;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      transition: all 0.15s;
      text-align: center;
    }
    .ai-action-btn:hover { background: #e7e5e4; border-color: #d6d3d1; }
    .ai-action-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .ai-action-btn.loading .icon { animation: spin 0.8s linear infinite; }
    body.dark .ai-action-btn { background: #1c1917; border-color: #44403c; }
    body.dark .ai-action-btn:hover { background: #292524; border-color: #57534e; }
    .ai-action-btn .icon { color: #6366f1; width: 18px; height: 18px; }
    .ai-action-btn span:not(.icon) { font-size: 11px; color: #57534e; }
    body.dark .ai-action-btn span:not(.icon) { color: #a8a29e; }

    /* AI Results Panel */
    .ai-results-panel {
      margin-top: 12px;
      padding: 12px;
      background: #fafaf9;
      border-radius: 8px;
      border: 1px solid #e7e5e4;
    }
    body.dark .ai-results-panel { background: #1c1917; border-color: #44403c; }
    .ai-results-title {
      font-size: 11px;
      color: #8b5cf6;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .ai-results-title .icon { width: 14px; height: 14px; }
    .ai-tag-suggestions {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .ai-tag-suggestion {
      padding: 4px 10px;
      background: #ede9fe;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      color: #6366f1;
      cursor: pointer;
      transition: all 0.15s;
    }
    .ai-tag-suggestion:hover { background: #ddd6fe; }
    body.dark .ai-tag-suggestion { background: #4c1d95; color: #c4b5fd; }
    body.dark .ai-tag-suggestion:hover { background: #5b21b6; }
    .ai-similar-files {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .ai-similar-file {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      background: white;
      border: 1px solid #e7e5e4;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.15s;
    }
    .ai-similar-file:hover { background: #f5f5f4; }
    body.dark .ai-similar-file { background: #292524; border-color: #44403c; }
    body.dark .ai-similar-file:hover { background: #44403c; }
    .ai-similar-file .icon { width: 20px; height: 20px; color: #78716c; flex-shrink: 0; }
    .ai-similar-file-info { flex: 1; min-width: 0; }
    .ai-similar-file-name { font-size: 12px; color: #44403c; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    body.dark .ai-similar-file-name { color: #e7e5e4; }
    .ai-similar-file-reasons { font-size: 10px; color: #a8a29e; }
    .ai-rename-suggestions {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .ai-rename-suggestion {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 8px 10px;
      background: white;
      border: 1px solid #e7e5e4;
      border-radius: 6px;
      font-size: 12px;
      color: #44403c;
    }
    body.dark .ai-rename-suggestion { background: #292524; border-color: #44403c; color: #e7e5e4; }
    .ai-rename-suggestion button {
      padding: 4px 8px;
      background: #6366f1;
      border: none;
      border-radius: 4px;
      color: white;
      font-size: 10px;
      cursor: pointer;
      flex-shrink: 0;
    }
    .ai-rename-suggestion button:hover { background: #4f46e5; }

    /* Search Mode Toggle */
    .search-mode { display: flex; gap: 2px; background: #f5f5f4; padding: 3px; border-radius: 8px; margin-left: 8px; }
    body.dark .search-mode { background: #44403c; }
    .search-mode-btn { padding: 5px 10px; border: none; background: transparent; border-radius: 6px; font-size: 12px; color: #78716c; cursor: pointer; transition: all 0.15s; display: flex; align-items: center; gap: 4px; }
    .search-mode-btn:hover { color: #57534e; }
    .search-mode-btn.active { background: white; color: #292524; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    body.dark .search-mode-btn { color: #a8a29e; }
    body.dark .search-mode-btn:hover { color: #d6d3d1; }
    body.dark .search-mode-btn.active { background: #57534e; color: #fafaf9; }

    /* Settings Modal */
    .settings-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1001; display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
    .settings-overlay.open { display: flex; }
    .settings-modal { width: 480px; max-width: 90vw; background: white; border-radius: 16px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); overflow: hidden; animation: cmdSlide 0.15s ease-out; }
    body.dark .settings-modal { background: #292524; }
    .settings-header { padding: 20px 24px; border-bottom: 1px solid #e7e5e4; display: flex; align-items: center; justify-content: space-between; }
    body.dark .settings-header { border-color: #44403c; }
    .settings-header h2 { font-size: 18px; color: #292524; display: flex; align-items: center; gap: 10px; }
    body.dark .settings-header h2 { color: #fafaf9; }
    .settings-body { padding: 24px; }
    .settings-section { margin-bottom: 24px; }
    .settings-section:last-child { margin-bottom: 0; }
    .settings-label { display: block; font-size: 14px; font-weight: 500; color: #292524; margin-bottom: 8px; }
    body.dark .settings-label { color: #fafaf9; }
    .settings-desc { font-size: 12px; color: #78716c; margin-bottom: 10px; }
    body.dark .settings-desc { color: #a8a29e; }
    .settings-input { width: 100%; padding: 10px 14px; border: 1px solid #e7e5e4; border-radius: 8px; font-size: 14px; color: #292524; background: #fafaf9; transition: all 0.15s; }
    .settings-input:focus { outline: none; border-color: #8b5cf6; box-shadow: 0 0 0 3px rgba(139,92,246,0.1); }
    body.dark .settings-input { background: #1c1917; border-color: #44403c; color: #fafaf9; }
    .settings-footer { padding: 16px 24px; background: #fafaf9; border-top: 1px solid #e7e5e4; display: flex; justify-content: flex-end; gap: 8px; }
    body.dark .settings-footer { background: #1c1917; border-color: #44403c; }

    /* Symbol Search Results */
    .symbol-results { padding: 8px 16px; background: #fefce8; border-bottom: 1px solid #fef08a; max-height: 200px; overflow-y: auto; }
    body.dark .symbol-results { background: #422006; border-color: #854d0e; }
    .symbol-item { padding: 8px 12px; margin-bottom: 4px; background: white; border-radius: 6px; cursor: pointer; transition: all 0.15s; }
    .symbol-item:hover { background: #fef9c3; }
    body.dark .symbol-item { background: #292524; }
    body.dark .symbol-item:hover { background: #44403c; }
    .symbol-name { font-weight: 500; color: #292524; font-family: 'SF Mono', Monaco, monospace; font-size: 13px; }
    body.dark .symbol-name { color: #fafaf9; }
    .symbol-type { font-size: 11px; padding: 2px 6px; border-radius: 4px; margin-left: 8px; }
    .symbol-type.function { background: #dbeafe; color: #1e40af; }
    .symbol-type.export { background: #dcfce7; color: #166534; }
    .symbol-type.import { background: #fce7f3; color: #9d174d; }
    body.dark .symbol-type.function { background: #1e3a5f; color: #93c5fd; }
    body.dark .symbol-type.export { background: #14532d; color: #86efac; }
    body.dark .symbol-type.import { background: #500724; color: #f9a8d4; }
    .symbol-file { font-size: 11px; color: #78716c; margin-top: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    body.dark .symbol-file { color: #a8a29e; }

    /* Scrollbar - Refined */
    ::-webkit-scrollbar { width: 10px; height: 10px; }
    ::-webkit-scrollbar-track { background: transparent; margin: 4px; }
    ::-webkit-scrollbar-thumb {
      background: rgba(0,0,0,0.15);
      border-radius: 10px;
      border: 3px solid transparent;
      background-clip: padding-box;
    }
    ::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.25); background-clip: padding-box; }
    body.dark ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); background-clip: padding-box; }
    body.dark ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.25); background-clip: padding-box; }
    ::-webkit-scrollbar-corner { background: transparent; }

    /* Command Palette */
    .cmd-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: none; align-items: flex-start; justify-content: center; padding-top: 15vh; backdrop-filter: blur(2px); }
    .cmd-overlay.open { display: flex; }
    .cmd-palette { width: 560px; max-width: 90vw; background: white; border-radius: 12px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); overflow: hidden; animation: cmdSlide 0.15s ease-out; }
    body.dark .cmd-palette { background: #292524; }
    @keyframes cmdSlide { from { opacity: 0; transform: translateY(-10px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
    .cmd-header { display: flex; align-items: center; gap: 12px; padding: 16px; border-bottom: 1px solid #e7e5e4; }
    body.dark .cmd-header { border-color: #44403c; }
    .cmd-header .icon { color: #a8a29e; flex-shrink: 0; }
    .cmd-input { flex: 1; border: none; background: transparent; font-size: 16px; outline: none; color: #292524; }
    .cmd-input::placeholder { color: #a8a29e; }
    body.dark .cmd-input { color: #fafaf9; }
    .cmd-hint { font-size: 11px; color: #a8a29e; padding: 0 4px; background: #f5f5f4; border-radius: 4px; }
    body.dark .cmd-hint { background: #44403c; }
    .cmd-body { max-height: 400px; overflow-y: auto; }
    .cmd-section { padding: 8px; }
    .cmd-section-title { font-size: 11px; color: #a8a29e; text-transform: uppercase; letter-spacing: 0.5px; padding: 8px 12px 4px; }
    .cmd-item { display: flex; align-items: center; gap: 12px; padding: 10px 12px; border-radius: 8px; cursor: pointer; transition: all 0.1s; }
    .cmd-item:hover, .cmd-item.selected { background: #f5f5f4; }
    body.dark .cmd-item:hover, body.dark .cmd-item.selected { background: #44403c; }
    .cmd-item .icon { color: #78716c; flex-shrink: 0; }
    body.dark .cmd-item .icon { color: #a8a29e; }
    .cmd-item-content { flex: 1; min-width: 0; }
    .cmd-item-title { font-size: 14px; color: #292524; font-weight: 500; }
    body.dark .cmd-item-title { color: #fafaf9; }
    .cmd-item-desc { font-size: 12px; color: #a8a29e; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .cmd-item-shortcut { display: flex; gap: 4px; }
    .cmd-key { font-size: 11px; padding: 2px 6px; background: #e7e5e4; border-radius: 4px; color: #57534e; font-family: inherit; }
    body.dark .cmd-key { background: #57534e; color: #d6d3d1; }
    .cmd-footer { padding: 10px 16px; border-top: 1px solid #e7e5e4; display: flex; gap: 16px; font-size: 11px; color: #a8a29e; }
    body.dark .cmd-footer { border-color: #44403c; }
    .cmd-footer span { display: flex; align-items: center; gap: 4px; }
    .cmd-empty { padding: 32px; text-align: center; color: #a8a29e; }
    .cmd-empty .icon { margin-bottom: 8px; }

    /* ===== UX ENHANCEMENTS ===== */

    /* Skeleton Loading Cards */
    .skeleton-card {
      background: white;
      border-radius: 16px;
      border: 1px solid rgba(0,0,0,0.04);
      overflow: hidden;
    }
    body.dark .skeleton-card { background: #1c1917; border-color: rgba(255,255,255,0.04); }
    .skeleton-card .skeleton-preview {
      aspect-ratio: 1;
      background: linear-gradient(90deg, #f5f5f4 25%, #fafaf9 50%, #f5f5f4 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s ease-in-out infinite;
    }
    body.dark .skeleton-card .skeleton-preview {
      background: linear-gradient(90deg, #292524 25%, #3f3f46 50%, #292524 75%);
      background-size: 200% 100%;
    }
    .skeleton-card .skeleton-info { padding: 14px 16px; }
    .skeleton-card .skeleton-title {
      height: 14px;
      background: linear-gradient(90deg, #e7e5e4 25%, #f5f5f4 50%, #e7e5e4 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s ease-in-out infinite;
      border-radius: 4px;
      width: 70%;
    }
    body.dark .skeleton-card .skeleton-title {
      background: linear-gradient(90deg, #44403c 25%, #57534e 50%, #44403c 75%);
      background-size: 200% 100%;
    }
    .skeleton-card .skeleton-size {
      height: 10px;
      margin-top: 8px;
      background: linear-gradient(90deg, #e7e5e4 25%, #f5f5f4 50%, #e7e5e4 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s ease-in-out infinite;
      animation-delay: 0.1s;
      border-radius: 4px;
      width: 40%;
    }
    body.dark .skeleton-card .skeleton-size {
      background: linear-gradient(90deg, #44403c 25%, #57534e 50%, #44403c 75%);
      background-size: 200% 100%;
    }

    /* Skeleton List Item */
    .skeleton-list-item {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 12px 14px;
    }
    .skeleton-list-item .skeleton-thumb {
      width: 48px;
      height: 48px;
      border-radius: 10px;
      background: linear-gradient(90deg, #e7e5e4 25%, #f5f5f4 50%, #e7e5e4 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s ease-in-out infinite;
      flex-shrink: 0;
    }
    body.dark .skeleton-list-item .skeleton-thumb {
      background: linear-gradient(90deg, #292524 25%, #3f3f46 50%, #292524 75%);
      background-size: 200% 100%;
    }
    .skeleton-list-item .skeleton-info { flex: 1; }
    .skeleton-list-item .skeleton-title-line {
      height: 14px;
      background: linear-gradient(90deg, #e7e5e4 25%, #f5f5f4 50%, #e7e5e4 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s ease-in-out infinite;
      border-radius: 4px;
      width: 60%;
    }
    .skeleton-list-item .skeleton-path-line {
      height: 10px;
      margin-top: 6px;
      background: linear-gradient(90deg, #e7e5e4 25%, #f5f5f4 50%, #e7e5e4 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s ease-in-out infinite;
      animation-delay: 0.1s;
      border-radius: 4px;
      width: 80%;
    }
    body.dark .skeleton-list-item .skeleton-title-line,
    body.dark .skeleton-list-item .skeleton-path-line {
      background: linear-gradient(90deg, #44403c 25%, #57534e 50%, #44403c 75%);
      background-size: 200% 100%;
    }

    /* Staggered Card Animations */
    .card, .list-item { animation: cardFadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1) both; }
    .card:nth-child(1), .list-item:nth-child(1) { animation-delay: 0ms; }
    .card:nth-child(2), .list-item:nth-child(2) { animation-delay: 25ms; }
    .card:nth-child(3), .list-item:nth-child(3) { animation-delay: 50ms; }
    .card:nth-child(4), .list-item:nth-child(4) { animation-delay: 75ms; }
    .card:nth-child(5), .list-item:nth-child(5) { animation-delay: 100ms; }
    .card:nth-child(6), .list-item:nth-child(6) { animation-delay: 125ms; }
    .card:nth-child(7), .list-item:nth-child(7) { animation-delay: 150ms; }
    .card:nth-child(8), .list-item:nth-child(8) { animation-delay: 175ms; }
    .card:nth-child(9), .list-item:nth-child(9) { animation-delay: 200ms; }
    .card:nth-child(10), .list-item:nth-child(10) { animation-delay: 225ms; }
    .card:nth-child(n+11), .list-item:nth-child(n+11) { animation-delay: 250ms; }

    @keyframes cardFadeIn {
      from { opacity: 0; transform: translateY(12px) scale(0.97); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    /* Enhanced Card Hover */
    .card {
      will-change: transform, box-shadow;
      backface-visibility: hidden;
    }
    .card:hover .card-preview img {
      transform: scale(1.08);
      filter: brightness(1.02);
    }

    /* Smooth thumbnail loading - only hide pending thumbnails */
    .card-preview img, .list-thumb img, .detail-preview img {
      transition: opacity 0.3s ease, transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .card-preview img.thumb-pending, .list-thumb img.thumb-pending {
      opacity: 0;
    }
    .card-preview img.loaded, .list-thumb img.loaded {
      opacity: 1;
    }

    /* Loading Overlay */
    .loading-overlay {
      position: absolute;
      inset: 0;
      background: rgba(248, 248, 247, 0.85);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      animation: fadeIn 0.2s ease;
    }
    body.dark .loading-overlay { background: rgba(15, 14, 13, 0.85); }
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(0,0,0,0.1);
      border-top-color: #6366f1;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    body.dark .loading-spinner { border-color: rgba(255,255,255,0.1); border-top-color: #818cf8; }

    /* Enhanced Empty State */
    .empty {
      padding: 60px 20px;
    }
    .empty-icon {
      width: 100px;
      height: 100px;
      margin: 0 auto 24px;
      border-radius: 24px;
      background: linear-gradient(135deg, #f5f5f4 0%, #e7e5e4 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      animation: emptyBounce 2s ease-in-out infinite;
    }
    body.dark .empty-icon { background: linear-gradient(135deg, #292524 0%, #1c1917 100%); }
    @keyframes emptyBounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-8px); }
    }
    .empty-title {
      font-size: 20px;
      margin-bottom: 8px;
    }
    .empty-text {
      max-width: 320px;
    }
    .empty-action {
      margin-top: 20px;
    }
    .empty-action-btn {
      padding: 12px 24px;
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .empty-action-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(99, 102, 241, 0.3); }
    .empty-action-btn:active { transform: translateY(0) scale(0.98); }

    /* Progress bar for indexing */
    .indexing-progress {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: rgba(99, 102, 241, 0.2);
      z-index: 2000;
      overflow: hidden;
    }
    .indexing-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #6366f1, #8b5cf6, #6366f1);
      background-size: 200% 100%;
      animation: progressShimmer 1.5s ease-in-out infinite;
      transition: width 0.3s ease;
    }
    @keyframes progressShimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    /* Smooth filter transitions */
    .filter-btn {
      position: relative;
      overflow: hidden;
    }
    .filter-btn::after {
      content: '';
      position: absolute;
      inset: 0;
      background: currentColor;
      opacity: 0;
      transition: opacity 0.15s ease;
    }
    .filter-btn:active::after { opacity: 0.1; }

    /* Better focus states */
    .card:focus-visible, .list-item:focus-visible {
      outline: 2px solid #6366f1;
      outline-offset: 2px;
    }
    .filter-btn:focus-visible, .view-btn:focus-visible, .action-btn:focus-visible {
      outline: 2px solid #6366f1;
      outline-offset: 2px;
    }

    /* Ripple effect for buttons */
    .ripple {
      position: relative;
      overflow: hidden;
    }
    .ripple::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255,255,255,0.3);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.4s ease, height 0.4s ease, opacity 0.4s ease;
      opacity: 0;
    }
    .ripple:active::before {
      width: 200%;
      height: 200%;
      opacity: 1;
      transition: width 0s, height 0s, opacity 0s;
    }

    /* ===== END UX ENHANCEMENTS ===== */

    /* ===== GRAPH VISUALIZATION ===== */
    #graphContainer {
      width: 100%;
      height: 100%;
      position: relative;
      background: #fafaf9;
      border-radius: 8px;
      overflow: hidden;
    }
    body.dark #graphContainer {
      background: #1c1917;
    }

    #graphSvg {
      width: 100%;
      height: 100%;
      cursor: grab;
    }
    #graphSvg:active {
      cursor: grabbing;
    }

    /* Graph nodes */
    .graph-node {
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .graph-node:hover {
      filter: brightness(1.1);
    }
    .graph-node.center {
      filter: drop-shadow(0 0 8px rgba(139, 92, 246, 0.5));
    }

    .node-circle {
      stroke: #fff;
      stroke-width: 2px;
    }
    body.dark .node-circle {
      stroke: #1c1917;
    }

    .node-label {
      font-size: 11px;
      font-weight: 500;
      fill: #292524;
      text-anchor: middle;
      pointer-events: none;
      user-select: none;
    }
    body.dark .node-label {
      fill: #e7e5e4;
    }

    /* Graph edges */
    .graph-edge {
      stroke: #d6d3d1;
      stroke-width: 1.5px;
      fill: none;
      opacity: 0.6;
    }
    body.dark .graph-edge {
      stroke: #57534e;
    }
    .graph-edge.similar {
      stroke: #8b5cf6;
      stroke-dasharray: 4 2;
    }
    .graph-edge.imports {
      stroke: #3b82f6;
      marker-end: url(#arrowhead);
    }
    .graph-edge.same_folder {
      stroke: #10b981;
      stroke-dasharray: 2 2;
    }

    .edge-label {
      font-size: 9px;
      fill: #78716c;
      text-anchor: middle;
      pointer-events: none;
      user-select: none;
    }
    body.dark .edge-label {
      fill: #a8a29e;
    }

    /* Graph toolbar */
    .graph-toolbar {
      position: absolute;
      top: 16px;
      right: 16px;
      display: flex;
      gap: 8px;
      z-index: 10;
    }

    .graph-toolbar-btn {
      padding: 8px 12px;
      background: #fff;
      border: 1px solid #e7e5e4;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s ease;
    }
    .graph-toolbar-btn:hover {
      background: #fafaf9;
      border-color: #d6d3d1;
    }
    .graph-toolbar-btn.active {
      background: #8b5cf6;
      color: #fff;
      border-color: #8b5cf6;
    }
    body.dark .graph-toolbar-btn {
      background: #292524;
      border-color: #44403c;
      color: #e7e5e4;
    }
    body.dark .graph-toolbar-btn:hover {
      background: #3c3836;
    }
    body.dark .graph-toolbar-btn.active {
      background: #8b5cf6;
      border-color: #8b5cf6;
    }

    /* Graph legend */
    .graph-legend {
      position: absolute;
      bottom: 16px;
      left: 16px;
      background: #fff;
      border: 1px solid #e7e5e4;
      border-radius: 8px;
      padding: 12px;
      font-size: 11px;
      z-index: 10;
    }
    body.dark .graph-legend {
      background: #292524;
      border-color: #44403c;
      color: #e7e5e4;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }
    .legend-item:last-child {
      margin-bottom: 0;
    }

    .legend-color {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 1px solid #e7e5e4;
    }
    body.dark .legend-color {
      border-color: #44403c;
    }

    .legend-line {
      width: 20px;
      height: 2px;
      border-radius: 1px;
    }

    /* Graph controls */
    .graph-controls {
      position: absolute;
      top: 16px;
      left: 16px;
      background: #fff;
      border: 1px solid #e7e5e4;
      border-radius: 8px;
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      z-index: 10;
    }
    body.dark .graph-controls {
      background: #292524;
      border-color: #44403c;
    }

    .graph-control-btn {
      width: 32px;
      height: 32px;
      background: transparent;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s ease;
      color: #57534e;
    }
    .graph-control-btn:hover {
      background: #fafaf9;
    }
    body.dark .graph-control-btn {
      color: #a8a29e;
    }
    body.dark .graph-control-btn:hover {
      background: #3c3836;
    }

    /* Graph info panel */
    .graph-info {
      position: absolute;
      bottom: 16px;
      right: 16px;
      background: #fff;
      border: 1px solid #e7e5e4;
      border-radius: 8px;
      padding: 12px 16px;
      font-size: 12px;
      z-index: 10;
      min-width: 200px;
      max-width: 300px;
      display: none;
    }
    .graph-info.visible {
      display: block;
      animation: fadeInUp 0.2s ease;
    }
    body.dark .graph-info {
      background: #292524;
      border-color: #44403c;
      color: #e7e5e4;
    }

    .graph-info-title {
      font-weight: 600;
      margin-bottom: 8px;
      color: #292524;
    }
    body.dark .graph-info-title {
      color: #e7e5e4;
    }

    .graph-info-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
      font-size: 11px;
    }

    .graph-info-label {
      color: #78716c;
    }
    body.dark .graph-info-label {
      color: #a8a29e;
    }

    /* Empty graph state */
    .graph-empty {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #a8a29e;
    }

    .graph-empty-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.3;
    }

    .graph-empty-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #57534e;
    }
    body.dark .graph-empty-title {
      color: #a8a29e;
    }

    .graph-empty-text {
      font-size: 13px;
      text-align: center;
      max-width: 400px;
    }
    /* ===== END GRAPH VISUALIZATION ===== */
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="sidebar-header">
        <h1 style="display:flex;align-items:center;gap:8px;"><span class="icon icon-lg" id="logoIcon"></span> Hippo</h1>
        <p>Never forgets</p>
      </div>
      <div class="sidebar-content">
        <p class="section-title">Sources</p>
        <div id="sourcesList"></div>
        <button class="add-btn" id="addBtn">+ Add Folder</button>
        <div style="margin-top:16px;" id="collectionsSection"></div>
        <button class="sidebar-btn" id="discoverBtn" style="margin-top:8px;"><span class="icon icon-sm" style="color:#8b5cf6;">&#10024;</span> Discover Collections</button>
      </div>
      <div class="sidebar-footer">
        <p id="statsText" style="margin-bottom:4px;">Loading...</p>
        <div class="status-row">
          <div class="status-indicator" title="Qdrant vector search">
            <span class="status-dot loading" id="qdrantDot"></span>
            <span id="qdrantStatus">Qdrant</span>
          </div>
          <div class="status-indicator" title="Ollama local AI">
            <span class="status-dot loading" id="ollamaDot"></span>
            <span id="ollamaStatusText">Ollama</span>
          </div>
        </div>
        <button class="sidebar-btn ai-chat-btn" id="chatBtn"><span class="icon icon-sm" id="chatBtnIcon"></span> Ask Hippo</button>
        <div class="sidebar-actions">
          <button class="sidebar-icon-btn" id="settingsBtn" title="AI Settings"><span class="icon" id="settingsIcon"></span></button>
          <button class="sidebar-icon-btn" id="exportBtn" title="Export Index"><span class="icon" id="exportIcon"></span></button>
          <button class="sidebar-icon-btn" id="importBtn" title="Import Index"><span class="icon" id="importIcon"></span></button>
          <button class="sidebar-icon-btn" id="darkModeBtn" title="Toggle Dark Mode"><span class="icon" id="themeIcon"></span></button>
          <button class="sidebar-icon-btn danger" id="resetBtn" title="Reset Index"><span class="icon" id="resetIcon"></span></button>
        </div>
      </div>
    </aside>

    <main class="main">
      <div class="search-bar">
        <div style="display:flex;align-items:center;gap:10px;">
          <div class="search-wrapper" style="flex:1;position:relative;">
            <div class="search-container">
              <span class="icon icon-md" id="searchIcon" style="color:#a8a29e;flex-shrink:0;"></span>
              <div class="active-tags" id="activeTags"></div>
              <input type="text" class="search-input" id="searchInput" placeholder="Search files... (Tab to add tag)">
              <div class="ai-badge" id="nlBadge" style="display:none;"><span class="icon">&#10024;</span> AI</div>
            </div>
            <div class="recent-searches" id="recentSearchesDropdown"></div>
          </div>
          <button class="save-search-btn" id="saveSearchBtn" style="display:none;" title="Save this search">
            <span class="icon icon-sm">&#128190;</span> Save
          </button>
          <div class="search-mode">
            <button class="search-mode-btn active" id="searchModeText" data-mode="text"><span class="icon icon-sm" id="searchModeTextIcon"></span> Text</button>
            <button class="search-mode-btn" id="searchModeSemantic" data-mode="semantic"><span class="icon icon-sm" id="searchModeSemanticIcon"></span> AI</button>
            <button class="search-mode-btn" id="searchModeSymbol" data-mode="symbol"><span class="icon icon-sm" id="searchModeSymbolIcon"></span> Code</button>
          </div>
          <button class="theme-toggle-btn" id="themeToggleBtn" title="Toggle theme"><span class="icon" id="themeToggleIcon"></span></button>
        </div>
        <div class="tag-bar" id="tagBar"></div>
        <div class="nl-interpretation" id="nlInterpretation"></div>
      </div>
      <div class="symbol-results" id="symbolResults" style="display:none;"></div>
      <div class="filter-bar">
        <button class="filter-btn active" data-filter="all">All</button>
        <button class="filter-btn" data-filter="favorites"><span class="icon icon-sm filter-icon" data-icon="star"></span> Favorites</button>
        <button class="filter-btn" data-filter="image"><span class="icon icon-sm filter-icon" data-icon="image"></span> Images</button>
        <button class="filter-btn" data-filter="video"><span class="icon icon-sm filter-icon" data-icon="video"></span> Videos</button>
        <button class="filter-btn" data-filter="audio"><span class="icon icon-sm filter-icon" data-icon="audio"></span> Audio</button>
        <button class="filter-btn" data-filter="code"><span class="icon icon-sm filter-icon" data-icon="code"></span> Code</button>
        <button class="filter-btn" data-filter="document"><span class="icon icon-sm filter-icon" data-icon="doc"></span> Docs</button>
        <div class="filter-spacer"></div>
        <div class="date-filters">
          <button class="date-filter-btn active" data-date="all">All Time</button>
          <button class="date-filter-btn" data-date="today">Today</button>
          <button class="date-filter-btn" data-date="week">This Week</button>
          <button class="date-filter-btn" data-date="month">This Month</button>
        </div>
        <span class="result-count" id="resultCount">0 files</span>
        <button class="filter-btn" id="multiSelectToggle" title="Toggle multi-select mode">
          <span class="icon icon-sm" id="multiSelectIcon"></span> Multi-Select
        </button>
        <div class="view-toggle">
          <button class="view-btn active" id="gridViewBtn" title="Grid view"><span class="icon icon-sm" id="gridIcon"></span></button>
          <button class="view-btn" id="listViewBtn" title="List view"><span class="icon icon-sm" id="listIcon"></span></button>
          <button class="view-btn" id="graphViewBtn" title="Graph view"><span class="icon icon-sm" id="graphIcon"></span></button>
        </div>
      </div>
      <div class="content">
        <div id="filesContainer"></div>
      </div>
    </main>

    <aside class="detail" id="detailPanel">
      <div class="detail-header">
        <h2>Details</h2>
        <button class="close-btn" id="closeDetail"><span class="icon icon-md" id="closeIcon"></span></button>
      </div>
      <div class="detail-preview" id="detailPreview"><span class="icon icon-2xl" id="previewIcon"></span></div>
      <div class="detail-content">
        <h3 class="detail-title" id="detailTitle">-</h3>
        <p class="detail-path" id="detailPath">-</p>
        <div class="detail-actions">
          <button class="action-btn primary" id="openBtn">Open</button>
          <button class="action-btn secondary" id="revealBtn">Reveal</button>
          <button class="action-btn secondary star" id="starBtn"><span class="icon icon-md" id="starIcon"></span></button>
        </div>
        <div class="detail-section">
          <p class="detail-section-title">Tags</p>
          <div class="detail-tags" id="detailTags"></div>
          <div class="tag-input-container">
            <input type="text" class="tag-input" id="tagInput" placeholder="Add tag...">
            <button class="tag-add-btn" id="tagAddBtn">Add</button>
          </div>
        </div>
        <div class="detail-section">
          <p class="detail-section-title">Information</p>
          <div class="info-row"><span class="info-label">Type</span><span class="info-value" id="detailType">-</span></div>
          <div class="info-row"><span class="info-label">Size</span><span class="info-value" id="detailSize">-</span></div>
          <div class="info-row"><span class="info-label">Modified</span><span class="info-value" id="detailDate">-</span></div>
        </div>
        <div class="detail-section" id="captionSection" style="display:none;">
          <p class="detail-section-title">AI Caption</p>
          <button class="action-btn secondary" id="generateCaptionBtn" style="width:100%;margin-bottom:8px;">Generate Caption</button>
          <div id="captionText" style="font-size:13px;color:#57534e;line-height:1.5;"></div>
        </div>
        <div class="ai-section" id="aiSection">
          <button class="ai-btn" id="aiAnalyzeBtn"><span class="icon icon-sm" id="aiIcon"></span> Analyze with AI</button>
          <div id="aiResults" style="display:none;">
            <div class="ai-summary">
              <div class="ai-summary-label">AI Summary</div>
              <div id="aiSummaryText"></div>
              <div class="ai-topics" id="aiTopics"></div>
            </div>
          </div>
          <div class="ai-actions-grid">
            <button class="ai-action-btn" id="aiSuggestTagsBtn" title="Get AI-suggested tags">
              <span class="icon" id="suggestTagsIcon"></span>
              <span>Suggest Tags</span>
            </button>
            <button class="ai-action-btn" id="aiFindSimilarBtn" title="Find similar files">
              <span class="icon" id="findSimilarIcon"></span>
              <span>Find Similar</span>
            </button>
            <button class="ai-action-btn" id="aiSmartRenameBtn" title="Get AI rename suggestions">
              <span class="icon" id="smartRenameIcon"></span>
              <span>Smart Rename</span>
            </button>
            <button class="ai-action-btn" id="aiAskAboutBtn" title="Ask AI about this file">
              <span class="icon" id="askAboutIcon"></span>
              <span>Ask About</span>
            </button>
          </div>
          <div id="aiActionResults" style="display:none;"></div>
        </div>
        <div id="virtualPathsSection"></div>
        <div id="similarSection"></div>
      </div>
    </aside>
  </div>

  <div class="toast-container" id="toastContainer"></div>

  <!-- Drop Zone Overlay -->
  <div class="drop-zone-overlay" id="dropZone">
    <div class="drop-zone-content">
      <div class="icon" id="dropZoneIcon"></div>
      <div>Drop folders here to index</div>
    </div>
  </div>

  <!-- Bulk Action Bar -->
  <div class="bulk-bar" id="bulkBar">
    <span class="bulk-count" id="bulkCount">0 selected</span>
    <div class="bulk-divider"></div>
    <button class="bulk-btn" id="bulkFavorite"><span class="icon icon-sm" id="bulkStarIcon"></span> Favorite</button>
    <button class="bulk-btn" id="bulkTag"><span class="icon icon-sm" id="bulkTagIcon"></span> Add Tag</button>
    <button class="bulk-btn danger" id="bulkDelete"><span class="icon icon-sm" id="bulkDeleteIcon"></span> Delete</button>
    <div class="bulk-divider"></div>
    <button class="bulk-btn" id="bulkSelectAll"><span class="icon icon-sm" id="bulkSelectIcon"></span> <span id="bulkSelectText">Select All</span></button>
    <button class="bulk-close" id="bulkClose"><span class="icon icon-sm" id="bulkCloseIcon"></span></button>
  </div>

  <!-- Bulk Tag Modal -->
  <div class="modal-overlay" id="tagModal">
    <div class="modal">
      <h3 class="modal-title">Add Tag to Selected Files</h3>
      <input type="text" class="modal-input" id="bulkTagInput" placeholder="Enter tag name...">
      <div class="modal-actions">
        <button class="modal-btn secondary" id="tagModalCancel">Cancel</button>
        <button class="modal-btn primary" id="tagModalConfirm">Add Tag</button>
      </div>
    </div>
  </div>

  <!-- Command Palette -->
  <div class="cmd-overlay" id="cmdOverlay">
    <div class="cmd-palette">
      <div class="cmd-header">
        <span class="icon icon-md" id="cmdSearchIcon"></span>
        <input type="text" class="cmd-input" id="cmdInput" placeholder="Type a command or search..." autocomplete="off">
        <span class="cmd-hint">esc</span>
      </div>
      <div class="cmd-body" id="cmdBody"></div>
      <div class="cmd-footer">
        <span><span class="cmd-key"></span> navigate</span>
        <span><span class="cmd-key"></span> select</span>
        <span><span class="cmd-key">esc</span> close</span>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="settings-overlay" id="settingsOverlay">
    <div class="settings-modal" style="width:560px;">
      <div class="settings-header">
        <h2><span class="icon icon-md" id="settingsModalIcon"></span> AI Settings</h2>
        <button class="close-btn" id="closeSettings"><span class="icon icon-md" id="closeSettingsIcon"></span></button>
      </div>
      <div class="settings-body" style="max-height:60vh;overflow-y:auto;">
        <!-- AI Provider Selection -->
        <div class="settings-section">
          <label class="settings-label">AI Provider</label>
          <p class="settings-desc">Choose between local AI (Ollama) or cloud AI (Claude)</p>
          <select class="settings-input" id="aiProvider" style="cursor:pointer;">
            <option value="ollama">Ollama (Local, Private, Free)</option>
            <option value="claude">Claude API (Cloud, Paid)</option>
          </select>
        </div>

        <!-- Ollama Settings -->
        <div id="ollamaSettings">
          <div class="settings-section" style="background:#f0fdf4;padding:12px;border-radius:8px;margin-top:12px;">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
              <span class="icon icon-sm" id="ollamaStatusIcon" style="color:#22c55e;"></span>
              <label class="settings-label" style="margin:0;">Ollama Status</label>
              <span id="ollamaStatusText" style="font-size:12px;color:#22c55e;">Checking...</span>
            </div>
            <button class="modal-btn secondary" id="refreshOllamaStatus" style="font-size:12px;padding:6px 10px;">Refresh Status</button>
          </div>

          <div class="settings-section">
            <label class="settings-label">Installed Models</label>
            <p class="settings-desc">Models available for analysis and chat</p>
            <div id="installedModels" style="margin-top:8px;font-size:13px;color:#78716c;">Loading...</div>
          </div>

          <div class="settings-section">
            <label class="settings-label">Pull New Model</label>
            <p class="settings-desc">Download a model from Ollama library</p>
            <div style="display:flex;gap:8px;">
              <select class="settings-input" id="modelToPull" style="flex:1;cursor:pointer;">
                <optgroup label="Embeddings (Required)">
                  <option value="nomic-embed-text">nomic-embed-text (274MB)</option>
                  <option value="mxbai-embed-large">mxbai-embed-large (670MB)</option>
                </optgroup>
                <optgroup label="Text Generation (Ultra Light - Under 2GB)">
                  <option value="gemma2:2b">gemma2:2b (1.6GB) - Recommended</option>
                  <option value="qwen2.5:1.5b">qwen2.5:1.5b (0.9GB)</option>
                  <option value="llama3.2:1b">llama3.2:1b (1.3GB)</option>
                </optgroup>
                <optgroup label="Text Generation (Light - 2-4GB)">
                  <option value="llama3.2:3b">llama3.2:3b (2GB)</option>
                  <option value="phi3:mini">phi3:mini (2.3GB)</option>
                  <option value="qwen2.5:3b">qwen2.5:3b (1.9GB)</option>
                </optgroup>
                <optgroup label="Text Generation (Standard)">
                  <option value="llama3.1:8b">llama3.1:8b (4.7GB)</option>
                  <option value="mistral:7b">mistral:7b (4.1GB)</option>
                </optgroup>
                <optgroup label="Code Models">
                  <option value="codellama:7b">codellama:7b (3.8GB)</option>
                  <option value="deepseek-coder:6.7b">deepseek-coder:6.7b (3.8GB)</option>
                </optgroup>
              </select>
              <button class="modal-btn primary" id="pullModelBtn" style="white-space:nowrap;">Pull Model</button>
            </div>
            <div id="pullProgress" style="display:none;margin-top:8px;font-size:12px;color:#78716c;"></div>
          </div>
        </div>

        <!-- Claude Settings -->
        <div id="claudeSettings" style="display:none;">
          <div class="settings-section">
            <label class="settings-label">Claude API Key</label>
            <p class="settings-desc">Get your key at <a href="https://console.anthropic.com" target="_blank" style="color:#8b5cf6;">console.anthropic.com</a></p>
            <input type="password" class="settings-input" id="apiKeyInput" placeholder="sk-ant-...">
          </div>
        </div>

        <div class="settings-section">
          <label class="settings-label">Default Search Mode</label>
          <select class="settings-input" id="defaultSearchMode" style="cursor:pointer;">
            <option value="text">Text Search (fast, keyword matching)</option>
            <option value="semantic">AI Search (semantic understanding)</option>
            <option value="symbol">Code Search (functions & symbols)</option>
          </select>
        </div>

        <div class="settings-section">
          <label class="settings-label" style="display:flex;align-items:center;gap:8px;cursor:pointer;">
            <input type="checkbox" id="autoTagEnabled" style="width:16px;height:16px;cursor:pointer;">
            Auto-tag new files during indexing
          </label>
          <p class="settings-desc">Automatically generate AI-suggested tags for newly indexed files. Requires Ollama to be running.</p>
        </div>
      </div>
      <div class="settings-footer">
        <button class="modal-btn secondary" id="settingsCancel">Cancel</button>
        <button class="modal-btn primary" id="settingsSave">Save Settings</button>
      </div>
    </div>
  </div>

  <!-- Floating Chat Bubble -->
  <div class="chat-bubble" id="chatBubble">
    <span class="icon icon-lg" id="chatBubbleIcon"></span>
    <span class="chat-bubble-badge" id="chatBadge" style="display:none;">1</span>
    <div class="chat-bubble-pulse"></div>
  </div>

  <!-- Expanded Chat Window -->
  <div class="chat-window" id="chatWindow">
    <div class="chat-header">
      <div class="chat-header-left">
        <span class="icon icon-md" id="chatHeaderIcon"></span>
        <div class="chat-header-info">
          <h2>Hippo AI</h2>
          <span class="chat-status" id="chatStatus">
            <span class="status-dot" id="ollamaStatusDot"></span>
            <span id="chatStatusText">Connecting...</span>
          </span>
        </div>
      </div>
      <div class="chat-header-actions">
        <button class="chat-action-btn" id="chatSettingsBtn" title="AI Settings"><span class="icon icon-sm" id="chatSettingsIcon"></span></button>
        <button class="chat-action-btn" id="chatClearBtn" title="Clear chat"><span class="icon icon-sm" id="chatClearIcon"></span></button>
        <button class="chat-action-btn" id="chatMinimizeBtn" title="Minimize"><span class="icon icon-sm" id="chatMinimizeIcon"></span></button>
      </div>
    </div>

    <!-- AI Progress Bar -->
    <div class="ai-progress-container" id="aiProgressContainer" style="display:none;">
      <div class="ai-progress-bar" id="aiProgressBar"></div>
      <div class="ai-progress-info">
        <span class="icon icon-sm ai-progress-icon" id="aiProgressIcon"></span>
        <span id="aiProgressText">Processing...</span>
      </div>
    </div>

    <!-- File Context Bar (shows when files are selected) -->
    <div class="chat-context-bar" id="chatContextBar" style="display:none;">
      <div class="context-info">
        <span class="icon icon-sm" id="contextIcon"></span>
        <span id="contextText">0 files selected</span>
      </div>
      <div class="context-actions">
        <button class="context-btn" id="analyzeSelectedBtn"><span class="icon icon-xs" id="ctxAnalyzeIcon"></span> Analyze</button>
        <button class="context-btn" id="summarizeSelectedBtn"><span class="icon icon-xs" id="ctxSummarizeIcon"></span> Summarize</button>
        <button class="context-btn secondary" id="clearContextBtn"></button>
      </div>
    </div>

    <div class="chat-messages" id="chatMessages">
      <div class="chat-welcome">
        <div class="welcome-icon-container">
          <span class="icon icon-2xl" id="welcomeIcon"></span>
        </div>
        <h3>Hippo AI Assistant</h3>
        <p>Ask questions about your files, get summaries, find patterns, and more.</p>
        <div class="ai-capabilities">
          <div class="capability-badge"><span class="icon icon-xs" id="capLocal"></span> Local AI</div>
          <div class="capability-badge"><span class="icon icon-xs" id="capPrivate"></span> Private</div>
          <div class="capability-badge"><span class="icon icon-xs" id="capFast"></span> Fast</div>
        </div>
        <div class="quick-actions">
          <button class="quick-action-btn" data-action="summarize">
            <span class="icon icon-sm" id="qaSum"></span>
            <div class="qa-text">
              <span class="qa-title">Summarize Collection</span>
              <span class="qa-desc">Overview of your files</span>
            </div>
          </button>
          <button class="quick-action-btn" data-action="find-duplicates">
            <span class="icon icon-sm" id="qaDup"></span>
            <div class="qa-text">
              <span class="qa-title">Find Similar</span>
              <span class="qa-desc">Detect duplicates & patterns</span>
            </div>
          </button>
          <button class="quick-action-btn" data-action="organize">
            <span class="icon icon-sm" id="qaOrg"></span>
            <div class="qa-text">
              <span class="qa-title">Smart Organize</span>
              <span class="qa-desc">AI-powered suggestions</span>
            </div>
          </button>
          <button class="quick-action-btn" data-action="extract-insights">
            <span class="icon icon-sm" id="qaInsight"></span>
            <div class="qa-text">
              <span class="qa-title">Extract Insights</span>
              <span class="qa-desc">Key themes & topics</span>
            </div>
          </button>
          <button class="quick-action-btn" data-action="code-review">
            <span class="icon icon-sm" id="qaCode"></span>
            <div class="qa-text">
              <span class="qa-title">Code Analysis</span>
              <span class="qa-desc">Review code quality</span>
            </div>
          </button>
          <button class="quick-action-btn" data-action="search-help">
            <span class="icon icon-sm" id="qaSearch"></span>
            <div class="qa-text">
              <span class="qa-title">Smart Search</span>
              <span class="qa-desc">Natural language queries</span>
            </div>
          </button>
        </div>
      </div>
    </div>

    <div class="chat-input-container">
      <div class="chat-input-wrapper">
        <input type="text" class="chat-input" id="chatInput" placeholder="Ask anything about your files...">
        <div class="chat-input-actions">
          <button class="input-action-btn" id="attachFileBtn" title="Attach selected files">
            <span class="icon icon-sm" id="attachIcon"></span>
            <span class="attach-count" id="attachCount" style="display:none;">0</span>
          </button>
        </div>
      </div>
      <button class="chat-send-btn" id="chatSendBtn">
        <span class="icon icon-md" id="sendIcon"></span>
      </button>
    </div>
  </div>

  <style>
    /* Icon sizes */
    .icon-xs { width: 12px; height: 12px; }

    /* Floating Chat Bubble */
    .chat-bubble {
      position: fixed;
      bottom: 28px;
      right: 28px;
      width: 60px;
      height: 60px;
      border-radius: 18px;
      background: linear-gradient(135deg, #1c1917 0%, #292524 100%);
      box-shadow: 0 8px 32px rgba(0,0,0,0.25), 0 0 0 1px rgba(255,255,255,0.05);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      color: white;
    }
    body.dark .chat-bubble { background: linear-gradient(135deg, #fafaf9 0%, #e7e5e4 100%); color: #1c1917; }
    .chat-bubble:hover {
      transform: translateY(-4px) scale(1.05);
      box-shadow: 0 12px 40px rgba(0,0,0,0.3), 0 0 0 1px rgba(255,255,255,0.08);
    }
    .chat-bubble:active { transform: translateY(-2px) scale(1.02); }
    .chat-bubble.hidden { display: none; }
    .chat-bubble-pulse {
      position: absolute;
      inset: 0;
      border-radius: 18px;
      background: inherit;
      animation: bubblePulse 2.5s ease-in-out infinite;
      opacity: 0;
      z-index: -1;
    }
    @keyframes bubblePulse {
      0%, 100% { transform: scale(1); opacity: 0; }
      50% { transform: scale(1.2); opacity: 0.25; }
    }
    .chat-bubble.processing .chat-bubble-pulse { animation: bubblePulseActive 1.2s ease-in-out infinite; }
    @keyframes bubblePulseActive {
      0%, 100% { transform: scale(1); opacity: 0.15; }
      50% { transform: scale(1.25); opacity: 0.4; }
    }
    .chat-bubble-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      min-width: 20px;
      height: 20px;
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      border-radius: 10px;
      color: white;
      font-size: 11px;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 6px;
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
      animation: scaleIn 0.3s ease;
    }

    /* Chat Window */
    .chat-window {
      position: fixed;
      bottom: 28px;
      right: 28px;
      width: 420px;
      height: 600px;
      background: #fafaf9;
      border-radius: 24px;
      box-shadow: 0 24px 80px rgba(0,0,0,0.18), 0 0 0 1px rgba(0,0,0,0.04);
      z-index: 1001;
      display: none;
      flex-direction: column;
      overflow: hidden;
    }
    .chat-window.open { display: flex; animation: chatSlideUp 0.35s cubic-bezier(0.4, 0, 0.2, 1); }
    body.dark .chat-window { background: #0f0e0d; box-shadow: 0 24px 80px rgba(0,0,0,0.5), 0 0 0 1px rgba(255,255,255,0.04); }
    @keyframes chatSlideUp {
      from { opacity: 0; transform: translateY(24px) scale(0.96); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    /* Chat Header */
    .chat-header {
      padding: 16px 20px;
      background: linear-gradient(135deg, #1c1917 0%, #292524 100%);
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: white;
    }
    body.dark .chat-header { background: linear-gradient(135deg, #0c0a09 0%, #1c1917 100%); }
    .chat-header-left { display: flex; align-items: center; gap: 12px; }
    .chat-header-left .icon { opacity: 0.9; }
    .chat-header-info h2 { font-size: 15px; font-weight: 700; margin: 0; letter-spacing: -0.02em; }
    .chat-status { display: flex; align-items: center; gap: 6px; font-size: 11px; color: rgba(255,255,255,0.6); }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #78716c; transition: all 0.3s; }
    .status-dot.online { background: #22c55e; box-shadow: 0 0 8px rgba(34, 197, 94, 0.5); }
    .status-dot.offline { background: #f59e0b; box-shadow: 0 0 8px rgba(245, 158, 11, 0.5); }
    .status-dot.error { background: #ef4444; box-shadow: 0 0 8px rgba(239, 68, 68, 0.5); }
    .status-dot.connecting { background: #78716c; animation: statusPulse 1s ease-in-out infinite; }
    @keyframes statusPulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
    .chat-header-actions { display: flex; gap: 4px; }
    .chat-action-btn {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      background: transparent;
      border: none;
      color: rgba(255,255,255,0.7);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .chat-action-btn:hover { background: rgba(255,255,255,0.12); color: white; transform: scale(1.05); }
    .chat-action-btn:active { transform: scale(0.95); }

    /* AI Progress Bar */
    .ai-progress-container {
      background: #f5f5f4;
      border-bottom: 1px solid #e7e5e4;
      overflow: hidden;
    }
    body.dark .ai-progress-container { background: #0c0a09; border-color: #292524; }
    .ai-progress-bar {
      height: 2px;
      background: linear-gradient(90deg, #8b5cf6 0%, #6366f1 50%, #8b5cf6 100%);
      background-size: 200% 100%;
      animation: progressSlide 1.5s ease-in-out infinite;
      width: 100%;
    }
    @keyframes progressSlide {
      0% { background-position: 100% 0; }
      100% { background-position: -100% 0; }
    }
    .ai-progress-info {
      padding: 8px 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      color: #57534e;
    }
    body.dark .ai-progress-info { color: #a8a29e; }
    .ai-progress-icon { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    /* Context Bar */
    .chat-context-bar {
      padding: 8px 12px;
      background: #fafaf9;
      border-bottom: 1px solid #e7e5e4;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    body.dark .chat-context-bar { background: #0c0a09; border-color: #292524; }
    .context-info { display: flex; align-items: center; gap: 6px; font-size: 12px; color: #57534e; }
    body.dark .context-info { color: #a8a29e; }
    .context-actions { display: flex; gap: 6px; }
    .context-btn {
      padding: 5px 10px;
      background: #292524;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .context-btn:hover { background: #44403c; }
    body.dark .context-btn { background: #fafaf9; color: #292524; }
    body.dark .context-btn:hover { background: #e7e5e4; }
    .context-btn.secondary { background: transparent; color: #78716c; padding: 5px 8px; }
    .context-btn.secondary:hover { background: #e7e5e4; }
    body.dark .context-btn.secondary { color: #a8a29e; }
    body.dark .context-btn.secondary:hover { background: #292524; }

    /* Chat Messages */
    .chat-messages { flex: 1; overflow-y: auto; padding: 16px; }
    .chat-welcome { padding: 20px 8px; }
    .welcome-icon-container {
      width: 56px;
      height: 56px;
      margin: 0 auto 16px;
      background: #f5f5f4;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #57534e;
    }
    body.dark .welcome-icon-container { background: #292524; color: #a8a29e; }
    .chat-welcome h3 { font-size: 15px; color: #292524; margin: 0 0 4px; font-weight: 600; text-align: center; }
    body.dark .chat-welcome h3 { color: #fafaf9; }
    .chat-welcome p { font-size: 12px; color: #78716c; margin: 0 0 12px; line-height: 1.4; text-align: center; }
    .ai-capabilities {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 16px;
    }
    .capability-badge {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      background: #f5f5f4;
      border-radius: 6px;
      font-size: 10px;
      color: #57534e;
      font-weight: 500;
    }
    body.dark .capability-badge { background: #292524; color: #a8a29e; }
    .quick-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .quick-action-btn {
      padding: 12px;
      background: white;
      border: 1px solid #e7e5e4;
      border-radius: 10px;
      cursor: pointer;
      display: flex;
      align-items: flex-start;
      gap: 10px;
      transition: all 0.15s;
      text-align: left;
    }
    .quick-action-btn:hover { border-color: #292524; background: #fafaf9; }
    body.dark .quick-action-btn { background: #0c0a09; border-color: #292524; }
    body.dark .quick-action-btn:hover { border-color: #57534e; background: #1c1917; }
    .quick-action-btn .icon { color: #57534e; flex-shrink: 0; margin-top: 2px; }
    body.dark .quick-action-btn .icon { color: #a8a29e; }
    .qa-text { display: flex; flex-direction: column; gap: 2px; min-width: 0; }
    .qa-title { font-size: 12px; font-weight: 500; color: #292524; }
    body.dark .qa-title { color: #fafaf9; }
    .qa-desc { font-size: 10px; color: #78716c; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* Chat Messages */
    .chat-message { margin-bottom: 16px; }
    .chat-message.user { text-align: right; }
    .chat-message .bubble {
      display: inline-block;
      max-width: 90%;
      padding: 12px 16px;
      border-radius: 16px;
      font-size: 13px;
      line-height: 1.6;
      text-align: left;
    }
    .chat-message.user .bubble {
      background: linear-gradient(135deg, #292524 0%, #44403c 100%);
      color: white;
      border-bottom-right-radius: 4px;
    }
    body.dark .chat-message.user .bubble { background: linear-gradient(135deg, #fafaf9 0%, #e7e5e4 100%); color: #292524; }
    .chat-message.assistant .bubble {
      background: white;
      color: #292524;
      border: 1px solid #e7e5e4;
      border-bottom-left-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    body.dark .chat-message.assistant .bubble { background: #1c1917; color: #fafaf9; border-color: #44403c; }

    /* Rich Message Content */
    .msg-content { white-space: normal; }
    .msg-content p { margin: 0 0 8px 0; }
    .msg-content p:last-child { margin-bottom: 0; }
    .msg-content strong { font-weight: 600; color: #292524; }
    body.dark .msg-content strong { color: #fafaf9; }
    .msg-content em { font-style: italic; color: #57534e; }
    body.dark .msg-content em { color: #a8a29e; }
    .msg-content code {
      font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
      font-size: 12px;
      padding: 2px 6px;
      background: #f5f5f4;
      border-radius: 4px;
      color: #dc2626;
    }
    body.dark .msg-content code { background: #292524; color: #f87171; }

    /* Code Blocks */
    .msg-code-block {
      position: relative;
      margin: 12px 0;
      border-radius: 8px;
      overflow: hidden;
      background: #1c1917;
    }
    .msg-code-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: #292524;
      border-bottom: 1px solid #44403c;
    }
    .msg-code-lang {
      font-size: 11px;
      color: #a8a29e;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .msg-code-copy {
      padding: 4px 8px;
      background: #44403c;
      border: none;
      border-radius: 4px;
      color: #d6d3d1;
      font-size: 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
      transition: all 0.15s;
    }
    .msg-code-copy:hover { background: #57534e; color: white; }
    .msg-code-copy .icon { width: 12px; height: 12px; }
    .msg-code-pre {
      margin: 0;
      padding: 12px;
      overflow-x: auto;
      font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
      font-size: 12px;
      line-height: 1.5;
      color: #e7e5e4;
    }
    body.dark .msg-code-block { background: #0c0a09; }
    body.dark .msg-code-header { background: #1c1917; }

    /* Lists */
    .msg-list {
      margin: 10px 0;
      padding-left: 0;
      list-style: none;
    }
    .msg-list li {
      position: relative;
      padding: 6px 0 6px 24px;
      border-bottom: 1px solid #f5f5f4;
    }
    .msg-list li:last-child { border-bottom: none; }
    body.dark .msg-list li { border-color: #44403c; }
    .msg-list li::before {
      content: '';
      position: absolute;
      left: 8px;
      top: 14px;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #6366f1;
    }
    .msg-list.numbered li::before {
      content: counter(list-item);
      counter-increment: list-item;
      width: auto;
      height: auto;
      background: none;
      font-size: 11px;
      font-weight: 600;
      color: #6366f1;
      top: 6px;
      left: 4px;
    }
    .msg-list.numbered { counter-reset: list-item; }

    /* Headers in messages */
    .msg-h1 { font-size: 16px; font-weight: 600; margin: 16px 0 8px; color: #292524; border-bottom: 1px solid #e7e5e4; padding-bottom: 8px; }
    .msg-h2 { font-size: 14px; font-weight: 600; margin: 14px 0 6px; color: #44403c; }
    .msg-h3 { font-size: 13px; font-weight: 600; margin: 12px 0 4px; color: #57534e; }
    body.dark .msg-h1 { color: #fafaf9; border-color: #44403c; }
    body.dark .msg-h2 { color: #e7e5e4; }
    body.dark .msg-h3 { color: #d6d3d1; }

    /* Action Buttons in Messages */
    .msg-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #e7e5e4;
    }
    body.dark .msg-actions { border-color: #44403c; }
    .msg-action-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      background: linear-gradient(135deg, #f5f5f4 0%, #e7e5e4 100%);
      border: 1px solid #d6d3d1;
      border-radius: 8px;
      font-size: 12px;
      color: #44403c;
      cursor: pointer;
      transition: all 0.15s;
    }
    .msg-action-btn:hover {
      background: linear-gradient(135deg, #e7e5e4 0%, #d6d3d1 100%);
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .msg-action-btn .icon { width: 14px; height: 14px; }
    .msg-action-btn.primary {
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      border-color: #6366f1;
      color: white;
    }
    .msg-action-btn.primary:hover { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); }
    body.dark .msg-action-btn { background: linear-gradient(135deg, #292524 0%, #44403c 100%); border-color: #57534e; color: #d6d3d1; }
    body.dark .msg-action-btn:hover { background: linear-gradient(135deg, #44403c 0%, #57534e 100%); }

    /* Highlight boxes */
    .msg-highlight {
      margin: 12px 0;
      padding: 12px;
      border-radius: 8px;
      border-left: 3px solid;
    }
    .msg-highlight.info { background: #eff6ff; border-color: #3b82f6; color: #1e40af; }
    .msg-highlight.success { background: #f0fdf4; border-color: #22c55e; color: #166534; }
    .msg-highlight.warning { background: #fffbeb; border-color: #f59e0b; color: #92400e; }
    .msg-highlight.tip { background: #faf5ff; border-color: #8b5cf6; color: #6b21a8; }
    body.dark .msg-highlight.info { background: #172554; color: #93c5fd; }
    body.dark .msg-highlight.success { background: #052e16; color: #86efac; }
    body.dark .msg-highlight.warning { background: #451a03; color: #fcd34d; }
    body.dark .msg-highlight.tip { background: #2e1065; color: #c4b5fd; }
    .msg-highlight-title { font-weight: 600; font-size: 12px; margin-bottom: 4px; display: flex; align-items: center; gap: 6px; }
    .msg-highlight-title .icon { width: 14px; height: 14px; }

    /* File mentions */
    .msg-file-mention {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      background: #fef3c7;
      border-radius: 4px;
      font-size: 12px;
      color: #92400e;
      cursor: pointer;
      transition: all 0.15s;
    }
    .msg-file-mention:hover { background: #fde68a; }
    body.dark .msg-file-mention { background: #451a03; color: #fcd34d; }
    body.dark .msg-file-mention:hover { background: #78350f; }
    .msg-file-mention .icon { width: 12px; height: 12px; }

    /* Quick stats cards */
    .msg-stat-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 8px;
      margin: 12px 0;
    }
    .msg-stat-card {
      padding: 10px;
      background: #fafaf9;
      border-radius: 8px;
      text-align: center;
    }
    body.dark .msg-stat-card { background: #292524; }
    .msg-stat-value { font-size: 18px; font-weight: 600; color: #6366f1; }
    .msg-stat-label { font-size: 10px; color: #78716c; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px; }

    /* Chat Input */
    .chat-input-container { padding: 12px 16px; border-top: 1px solid #e7e5e4; display: flex; gap: 8px; align-items: flex-end; }
    body.dark .chat-input-container { border-color: #292524; }
    .chat-input-wrapper {
      flex: 1;
      display: flex;
      align-items: center;
      background: #f5f5f4;
      border: 1px solid #e7e5e4;
      border-radius: 12px;
      padding: 0 4px 0 12px;
      transition: all 0.15s;
    }
    .chat-input-wrapper:focus-within { border-color: #292524; background: white; }
    body.dark .chat-input-wrapper { background: #0c0a09; border-color: #292524; }
    body.dark .chat-input-wrapper:focus-within { border-color: #57534e; background: #1c1917; }
    .chat-input {
      flex: 1;
      padding: 10px 0;
      border: none;
      background: transparent;
      font-size: 13px;
      outline: none;
      color: #292524;
    }
    body.dark .chat-input { color: #fafaf9; }
    .chat-input::placeholder { color: #a8a29e; }
    .chat-input-actions { display: flex; position: relative; }
    .input-action-btn {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      background: transparent;
      border: none;
      color: #78716c;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
      position: relative;
    }
    .input-action-btn:hover { background: #e7e5e4; color: #292524; }
    .input-action-btn.has-files { color: #292524; }
    body.dark .input-action-btn:hover { background: #292524; color: #fafaf9; }
    body.dark .input-action-btn.has-files { color: #fafaf9; }
    .attach-count {
      position: absolute;
      top: 2px;
      right: 2px;
      min-width: 14px;
      height: 14px;
      background: #292524;
      border-radius: 7px;
      color: white;
      font-size: 9px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    body.dark .attach-count { background: #fafaf9; color: #292524; }
    .chat-send-btn {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: #292524;
      border: none;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
      flex-shrink: 0;
    }
    body.dark .chat-send-btn { background: #fafaf9; color: #292524; }
    .chat-send-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .chat-send-btn:disabled { background: #d6d3d1; transform: none; box-shadow: none; cursor: not-allowed; }
    body.dark .chat-send-btn:disabled { background: #44403c; color: #78716c; }

    /* Chat Loading Animation */
    .chat-loading { display: flex; gap: 4px; padding: 8px 0; }
    .chat-loading span { width: 6px; height: 6px; background: #57534e; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out; }
    body.dark .chat-loading span { background: #a8a29e; }
    .chat-loading span:nth-child(1) { animation-delay: -0.32s; }
    .chat-loading span:nth-child(2) { animation-delay: -0.16s; }
    @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

    /* File Preview Cards in Chat */
    .chat-file-previews {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid rgba(0,0,0,0.08);
    }
    body.dark .chat-file-previews { border-color: rgba(255,255,255,0.08); }

    .chat-file-card {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      background: white;
      border: 1px solid #e7e5e4;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s;
      max-width: 200px;
      min-width: 140px;
    }
    .chat-file-card:hover { background: #fafaf9; border-color: #d6d3d1; transform: translateY(-1px); }
    body.dark .chat-file-card { background: #1c1917; border-color: #44403c; }
    body.dark .chat-file-card:hover { background: #292524; border-color: #57534e; }

    .chat-file-thumb {
      width: 36px;
      height: 36px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      overflow: hidden;
      position: relative;
    }
    .chat-file-thumb.image { background: #fef2f2; color: #dc2626; }
    .chat-file-thumb.code { background: #f0fdf4; color: #16a34a; }
    .chat-file-thumb.document { background: #eff6ff; color: #2563eb; }
    .chat-file-thumb.video { background: #faf5ff; color: #9333ea; }
    .chat-file-thumb.audio { background: #fdf4ff; color: #c026d3; }
    .chat-file-thumb.file { background: #f5f5f4; color: #78716c; }
    body.dark .chat-file-thumb.image { background: #450a0a; }
    body.dark .chat-file-thumb.code { background: #052e16; }
    body.dark .chat-file-thumb.document { background: #172554; }
    body.dark .chat-file-thumb.video { background: #3b0764; }
    body.dark .chat-file-thumb.audio { background: #4a044e; }
    body.dark .chat-file-thumb.file { background: #292524; }

    .chat-file-thumb img {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      object-fit: cover;
    }

    .chat-file-info {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
    }
    .chat-file-name {
      font-size: 12px;
      font-weight: 500;
      color: #44403c;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    body.dark .chat-file-name { color: #e7e5e4; }
    .chat-file-meta {
      font-size: 10px;
      color: #a8a29e;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .chat-file-relevance {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .chat-file-relevance.high { background: #22c55e; }
    .chat-file-relevance.medium { background: #f59e0b; }
    .chat-file-relevance.low { background: #94a3b8; }

    /* File Preview Header */
    .chat-files-header {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #78716c;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .chat-files-header .icon { width: 12px; height: 12px; }
    body.dark .chat-files-header { color: #a8a29e; }

    /* AI Stats */
    .ai-stats {
      display: flex;
      gap: 12px;
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px dashed rgba(0,0,0,0.08);
      font-size: 10px;
      color: #a8a29e;
    }
    body.dark .ai-stats { border-color: rgba(255,255,255,0.08); }
    .ai-stat { display: flex; align-items: center; gap: 4px; }
    .ai-stat .icon { width: 12px; height: 12px; }

    /* Drop Zone Overlay */
    .drop-zone-overlay {
      position: fixed;
      inset: 0;
      background: rgba(99, 102, 241, 0.15);
      backdrop-filter: blur(4px);
      z-index: 2000;
      display: none;
      align-items: center;
      justify-content: center;
      border: 4px dashed rgba(99, 102, 241, 0.5);
    }
    .drop-zone-overlay.active { display: flex; }
    .drop-zone-content {
      text-align: center;
      color: #6366f1;
      font-size: 24px;
      font-weight: 600;
      padding: 40px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
    }
    body.dark .drop-zone-content { background: #292524; color: #818cf8; }
    .drop-zone-content .icon { width: 64px; height: 64px; margin-bottom: 16px; }
  </style>

  <script>
    (function() {
      // Custom SVG Icons - Clean, minimal design
      var icons = {
        // Custom Hippo logo - distinctive hippo face with ears, eyes, snout and nostrils
        hippo: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><ellipse cx="12" cy="13" rx="9" ry="8" fill="currentColor" opacity="0.15"/><ellipse cx="12" cy="13" rx="9" ry="8"/><circle cx="6" cy="5" r="2.5"/><circle cx="18" cy="5" r="2.5"/><circle cx="8" cy="10" r="1.2" fill="currentColor"/><circle cx="16" cy="10" r="1.2" fill="currentColor"/><ellipse cx="12" cy="16" rx="5" ry="3.5"/><circle cx="10" cy="16" r="1" fill="currentColor"/><circle cx="14" cy="16" r="1" fill="currentColor"/><path d="M9 19.5c0 0 1.5 1 3 1s3-1 3-1" stroke-width="1.2"/></svg>',
        search: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="7"/><path d="m21 21-4.35-4.35"/></svg>',
        moon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>',
        sun: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>',
        trash: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>',
        star: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>',
        starFilled: '<svg viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>',
        image: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>',
        video: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="m10 9 5 3-5 3V9Z"/></svg>',
        audio: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>',
        code: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>',
        doc: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>',
        file: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>',
        folder: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>',
        grid: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>',
        list: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>',
        graph: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>',
        close: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',
        folderEmpty: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/><line x1="12" y1="11" x2="12" y2="17"/><line x1="9" y1="14" x2="15" y2="14"/></svg>',
        folderPlus: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/><line x1="12" y1="11" x2="12" y2="17"/><line x1="9" y1="14" x2="15" y2="14"/></svg>',
        refresh: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>',
        settings: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>',
        eye: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>',
        tag: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>',
        filter: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>',
        externalLink: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>',
        command: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 3a3 3 0 0 0-3 3v12a3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3H6a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3V6a3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3h12a3 3 0 0 0 3-3 3 3 0 0 0-3-3z"/></svg>',
        zap: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>',
        check: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>',
        plus: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>',
        checkSquare: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>',
        sparkles: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></svg>',
        brain: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 4.44-1.54"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-4.44-1.54"/></svg>',
        terminal: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></svg>',
        messageCircle: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>',
        send: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>',
        checkCircle: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',
        alertCircle: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>',
        download: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>',
        upload: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>',
        // Custom Hippo AI icon - hippo with sparkle
        hippoAI: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><ellipse cx="10" cy="14" rx="7" ry="6" fill="currentColor" opacity="0.1"/><ellipse cx="10" cy="14" rx="7" ry="6"/><circle cx="5" cy="8" r="2"/><circle cx="15" cy="8" r="2"/><circle cx="7" cy="12" r="1" fill="currentColor"/><circle cx="13" cy="12" r="1" fill="currentColor"/><ellipse cx="10" cy="16" rx="3.5" ry="2.5"/><circle cx="8.5" cy="16" r="0.7" fill="currentColor"/><circle cx="11.5" cy="16" r="0.7" fill="currentColor"/><path d="M19 3l-0.8 2.4a1 1 0 0 1-.6.6L15 6.8l2.4.8a1 1 0 0 1 .6.6L19 11l.8-2.4a1 1 0 0 1 .6-.6L23 7.2l-2.4-.8a1 1 0 0 1-.6-.6L19 3z" fill="currentColor" opacity="0.8"/><circle cx="21" cy="15" r="1" fill="currentColor" opacity="0.5"/></svg>',
        // Memory/elephant brain icon
        memory: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="9" fill="currentColor" opacity="0.08"/><circle cx="12" cy="12" r="9"/><path d="M12 6v2"/><path d="M12 16v2"/><path d="M6 12h2"/><path d="M16 12h2"/><circle cx="12" cy="12" r="3" fill="currentColor" opacity="0.2"/><circle cx="12" cy="12" r="1" fill="currentColor"/></svg>',
        // Organize/magic wand icon
        organize: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 4-1 1 4 4 1-1a2.83 2.83 0 1 0-4-4Z"/><path d="m13 6-8.5 8.5a2.12 2.12 0 1 0 3 3L16 9"/><path d="m8 15 2 2"/><path d="M3 21h4"/><path d="M17 21h4"/><path d="M19 17v4"/><path d="M5 17v4"/></svg>',
        // Watch/eye-scan icon
        watch: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/><path d="M12 9v6" stroke-width="1" opacity="0.5"/></svg>',
        // Play icon (for watching)
        play: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>',
        // Pause icon
        pause: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>',
        // Stop icon
        stop: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="5" y="5" width="14" height="14" rx="2"/></svg>'
      };

      // State
      var memories = [];
      var allTags = [];
      var sources = [];
      var selectedMemory = null;
      var filterType = 'all';
      var activeTags = [];
      var viewMode = 'grid';
      // Initialize dark mode from localStorage or system preference
      var darkMode = (function() {
        var stored = localStorage.getItem('hippo-theme');
        if (stored !== null) {
          return stored === 'dark';
        }
        // Check system preference
        return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      })();
      var convertFileSrc = null;
      var invoke = null;

      // Bulk selection state
      var selectedIds = [];
      var lastSelectedIdx = -1;
      var isMultiSelectMode = false;

      // Thumbnail cache: path -> thumbnail path
      var thumbnailCache = {};
      var thumbnailPending = {};

      // AI settings
      var apiKey = localStorage.getItem('hippo-api-key') || '';
      var searchMode = localStorage.getItem('hippo-search-mode') || 'text';
      var aiProvider = localStorage.getItem('hippo-ai-provider') || 'ollama';
      var ollamaAvailable = false;
      var ollamaModels = [];
      var chatMessages = [];
      var chatOpen = false;
      var symbolResults = [];

      // Collections & Organization state
      var collections = [];
      var virtualPaths = [];
      var similarMemories = [];
      var qdrantAvailable = false;
      var qdrantVectorCount = 0;

      // Graph visualization state
      var graphMode = 'mindmap'; // 'mindmap' or 'code'
      var graphData = null;
      var graphSimulation = null;
      var showCollections = false;

      // UX enhancements state
      var keyboardFocusIndex = -1;
      var recentSearches = JSON.parse(localStorage.getItem('hippo-recent-searches') || '[]');
      var savedSearches = JSON.parse(localStorage.getItem('hippo-saved-searches') || '[]');
      var dateFilter = 'all'; // 'all', 'today', 'week', 'month'
      var autoTagEnabled = localStorage.getItem('hippo-auto-tag') === 'true';

      // File watcher state
      var watcherStats = {
        total_watched_paths: 0,
        events_processed: 0,
        files_created: 0,
        files_modified: 0,
        files_deleted: 0,
        files_renamed: 0,
        is_watching: false,
        is_paused: false
      };
      var watcherEnabled = localStorage.getItem('hippo-watcher-enabled') === 'true';
      var showRecentSearches = false;
      var searchDropdownBlurTimeout = null;

      // Apply dark mode on load
      if (darkMode) document.body.classList.add('dark');

      // Command palette state
      var cmdSelectedIndex = 0;
      var cmdItems = [];
      var cmdMode = 'commands'; // 'commands' or 'files'

      // Virtual scrolling state
      var virtualScroller = {
        items: [],
        viewMode: 'grid',
        container: null,
        scrollParent: null,
        overscan: 5,
        rafId: null,
        resizeObserver: null,
        gridItemWidth: 190,
        gridItemHeight: 260,
        gridGap: 20,
        listItemHeight: 48,
        listGap: 6,
        init: function(container, scrollParent) {
          this.container = container;
          this.scrollParent = scrollParent;
          this.setupScrollListener();
          this.setupResizeObserver();
        },
        setupScrollListener: function() {
          var self = this;
          if (this.scrollParent) {
            this.scrollParent.addEventListener('scroll', function() {
              if (self.rafId) return;
              self.rafId = requestAnimationFrame(function() {
                self.render();
                self.rafId = null;
              });
            }, { passive: true });
          }
        },
        setupResizeObserver: function() {
          var self = this;
          if (typeof ResizeObserver !== 'undefined') {
            this.resizeObserver = new ResizeObserver(function() {
              self.render();
            });
            if (this.scrollParent) {
              this.resizeObserver.observe(this.scrollParent);
            }
          }
        },
        setItems: function(items, mode) {
          this.items = items;
          this.viewMode = mode;
          this.render();
        },
        getVisibleRange: function() {
          if (!this.scrollParent || this.items.length === 0) {
            return { start: 0, end: 0, offsetY: 0 };
          }
          var scrollTop = this.scrollParent.scrollTop;
          var containerHeight = this.scrollParent.clientHeight;
          var containerWidth = this.container ? this.container.clientWidth : this.scrollParent.clientWidth;
          if (this.viewMode === 'grid') {
            var cols = Math.floor((containerWidth + this.gridGap) / (this.gridItemWidth + this.gridGap)) || 1;
            var rowHeight = this.gridItemHeight + this.gridGap;
            var startRow = Math.floor(scrollTop / rowHeight);
            var endRow = Math.ceil((scrollTop + containerHeight) / rowHeight);
            startRow = Math.max(0, startRow - this.overscan);
            endRow = Math.min(Math.ceil(this.items.length / cols), endRow + this.overscan);
            var start = startRow * cols;
            var end = Math.min(this.items.length, endRow * cols);
            var offsetY = startRow * rowHeight;
            return { start: start, end: end, offsetY: offsetY, cols: cols };
          } else {
            var itemHeight = this.listItemHeight + this.listGap;
            var startIdx = Math.floor(scrollTop / itemHeight);
            var endIdx = Math.ceil((scrollTop + containerHeight) / itemHeight);
            startIdx = Math.max(0, startIdx - this.overscan);
            endIdx = Math.min(this.items.length, endIdx + this.overscan);
            var offsetY = startIdx * itemHeight;
            return { start: startIdx, end: endIdx, offsetY: offsetY };
          }
        },
        getTotalHeight: function() {
          if (this.items.length === 0) return 0;
          if (this.viewMode === 'grid') {
            var containerWidth = this.container ? this.container.clientWidth : 800;
            var cols = Math.floor((containerWidth + this.gridGap) / (this.gridItemWidth + this.gridGap)) || 1;
            var rows = Math.ceil(this.items.length / cols);
            return rows * (this.gridItemHeight + this.gridGap);
          } else {
            return this.items.length * (this.listItemHeight + this.listGap);
          }
        },
        render: function() {
          if (!this.container || this.items.length === 0) return;
          var range = this.getVisibleRange();
          var visibleItems = this.items.slice(range.start, range.end);
          var html = '';
          var containerClass = this.viewMode === 'grid' ? 'virtual-grid' : 'virtual-list';
          html += '<div class="virtual-scroll-container">';
          html += '<div class="virtual-scroll-spacer" style="height:' + this.getTotalHeight() + 'px;"></div>';
          html += '<div class="virtual-scroll-content" style="transform:translateY(' + range.offsetY + 'px);">';
          html += '<div class="' + containerClass + '">';
          for (var i = 0; i < visibleItems.length; i++) {
            var actualIdx = range.start + i;
            var mem = visibleItems[i];
            if (this.viewMode === 'grid') {
              html += renderCard(mem, actualIdx);
            } else {
              html += renderListItem(mem, actualIdx);
            }
          }
          html += '</div></div></div>';
          this.container.innerHTML = html;
          bindCardEvents();
        },
        destroy: function() {
          if (this.rafId) {
            cancelAnimationFrame(this.rafId);
            this.rafId = null;
          }
          if (this.resizeObserver) {
            this.resizeObserver.disconnect();
            this.resizeObserver = null;
          }
        }
      };

      // Initialize static icons
      function initIcons() {
        document.getElementById('logoIcon').innerHTML = icons.hippo;
        document.getElementById('themeIcon').innerHTML = darkMode ? icons.sun : icons.moon;
        document.getElementById('darkModeBtn').title = darkMode ? 'Switch to Light Mode' : 'Switch to Dark Mode';
        document.getElementById('themeToggleIcon').innerHTML = darkMode ? icons.sun : icons.moon;
        document.getElementById('resetIcon').innerHTML = icons.trash;
        document.getElementById('searchIcon').innerHTML = icons.search;
        document.getElementById('gridIcon').innerHTML = icons.grid;
        document.getElementById('listIcon').innerHTML = icons.list;
        document.getElementById('graphIcon').innerHTML = icons.graph;
        document.getElementById('multiSelectIcon').innerHTML = icons.checkSquare;
        document.getElementById('closeIcon').innerHTML = icons.close;
        document.getElementById('starIcon').innerHTML = icons.star;
        document.getElementById('previewIcon').innerHTML = icons.file;
        document.getElementById('cmdSearchIcon').innerHTML = icons.command;
        // Bulk bar icons
        document.getElementById('bulkStarIcon').innerHTML = icons.star;
        document.getElementById('bulkTagIcon').innerHTML = icons.tag;
        document.getElementById('bulkDeleteIcon').innerHTML = icons.trash;
        document.getElementById('bulkSelectIcon').innerHTML = icons.checkSquare;
        document.getElementById('bulkCloseIcon').innerHTML = icons.close;
        // AI icons
        document.getElementById('settingsIcon').innerHTML = icons.settings;
        document.getElementById('settingsModalIcon').innerHTML = icons.sparkles;
        document.getElementById('closeSettingsIcon').innerHTML = icons.close;
        document.getElementById('aiIcon').innerHTML = icons.sparkles;
        document.getElementById('searchModeTextIcon').innerHTML = icons.search;
        document.getElementById('searchModeSemanticIcon').innerHTML = icons.brain;
        document.getElementById('searchModeSymbolIcon').innerHTML = icons.terminal;
        // Export/Import icons
        document.getElementById('exportIcon').innerHTML = icons.download;
        document.getElementById('importIcon').innerHTML = icons.upload;
        // Chat icons
        document.getElementById('chatBtnIcon').innerHTML = icons.hippoAI;
        // Chat window icons
        document.getElementById('chatBubbleIcon').innerHTML = icons.hippoAI;
        document.getElementById('chatHeaderIcon').innerHTML = icons.hippoAI;
        document.getElementById('chatSettingsIcon').innerHTML = icons.settings;
        document.getElementById('chatClearIcon').innerHTML = icons.trash;
        document.getElementById('chatMinimizeIcon').innerHTML = icons.close;
        document.getElementById('contextIcon').innerHTML = icons.file;
        document.getElementById('ctxAnalyzeIcon').innerHTML = icons.eye;
        document.getElementById('ctxSummarizeIcon').innerHTML = icons.doc;
        document.getElementById('attachIcon').innerHTML = icons.file;
        document.getElementById('welcomeIcon').innerHTML = icons.hippoAI;
        document.getElementById('capLocal').innerHTML = icons.zap;
        document.getElementById('capPrivate').innerHTML = icons.eye;
        document.getElementById('capFast').innerHTML = icons.zap;
        document.getElementById('qaSum').innerHTML = icons.doc;
        document.getElementById('qaDup').innerHTML = icons.memory;
        document.getElementById('qaOrg').innerHTML = icons.organize;
        document.getElementById('qaInsight').innerHTML = icons.brain;
        document.getElementById('qaCode').innerHTML = icons.code;
        document.getElementById('qaSearch').innerHTML = icons.search;
        document.getElementById('aiProgressIcon').innerHTML = icons.refresh;
        document.getElementById('sendIcon').innerHTML = icons.send;
        document.getElementById('ollamaStatusIcon').innerHTML = icons.checkCircle;
        // AI Action icons
        document.getElementById('suggestTagsIcon').innerHTML = icons.tag;
        document.getElementById('findSimilarIcon').innerHTML = icons.file;
        document.getElementById('smartRenameIcon').innerHTML = icons.doc;
        document.getElementById('askAboutIcon').innerHTML = icons.messageCircle;
        // Filter icons
        document.querySelectorAll('.filter-icon').forEach(function(el) {
          var iconName = el.dataset.icon;
          if (icons[iconName]) el.innerHTML = icons[iconName];
        });
      }
      initIcons();

      // Command definitions
      var commands = [
        { id: 'add-folder', title: 'Add Folder', desc: 'Index a new folder', icon: 'folderPlus', shortcut: ['', 'O'], action: 'addFolder' },
        { id: 'toggle-dark', title: 'Toggle Dark Mode', desc: 'Switch between light and dark themes', icon: 'moon', shortcut: ['', 'D'], action: 'toggleDark' },
        { id: 'grid-view', title: 'Grid View', desc: 'Display files as grid', icon: 'grid', action: 'gridView' },
        { id: 'list-view', title: 'List View', desc: 'Display files as list', icon: 'list', action: 'listView' },
        { id: 'graph-view', title: 'Graph View', desc: 'Visualize connections between files', icon: 'graph', shortcut: ['', 'G'], action: 'graphView' },
        { id: 'show-all', title: 'Show All Files', desc: 'Clear filters and show all', icon: 'eye', action: 'showAll' },
        { id: 'show-images', title: 'Show Images', desc: 'Filter to images only', icon: 'image', action: 'filterImages' },
        { id: 'show-videos', title: 'Show Videos', desc: 'Filter to videos only', icon: 'video', action: 'filterVideos' },
        { id: 'show-audio', title: 'Show Audio', desc: 'Filter to audio only', icon: 'audio', action: 'filterAudio' },
        { id: 'show-code', title: 'Show Code', desc: 'Filter to code files only', icon: 'code', action: 'filterCode' },
        { id: 'show-docs', title: 'Show Documents', desc: 'Filter to documents only', icon: 'doc', action: 'filterDocs' },
        { id: 'show-favorites', title: 'Show Favorites', desc: 'Show starred files', icon: 'star', action: 'filterFavorites' },
        { id: 'refresh', title: 'Refresh', desc: 'Reload files and tags', icon: 'refresh', shortcut: ['', 'R'], action: 'refresh' },
        { id: 'reset-index', title: 'Reset Index', desc: 'Delete all indexed data', icon: 'trash', action: 'resetIndex' },
        { id: 'focus-search', title: 'Focus Search', desc: 'Jump to search input', icon: 'search', shortcut: ['', 'F'], action: 'focusSearch' }
      ];

      // Command palette functions
      function openCommandPalette() {
        document.getElementById('cmdOverlay').classList.add('open');
        document.getElementById('cmdInput').value = '';
        document.getElementById('cmdInput').focus();
        cmdSelectedIndex = 0;
        cmdMode = 'commands';
        renderCommandPalette('');
      }

      function closeCommandPalette() {
        document.getElementById('cmdOverlay').classList.remove('open');
        document.getElementById('cmdInput').value = '';
      }

      function renderCommandPalette(query) {
        var body = document.getElementById('cmdBody');
        query = query.toLowerCase().trim();

        // If query starts with >, show only commands
        // If query starts with @, show files
        // Otherwise show both
        var showCommands = true;
        var showFiles = true;
        var searchQuery = query;

        if (query.startsWith('>')) {
          showCommands = true;
          showFiles = false;
          searchQuery = query.substring(1).trim();
          cmdMode = 'commands';
        } else if (query.startsWith('@')) {
          showCommands = false;
          showFiles = true;
          searchQuery = query.substring(1).trim();
          cmdMode = 'files';
        }

        var html = '';
        cmdItems = [];

        // Filter and show commands
        if (showCommands) {
          var filteredCmds = commands.filter(function(cmd) {
            return searchQuery === '' ||
              cmd.title.toLowerCase().includes(searchQuery) ||
              cmd.desc.toLowerCase().includes(searchQuery);
          });

          if (filteredCmds.length > 0) {
            html += '<div class="cmd-section">';
            html += '<div class="cmd-section-title">Commands</div>';
            filteredCmds.forEach(function(cmd, i) {
              cmdItems.push({ type: 'command', data: cmd });
              var selected = cmdItems.length - 1 === cmdSelectedIndex ? ' selected' : '';
              html += '<div class="cmd-item' + selected + '" data-idx="' + (cmdItems.length - 1) + '">';
              html += '<span class="icon icon-md">' + icons[cmd.icon] + '</span>';
              html += '<div class="cmd-item-content">';
              html += '<div class="cmd-item-title">' + esc(cmd.title) + '</div>';
              html += '<div class="cmd-item-desc">' + esc(cmd.desc) + '</div>';
              html += '</div>';
              if (cmd.shortcut) {
                html += '<div class="cmd-item-shortcut">';
                cmd.shortcut.forEach(function(k) {
                  html += '<span class="cmd-key">' + k + '</span>';
                });
                html += '</div>';
              }
              html += '</div>';
            });
            html += '</div>';
          }
        }

        // Filter and show files
        if (showFiles && memories.length > 0) {
          var filteredFiles = memories.filter(function(mem) {
            if (searchQuery === '') return true;
            var title = (mem.metadata && mem.metadata.title) || mem.path.split('/').pop();
            return title.toLowerCase().includes(searchQuery) || mem.path.toLowerCase().includes(searchQuery);
          }).slice(0, 10);

          if (filteredFiles.length > 0) {
            html += '<div class="cmd-section">';
            html += '<div class="cmd-section-title">Files</div>';
            filteredFiles.forEach(function(mem) {
              cmdItems.push({ type: 'file', data: mem });
              var selected = cmdItems.length - 1 === cmdSelectedIndex ? ' selected' : '';
              var title = (mem.metadata && mem.metadata.title) || mem.path.split('/').pop();
              var iconName = 'file';
              if (mem.kind) {
                if (mem.kind.Image) iconName = 'image';
                else if (mem.kind.Video) iconName = 'video';
                else if (mem.kind.Audio) iconName = 'audio';
                else if (mem.kind.Code) iconName = 'code';
                else if (mem.kind.Document) iconName = 'doc';
              }
              html += '<div class="cmd-item' + selected + '" data-idx="' + (cmdItems.length - 1) + '">';
              html += '<span class="icon icon-md">' + icons[iconName] + '</span>';
              html += '<div class="cmd-item-content">';
              html += '<div class="cmd-item-title">' + esc(title) + '</div>';
              html += '<div class="cmd-item-desc">' + esc(mem.path) + '</div>';
              html += '</div>';
              html += '</div>';
            });
            html += '</div>';
          }
        }

        if (html === '') {
          html = '<div class="cmd-empty"><span class="icon icon-xl">' + icons.search + '</span><div>No results found</div></div>';
        }

        body.innerHTML = html;

        // Bind click events
        document.querySelectorAll('.cmd-item').forEach(function(el) {
          el.onclick = function() {
            var idx = parseInt(el.dataset.idx);
            executeCommandItem(cmdItems[idx]);
          };
        });
      }

      function executeCommandItem(item) {
        closeCommandPalette();
        if (item.type === 'command') {
          executeCommand(item.data.action);
        } else if (item.type === 'file') {
          selectMemory(item.data);
        }
      }

      function executeCommand(action) {
        switch (action) {
          case 'addFolder':
            document.getElementById('addBtn').click();
            break;
          case 'toggleDark':
            document.getElementById('darkModeBtn').click();
            break;
          case 'gridView':
            document.getElementById('gridViewBtn').click();
            break;
          case 'listView':
            document.getElementById('listViewBtn').click();
            break;
          case 'graphView':
            document.getElementById('graphViewBtn').click();
            break;
          case 'showAll':
            setFilter('all');
            break;
          case 'filterImages':
            setFilter('image');
            break;
          case 'filterVideos':
            setFilter('video');
            break;
          case 'filterAudio':
            setFilter('audio');
            break;
          case 'filterCode':
            setFilter('code');
            break;
          case 'filterDocs':
            setFilter('document');
            break;
          case 'filterFavorites':
            setFilter('favorites');
            break;
          case 'refresh':
            if (typeof loadData === 'function') loadData();
            showToast('Refreshed', 'success');
            break;
          case 'resetIndex':
            document.getElementById('resetBtn').click();
            break;
          case 'focusSearch':
            document.getElementById('searchInput').focus();
            break;
        }
      }

      function setFilter(type) {
        filterType = type;
        document.querySelectorAll('.filter-btn').forEach(function(b) {
          b.classList.toggle('active', b.dataset.filter === type);
        });
        renderFiles();
      }

      // Command palette keyboard events
      document.getElementById('cmdInput').addEventListener('input', function(e) {
        cmdSelectedIndex = 0;
        renderCommandPalette(e.target.value);
      });

      document.getElementById('cmdInput').addEventListener('keydown', function(e) {
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          cmdSelectedIndex = Math.min(cmdSelectedIndex + 1, cmdItems.length - 1);
          renderCommandPalette(e.target.value);
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          cmdSelectedIndex = Math.max(cmdSelectedIndex - 1, 0);
          renderCommandPalette(e.target.value);
        } else if (e.key === 'Enter') {
          e.preventDefault();
          if (cmdItems[cmdSelectedIndex]) {
            executeCommandItem(cmdItems[cmdSelectedIndex]);
          }
        } else if (e.key === 'Escape') {
          closeCommandPalette();
        }
      });

      document.getElementById('cmdOverlay').addEventListener('click', function(e) {
        if (e.target === this) closeCommandPalette();
      });

      function showToast(msg, type) {
        var container = document.getElementById('toastContainer');
        var toast = document.createElement('div');
        toast.className = 'toast' + (type ? ' ' + type : '');
        toast.textContent = msg;
        container.appendChild(toast);
        setTimeout(function() { toast.remove(); }, 3000);
      }

      function waitForTauri(cb) {
        var n = 0;
        function check() {
          if (window.__TAURI__ && window.__TAURI__.core) {
            cb();
          } else if (++n < 50) {
            setTimeout(check, 100);
          }
        }
        check();
      }

      waitForTauri(function() {
        invoke = window.__TAURI__.core.invoke;
        convertFileSrc = window.__TAURI__.core.convertFileSrc;

        // Initialize virtual scroller
        var filesContainer = document.getElementById('filesContainer');
        var scrollParent = document.querySelector('.content');
        if (filesContainer && scrollParent) {
          virtualScroller.init(filesContainer, scrollParent);
        }

        invoke('initialize').then(function() {
          loadData();
        }).catch(function(e) {
          showToast('Init failed: ' + e, 'error');
        });

        function loadData() {
          // Show skeleton loading
          showLoadingSkeletons();

          Promise.all([
            invoke('get_stats'),
            invoke('get_sources'),
            invoke('get_tags'),
            invoke('search', { query: '', tags: [] }),
            invoke('list_collections').catch(function() { return []; }),
            invoke('get_qdrant_stats').catch(function() { return { available: false }; }),
            invoke('ollama_status').catch(function() { return { available: false }; })
          ]).then(function(r) {
            document.getElementById('statsText').textContent = (r[0] ? r[0].total_memories : 0) + ' memories';
            sources = r[1] || [];
            allTags = r[2] || [];
            memories = (r[3].memories || []).map(function(x) { return x.memory; });
            collections = r[4] || [];
            qdrantAvailable = r[5] && r[5].available;
            qdrantVectorCount = (r[5] && r[5].total_vectors) || 0;
            ollamaAvailable = r[6] && r[6].available;

            // Update status indicators
            updateStatusIndicators();

            renderSources();
            renderTagBar();
            renderFiles();
            renderCollections();
          }).catch(function(e) {
            showToast('Load failed: ' + e, 'error');
            renderFiles(); // Show empty state on error
          });
        }

        var searchDebounceTimer = null;
        function search(query) {
          // Show subtle loading state for search
          document.getElementById('resultCount').textContent = 'Searching...';

          invoke('search', { query: query || '', tags: activeTags }).then(function(r) {
            memories = (r.memories || []).map(function(x) { return x.memory; });
            renderFiles();
            if (query && query.trim()) { addToHistory(query, memories.length); }
            var saveBtn = document.getElementById('saveSearchBtn');
            if (saveBtn) { saveBtn.style.display = (query && query.trim()) ? 'flex' : 'none'; }
          });
        }

        function addToHistory(query, count) {
          if (!query || query.trim() === '') return;
          var timestamp = new Date().toISOString();
          var entry = { query: query.trim(), count: count, timestamp: timestamp };
          recentSearches = recentSearches.filter(function(item) { return item.query !== entry.query; });
          recentSearches.unshift(entry);
          if (recentSearches.length > 20) recentSearches = recentSearches.slice(0, 20);
          localStorage.setItem('hippo-recent-searches', JSON.stringify(recentSearches));
        }
        function removeFromHistory(index) {
          recentSearches.splice(index, 1);
          localStorage.setItem('hippo-recent-searches', JSON.stringify(recentSearches));
          renderSearchDropdown();
        }
        function clearHistory() {
          recentSearches = [];
          localStorage.setItem('hippo-recent-searches', JSON.stringify(recentSearches));
          renderSearchDropdown();
        }
        function saveSearch(name, query) {
          if (!name || !query) return;
          var count = getFiltered().length;
          var entry = { name: name.trim(), query: query.trim(), count: count };
          savedSearches = savedSearches.filter(function(item) { return item.name !== entry.name; });
          savedSearches.push(entry);
          localStorage.setItem('hippo-saved-searches', JSON.stringify(savedSearches));
          renderSearchDropdown();
          showToast('Search saved as "' + name + '"', 'success');
        }
        function removeSavedSearch(index) {
          var name = savedSearches[index].name;
          savedSearches.splice(index, 1);
          localStorage.setItem('hippo-saved-searches', JSON.stringify(savedSearches));
          renderSearchDropdown();
          showToast('Removed "' + name + '"', 'info');
        }
        function runSavedSearch(query) {
          document.getElementById('searchInput').value = query;
          search(query);
          hideSearchDropdown();
        }
        function showSearchDropdown() {
          showRecentSearches = true;
          renderSearchDropdown();
        }
        function hideSearchDropdown() {
          showRecentSearches = false;
          document.getElementById('recentSearchesDropdown').classList.remove('show');
        }
        function renderSearchDropdown() {
          var dropdown = document.getElementById('recentSearchesDropdown');
          if (!dropdown) return;
          if (!showRecentSearches || (recentSearches.length === 0 && savedSearches.length === 0)) { dropdown.classList.remove('show'); return; }
          var html = '';
          if (savedSearches.length > 0) {
            html += '<div class="search-dropdown-section"><div class="search-dropdown-header">Saved Searches</div>';
            savedSearches.forEach(function(item, idx) {
              html += '<div class="saved-search-item" onclick="runSavedSearch(\'' + escapeHtml(item.query) + '\')">';
              html += '<span class="icon icon-sm saved-search-icon">&#128278;</span>';
              html += '<div style="flex:1;min-width:0;"><div class="saved-search-name">' + escapeHtml(item.name) + '</div>';
              html += '<div class="saved-search-query">' + escapeHtml(item.query) + ' (' + item.count + ' files)</div></div>';
              html += '<button class="recent-search-remove" onclick="event.stopPropagation();removeSavedSearch(' + idx + ')" title="Remove"><span class="icon icon-sm">&#10005;</span></button></div>';
            });
            html += '</div>';
          }
          if (recentSearches.length > 0) {
            html += '<div class="search-dropdown-section"><div class="search-dropdown-header">Recent Searches<button class="search-dropdown-clear" onclick="clearHistory()">Clear All</button></div>';
            recentSearches.forEach(function(item, idx) {
              var timeAgo = getTimeAgo(item.timestamp);
              html += '<div class="recent-search-item" onclick="runSavedSearch(\'' + escapeHtml(item.query) + '\')">';
              html += '<span class="icon icon-sm recent-search-icon">&#128336;</span><div class="recent-search-text">' + escapeHtml(item.query) + '</div>';
              html += '<div class="recent-search-meta"><span class="recent-search-count">' + item.count + '</span><span class="recent-search-time">' + timeAgo + '</span></div>';
              html += '<button class="recent-search-remove" onclick="event.stopPropagation();removeFromHistory(' + idx + ')" title="Remove"><span class="icon icon-sm">&#10005;</span></button></div>';
            });
            html += '</div>';
          }
          dropdown.innerHTML = html;
          dropdown.classList.add('show');
        }
        function getTimeAgo(timestamp) {
          var now = new Date();
          var then = new Date(timestamp);
          var seconds = Math.floor((now - then) / 1000);
          if (seconds < 60) return 'just now';
          if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
          if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
          if (seconds < 604800) return Math.floor(seconds / 86400) + 'd ago';
          return Math.floor(seconds / 604800) + 'w ago';
        }
        function escapeHtml(text) {
          var div = document.createElement('div');
          div.textContent = text;
          return div.innerHTML;
        }
        function promptSaveSearch() {
          var query = document.getElementById('searchInput').value.trim();
          if (!query) { showToast('Enter a search query first', 'info'); return; }
          var name = prompt('Name this search:', query);
          if (name) saveSearch(name, query);
        }

        function updateStatusIndicators() {
          var qdrantDot = document.getElementById('qdrantDot');
          var ollamaDot = document.getElementById('ollamaDot');

          if (qdrantDot) {
            qdrantDot.className = 'status-dot ' + (qdrantAvailable ? 'online' : 'offline');
          }
          if (ollamaDot) {
            ollamaDot.className = 'status-dot ' + (ollamaAvailable ? 'online' : 'offline');
          }
        }

        function renderSources() {
          var html = '';
          sources.forEach(function(s) {
            var path = s.source && s.source.Local ? s.source.Local.root_path : '';
            var name = path.split('/').pop() || 'Local';
            html += '<div class="source-item" onclick="window.openInFinder(\'' + esc(path).replace(/'/g, "\\'") + '\')">';
            html += '<span class="source-dot"></span>';
            html += '<span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + esc(name) + '</span>';
            html += '</div>';
          });
          document.getElementById('sourcesList').innerHTML = html;
        }

        function renderTagBar() {
          if (allTags.length === 0) {
            document.getElementById('tagBar').innerHTML = '';
            return;
          }
          var html = '<span class="tag-label">Tags:</span>';
          allTags.slice(0, 8).forEach(function(t) {
            var isActive = activeTags.indexOf(t[0]) !== -1;
            html += '<button class="tag-btn' + (isActive ? ' active' : '') + '" data-tag="' + esc(t[0]) + '">' + esc(t[0]) + ' (' + t[1] + ')</button>';
          });
          document.getElementById('tagBar').innerHTML = html;
          document.querySelectorAll('.tag-btn').forEach(function(btn) {
            btn.onclick = function() {
              var tag = btn.dataset.tag;
              if (activeTags.indexOf(tag) === -1) {
                activeTags.push(tag);
              } else {
                activeTags = activeTags.filter(function(t) { return t !== tag; });
              }
              renderActiveTags();
              renderTagBar();
              search(document.getElementById('searchInput').value);
            };
          });
        }

        function renderActiveTags() {
          var html = '';
          activeTags.forEach(function(tag) {
            html += '<span class="active-tag">' + esc(tag) + '<button data-tag="' + esc(tag) + '">&times;</button></span>';
          });
          document.getElementById('activeTags').innerHTML = html;
          document.querySelectorAll('.active-tag button').forEach(function(btn) {
            btn.onclick = function(e) {
              e.stopPropagation();
              var tag = btn.dataset.tag;
              activeTags = activeTags.filter(function(t) { return t !== tag; });
              renderActiveTags();
              renderTagBar();
              search(document.getElementById('searchInput').value);
            };
          });
        }

        function renderCollections() {
          var container = document.getElementById('collectionsSection');
          if (!container) return;

          if (collections.length === 0) {
            container.innerHTML = '<div class="section-title">COLLECTIONS</div><p style="font-size:12px;color:#a8a29e;padding:8px 12px;">No collections yet</p>';
            return;
          }

          var html = '<div class="section-title">COLLECTIONS</div>';
          collections.forEach(function(c) {
            var count = c.memory_ids ? c.memory_ids.length : 0;
            html += '<div class="source-item collection-item" data-collection="' + c.id + '">';
            html += '<span class="icon icon-sm" style="color:#8b5cf6;">' + icons.folder + '</span>';
            html += '<span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + esc(c.name) + '</span>';
            html += '<span style="font-size:11px;color:#a8a29e;">' + count + '</span>';
            html += '</div>';
          });
          container.innerHTML = html;

          document.querySelectorAll('.collection-item').forEach(function(item) {
            item.onclick = function() {
              var colId = item.dataset.collection;
              filterByCollection(colId);
            };
          });
        }

        function filterByCollection(collectionId) {
          var col = collections.find(function(c) { return c.id === collectionId; });
          if (!col || !col.memory_ids) return;

          memories = memories.filter(function(m) {
            return col.memory_ids.indexOf(m.id) !== -1;
          });
          renderFiles();
          showToast('Filtered to "' + col.name + '"', 'success');
        }

        function loadVirtualPaths(memoryId) {
          invoke('get_virtual_paths', { memoryId: memoryId }).then(function(paths) {
            virtualPaths = paths || [];
            renderVirtualPaths();
          }).catch(function() {
            virtualPaths = [];
          });
        }

        function loadSimilarMemories(memoryId) {
          invoke('find_similar_memories', { memoryId: memoryId, limit: 5 }).then(function(results) {
            similarMemories = results || [];
            renderSimilarMemories();
          }).catch(function() {
            similarMemories = [];
          });
        }

        function renderVirtualPaths() {
          var container = document.getElementById('virtualPathsSection');
          if (!container) return;

          if (virtualPaths.length === 0) {
            container.innerHTML = '';
            return;
          }

          var html = '<div class="detail-section"><h4>Virtual Paths</h4>';
          virtualPaths.forEach(function(vp) {
            html += '<div class="virtual-path" style="font-size:12px;padding:4px 0;color:#57534e;">';
            html += '<span class="icon icon-sm" style="margin-right:4px;">' + icons.folder + '</span>';
            html += esc(vp.path);
            html += ' <span style="color:#a8a29e;">(' + Math.round(vp.confidence * 100) + '%)</span>';
            html += '</div>';
          });
          html += '</div>';
          container.innerHTML = html;
        }

        function renderSimilarMemories() {
          var container = document.getElementById('similarSection');
          if (!container) return;

          if (similarMemories.length === 0) {
            container.innerHTML = '';
            return;
          }

          var html = '<div class="detail-section"><h4>Similar Files</h4>';
          similarMemories.forEach(function(item) {
            var mem = item.memory;
            var score = Math.round((item.similarity || 0) * 100);
            var name = mem.path.split('/').pop();
            html += '<div class="similar-item" style="font-size:12px;padding:4px 0;cursor:pointer;" data-id="' + mem.id + '">';
            html += '<span class="icon icon-sm" style="margin-right:4px;">' + getTypeIcon(getType(mem.kind)) + '</span>';
            html += esc(name);
            html += ' <span style="color:#a8a29e;">(' + score + '% match)</span>';
            html += '</div>';
          });
          html += '</div>';
          container.innerHTML = html;

          document.querySelectorAll('.similar-item').forEach(function(item) {
            item.onclick = function() {
              var memId = item.dataset.id;
              var mem = memories.find(function(m) { return m.id === memId; });
              if (mem) selectMemory(mem);
            };
          });
        }

        function discoverCollections() {
          showToast('Discovering collections...', 'info');
          invoke('discover_collections').then(function(newCols) {
            collections = collections.concat(newCols || []);
            renderCollections();
            showToast('Discovered ' + (newCols ? newCols.length : 0) + ' collections', 'success');
          }).catch(function(e) {
            showToast('Discovery failed: ' + e, 'error');
          });
        }

        function getFiltered() {
          var filtered = memories;
          if (filterType === 'favorites') {
            filtered = memories.filter(function(m) { return m.is_favorite; });
          } else if (filterType !== 'all') {
            filtered = memories.filter(function(m) { return getType(m.kind) === filterType; });
          }
          // Apply date filter
          if (dateFilter !== 'all') {
            var now = new Date();
            var cutoff;
            if (dateFilter === 'today') {
              cutoff = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            } else if (dateFilter === 'week') {
              cutoff = new Date(now - 7 * 24 * 60 * 60 * 1000);
            } else if (dateFilter === 'month') {
              cutoff = new Date(now - 30 * 24 * 60 * 60 * 1000);
            }
            if (cutoff) {
              filtered = filtered.filter(function(m) {
                var mDate = new Date(m.modified_at || m.created_at);
                return mDate >= cutoff;
              });
            }
          }
          return filtered;
        }

        function getDisplayedMemories() {
          return getFiltered();
        }

        // Keyboard navigation helpers
        function handleArrowNavigation(key) {
          var displayed = getDisplayedMemories();
          if (displayed.length === 0) return;

          var cols = 1;
          if (viewMode === 'grid') {
            var container = document.getElementById('filesContainer');
            var grid = container.querySelector('.grid');
            if (grid) {
              var gridWidth = grid.offsetWidth;
              cols = Math.floor(gridWidth / 220) || 1; // Approx card width
            }
          }

          var newIndex = keyboardFocusIndex;
          if (key === 'ArrowRight') {
            newIndex = Math.min(displayed.length - 1, newIndex + 1);
          } else if (key === 'ArrowLeft') {
            newIndex = Math.max(0, newIndex - 1);
          } else if (key === 'ArrowDown') {
            newIndex = Math.min(displayed.length - 1, newIndex + (viewMode === 'grid' ? cols : 1));
          } else if (key === 'ArrowUp') {
            newIndex = Math.max(0, newIndex - (viewMode === 'grid' ? cols : 1));
          }

          if (keyboardFocusIndex === -1) newIndex = 0;
          keyboardFocusIndex = newIndex;
          updateKeyboardFocus();
        }

        function updateKeyboardFocus() {
          // Remove previous focus
          document.querySelectorAll('.keyboard-focused').forEach(function(el) {
            el.classList.remove('keyboard-focused');
          });

          if (keyboardFocusIndex < 0) return;

          var selector = viewMode === 'grid' ? '.card' : '.list-item';
          var items = document.querySelectorAll(selector);
          if (items[keyboardFocusIndex]) {
            items[keyboardFocusIndex].classList.add('keyboard-focused');
            items[keyboardFocusIndex].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          }
        }

        // Render skeleton loading cards
        function renderSkeletons(count) {
          var html = '';
          if (viewMode === 'grid') {
            html = '<div class="grid">';
            for (var i = 0; i < count; i++) {
              html += '<div class="skeleton-card" style="animation-delay:' + (i * 50) + 'ms">';
              html += '<div class="skeleton-preview"></div>';
              html += '<div class="skeleton-info"><div class="skeleton-title"></div><div class="skeleton-size"></div></div>';
              html += '</div>';
            }
            html += '</div>';
          } else {
            html = '<div class="list">';
            for (var i = 0; i < count; i++) {
              html += '<div class="skeleton-list-item" style="animation-delay:' + (i * 30) + 'ms">';
              html += '<div class="skeleton-thumb"></div>';
              html += '<div class="skeleton-info"><div class="skeleton-title-line"></div><div class="skeleton-path-line"></div></div>';
              html += '</div>';
            }
            html += '</div>';
          }
          return html;
        }

        // Show loading skeletons
        function showLoadingSkeletons() {
          document.getElementById('filesContainer').innerHTML = renderSkeletons(12);
        }

        function renderFiles() {
          var filtered = getFiltered();
          document.getElementById('resultCount').textContent = filtered.length + ' files';

          if (filtered.length === 0) {
            var emptyHtml = '<div class="empty">';
            emptyHtml += '<div class="empty-mascot"></div>';
            emptyHtml += '<div class="empty-title">' + (sources.length === 0 ? 'Welcome to Hippo!' : 'No files found') + '</div>';
            emptyHtml += '<div class="empty-text">' + (sources.length === 0 ? 'Add a folder and I\\'ll remember every file for you!' : 'Try a different search or filter') + '</div>';
            if (sources.length === 0) {
              emptyHtml += '<div class="empty-action"><button class="empty-action-btn" onclick="addSource()"><span class="icon icon-sm">' + icons.plus + '</span> Add Folder</button></div>';
            }
            emptyHtml += '</div>';
            document.getElementById('filesContainer').innerHTML = emptyHtml;
            return;
          }

          // Handle graph view
          if (viewMode === 'graph') {
            renderGraphView(filtered);
            return;
          }

          // Use virtual scrolling for large lists (>100 items)
          if (filtered.length > 100) {
            virtualScroller.setItems(filtered, viewMode);
          } else {
            // For small lists, render normally for simplicity
            var html = '';
            if (viewMode === 'grid') {
              html = '<div class="grid">';
              filtered.forEach(function(mem, i) {
                html += renderCard(mem, i);
              });
              html += '</div>';
            } else {
              html = '<div class="list">';
              filtered.forEach(function(mem, i) {
                html += renderListItem(mem, i);
              });
              html += '</div>';
            }

            document.getElementById('filesContainer').innerHTML = html;
            bindCardEvents();
          }
        }

        function renderCard(mem, idx) {
          var title = (mem.metadata && mem.metadata.title) || mem.path.split('/').pop();
          var color = getColor(mem.kind);
          var type = getType(mem.kind);
          var isFav = mem.is_favorite;
          var isSelected = selectedIds.indexOf(mem.id) !== -1;

          var html = '<div class="card' + (isSelected ? ' selected' : '') + '" data-idx="' + idx + '" data-id="' + mem.id + '">';
          html += '<div class="card-checkbox' + (isSelected ? ' checked visible' : '') + (selectedIds.length > 0 || isMultiSelectMode ? ' visible' : '') + '" data-id="' + mem.id + '" data-idx="' + idx + '">';
          html += '<span class="icon icon-sm">' + icons.check + '</span>';
          html += '</div>';
          html += '<div class="card-preview" style="background:' + color + '">';
          if ((type === 'image' || type === 'video') && convertFileSrc) {
            // Use thumbnail for images and videos (loaded async)
            var thumbSrc = thumbnailCache[mem.path];
            if (thumbSrc) {
              html += '<img src="' + convertFileSrc(thumbSrc) + '" onload="this.classList.add(\'loaded\')" onerror="this.style.display=\'none\'" loading="lazy">';
            } else {
              // Show placeholder, thumbnail will load async (hidden via CSS opacity)
              html += '<img class="thumb-pending" data-path="' + esc(mem.path) + '" loading="lazy">';
            }
          }
          html += getIcon(mem.kind, 'xl');
          html += '</div>';
          html += '<button class="card-star' + (isFav ? ' active' : '') + '" data-id="' + mem.id + '"><span class="icon icon-sm">' + (isFav ? icons.starFilled : icons.star) + '</span></button>';
          html += '<div class="card-info">';
          html += '<div class="card-title">' + esc(title) + '</div>';
          html += '<div class="card-size">' + formatSize(mem.metadata ? mem.metadata.file_size : 0) + '</div>';
          html += '</div></div>';
          return html;
        }

        function renderListItem(mem, idx) {
          var title = (mem.metadata && mem.metadata.title) || mem.path.split('/').pop();
          var color = getColor(mem.kind);
          var type = getType(mem.kind);
          var isSelected = selectedIds.indexOf(mem.id) !== -1;

          var html = '<div class="list-item' + (isSelected ? ' selected' : '') + '" data-idx="' + idx + '" data-id="' + mem.id + '">';
          html += '<div class="list-checkbox' + (isSelected ? ' checked visible' : '') + (selectedIds.length > 0 || isMultiSelectMode ? ' visible' : '') + '" data-id="' + mem.id + '" data-idx="' + idx + '">';
          html += '<span class="icon icon-sm">' + icons.check + '</span>';
          html += '</div>';
          html += '<div class="list-thumb" style="background:' + color + '">';
          if ((type === 'image' || type === 'video') && convertFileSrc) {
            var thumbSrc = thumbnailCache[mem.path];
            if (thumbSrc) {
              html += '<img src="' + convertFileSrc(thumbSrc) + '" onload="this.classList.add(\'loaded\')" onerror="this.style.display=\'none\'" loading="lazy">';
            } else {
              html += '<img class="thumb-pending" data-path="' + esc(mem.path) + '" loading="lazy">';
            }
          }
          html += getIcon(mem.kind, 'lg');
          html += '</div>';
          html += '<div class="list-info">';
          html += '<div class="list-title">' + esc(title) + '</div>';
          html += '<div class="list-path">' + esc(mem.path) + '</div>';
          html += '</div>';
          html += '<div class="list-meta">';
          html += '<div class="list-size">' + formatSize(mem.metadata ? mem.metadata.file_size : 0) + '</div>';
          html += '<div class="list-type">' + getTypeName(mem.kind).split(' ')[0] + '</div>';
          html += '</div></div>';
          return html;
        }

        // Load thumbnails for pending images
        function loadThumbnails() {
          var pending = document.querySelectorAll('.thumb-pending');
          pending.forEach(function(img) {
            var path = img.dataset.path;
            if (!path || thumbnailPending[path]) return;

            // Already cached
            if (thumbnailCache[path]) {
              img.src = convertFileSrc(thumbnailCache[path]);
              img.style.display = '';
              img.classList.remove('thumb-pending');
              // Smooth fade-in after image loads
              img.onload = function() { img.classList.add('loaded'); };
              return;
            }

            // Mark as pending to avoid duplicate requests
            thumbnailPending[path] = true;

            // Request thumbnail from backend
            invoke('get_thumbnail', { path: path }).then(function(thumbPath) {
              thumbnailCache[path] = thumbPath;
              thumbnailPending[path] = false;

              // Update all images with this path
              document.querySelectorAll('img[data-path="' + CSS.escape(path) + '"]').forEach(function(el) {
                el.src = convertFileSrc(thumbPath);
                el.style.display = '';
                el.classList.remove('thumb-pending');
                // Smooth fade-in after image loads
                el.onload = function() { el.classList.add('loaded'); };
              });
            }).catch(function(e) {
              thumbnailPending[path] = false;
              // Fallback to original image if thumbnail fails
              document.querySelectorAll('img[data-path="' + CSS.escape(path) + '"]').forEach(function(el) {
                el.src = convertFileSrc(path);
                el.style.display = '';
                el.classList.remove('thumb-pending');
                el.onload = function() { el.classList.add('loaded'); };
              });
            });
          });
        }

        function bindCardEvents() {
          // Load thumbnails after rendering
          setTimeout(loadThumbnails, 50);

          // Checkbox click handlers
          document.querySelectorAll('.card-checkbox, .list-checkbox').forEach(function(cb) {
            cb.onclick = function(e) {
              e.stopPropagation();
              var id = cb.dataset.id;
              var idx = parseInt(cb.dataset.idx);

              // Shift+click for range selection
              if (e.shiftKey && lastSelectedIdx !== -1) {
                var filtered = getFiltered();
                var start = Math.min(lastSelectedIdx, idx);
                var end = Math.max(lastSelectedIdx, idx);
                for (var i = start; i <= end; i++) {
                  var memId = filtered[i].id;
                  if (selectedIds.indexOf(memId) === -1) {
                    selectedIds.push(memId);
                  }
                }
              } else {
                // Toggle single selection
                var pos = selectedIds.indexOf(id);
                if (pos === -1) {
                  selectedIds.push(id);
                } else {
                  selectedIds.splice(pos, 1);
                }
              }

              lastSelectedIdx = idx;
              updateBulkBar();
              renderFiles();
            };
          });

          // Card/list item click
          document.querySelectorAll('.card, .list-item').forEach(function(el) {
            el.onclick = function(e) {
              if (e.target.classList.contains('card-star') ||
                  e.target.closest('.card-checkbox') ||
                  e.target.closest('.list-checkbox')) return;
              var idx = parseInt(el.dataset.idx);
              selectMemory(getFiltered()[idx]);
            };
          });

          document.querySelectorAll('.card-star').forEach(function(btn) {
            btn.onclick = function(e) {
              e.stopPropagation();
              toggleFavorite(btn.dataset.id);
            };
          });
        }

        // Bulk operations
        function updateBulkBar() {
          var bulkBar = document.getElementById('bulkBar');
          var bulkCount = document.getElementById('bulkCount');
          var bulkSelectText = document.getElementById('bulkSelectText');
          var filtered = getFiltered();

          if (selectedIds.length > 0) {
            bulkBar.classList.add('open');
            bulkCount.textContent = selectedIds.length + ' selected';

            // Update Select All button text
            if (selectedIds.length === filtered.length) {
              bulkSelectText.textContent = 'Deselect All';
            } else {
              bulkSelectText.textContent = 'Select All';
            }
          } else {
            bulkBar.classList.remove('open');
          }
          // Also update chat context bar if chat is open
          if (chatOpen) {
            updateChatContextBar();
          }
        }

        function clearSelection() {
          selectedIds = [];
          lastSelectedIdx = -1;
          updateBulkBar();
          renderFiles();
        }

        function selectAll() {
          var filtered = getFiltered();
          selectedIds = filtered.map(function(m) { return m.id; });
          updateBulkBar();
          renderFiles();
        }

        // ===== GRAPH VISUALIZATION FUNCTIONS =====
        function renderGraphView(memories) {
          var container = document.getElementById('filesContainer');

          // Create graph container HTML
          var html = '<div id="graphContainer">';
          html += '<div class="graph-toolbar">';
          html += '<button class="graph-toolbar-btn' + (graphMode === 'mindmap' ? ' active' : '') + '" onclick="switchGraphMode(\'mindmap\')">Mind Map</button>';
          html += '<button class="graph-toolbar-btn' + (graphMode === 'code' ? ' active' : '') + '" onclick="switchGraphMode(\'code\')">Code Graph</button>';
          html += '</div>';
          html += '<div class="graph-controls">';
          html += '<button class="graph-control-btn" onclick="zoomIn()" title="Zoom In"><span class="icon icon-sm">+</span></button>';
          html += '<button class="graph-control-btn" onclick="zoomOut()" title="Zoom Out"><span class="icon icon-sm">-</span></button>';
          html += '<button class="graph-control-btn" onclick="resetZoom()" title="Reset"><span class="icon icon-sm">' + icons.refresh + '</span></button>';
          html += '</div>';
          html += '<div id="graphSvg"></div>';
          html += '</div>';

          container.innerHTML = html;

          // If we have a selected memory and it's still in the filtered results, build mind map around it
          if (selectedMemory && memories.find(function(m) { return m.id === selectedMemory.id; })) {
            if (graphMode === 'mindmap') {
              buildMindMap(selectedMemory.id);
            } else {
              buildCodeGraph(memories);
            }
          } else if (memories.length > 0) {
            // Otherwise, build graph from available memories
            if (graphMode === 'code') {
              buildCodeGraph(memories);
            } else {
              // For mindmap, show a message to select a file
              showGraphEmptyState('Select a file to view its connections');
            }
          } else {
            showGraphEmptyState('No files to visualize');
          }
        }

        function showGraphEmptyState(message) {
          document.getElementById('graphSvg').innerHTML =
            '<div class="graph-empty">' +
            '<div class="graph-empty-icon">' + icons.graph + '</div>' +
            '<div class="graph-empty-title">Graph View</div>' +
            '<div class="graph-empty-text">' + message + '</div>' +
            '</div>';
        }

        function switchGraphMode(mode) {
          graphMode = mode;
          renderFiles();
        }

        function buildMindMap(memoryId) {
          // Call backend to get mind map data
          invoke('get_mind_map', { memoryId: memoryId, depth: 2 })
            .then(function(mindMap) {
              graphData = mindMap;
              renderMindMapD3(mindMap);
            })
            .catch(function(err) {
              console.error('Failed to build mind map:', err);
              showGraphEmptyState('Failed to load mind map: ' + err);
            });
        }

        function buildCodeGraph(memories) {
          // Filter code files only
          var codeFiles = memories.filter(function(m) {
            return m.kind && m.kind.Code;
          });

          if (codeFiles.length === 0) {
            showGraphEmptyState('No code files found. Switch to Mind Map mode or filter for code files.');
            return;
          }

          // Build a simple graph from code files
          // Create nodes from code files
          var nodes = codeFiles.map(function(mem) {
            var fileName = mem.path.split('/').pop();
            var lang = mem.kind.Code ? mem.kind.Code.language : 'unknown';
            return {
              id: mem.id,
              label: fileName,
              language: lang,
              lines: mem.kind.Code ? mem.kind.Code.lines : 0,
              path: mem.path,
              color: getCodeColor(lang)
            };
          });

          // Create edges based on imports (if available in metadata)
          var edges = [];
          codeFiles.forEach(function(mem) {
            if (mem.metadata && mem.metadata.code_info && mem.metadata.code_info.imports) {
              var sourceId = mem.id;
              mem.metadata.code_info.imports.forEach(function(imp) {
                // Try to find matching file
                var target = codeFiles.find(function(m) {
                  return m.path.includes(imp) || imp.includes(m.path.split('/').pop().replace(/\.\w+$/, ''));
                });
                if (target) {
                  edges.push({
                    source: sourceId,
                    target: target.id,
                    kind: 'imports'
                  });
                }
              });
            }
          });

          // Group by folder
          var folders = {};
          codeFiles.forEach(function(mem) {
            var parts = mem.path.split('/');
            var folder = parts.length > 1 ? parts[parts.length - 2] : 'root';
            if (!folders[folder]) folders[folder] = [];
            folders[folder].push(mem.id);
          });

          // Add same-folder edges
          Object.values(folders).forEach(function(fileIds) {
            if (fileIds.length > 1 && fileIds.length <= 5) {
              for (var i = 0; i < fileIds.length; i++) {
                for (var j = i + 1; j < fileIds.length; j++) {
                  edges.push({
                    source: fileIds[i],
                    target: fileIds[j],
                    kind: 'same_folder'
                  });
                }
              }
            }
          });

          var codeGraph = { nodes: nodes, edges: edges };
          renderCodeGraphD3(codeGraph);
        }

        function getCodeColor(language) {
          var colors = {
            'rust': '#CE412B',
            'python': '#3776AB',
            'javascript': '#F7DF1E',
            'typescript': '#3178C6',
            'go': '#00ADD8',
            'java': '#007396',
            'cpp': '#00599C',
            'c': '#A8B9CC'
          };
          return colors[language.toLowerCase()] || '#78716c';
        }

        function renderMindMapD3(mindMap) {
          if (!window.d3) {
            showGraphEmptyState('D3.js library not loaded');
            return;
          }

          var container = document.getElementById('graphSvg');
          var width = container.clientWidth || 800;
          var height = container.clientHeight || 600;

          // Clear previous content
          container.innerHTML = '';

          // Create SVG
          var svg = d3.select('#graphSvg')
            .append('svg')
            .attr('width', width)
            .attr('height', height)
            .attr('viewBox', [0, 0, width, height]);

          // Add zoom behavior
          var g = svg.append('g');
          var zoom = d3.zoom()
            .scaleExtent([0.1, 4])
            .on('zoom', function(event) {
              g.attr('transform', event.transform);
            });
          svg.call(zoom);

          // Define arrowhead marker
          svg.append('defs').append('marker')
            .attr('id', 'arrowhead')
            .attr('viewBox', '-0 -5 10 10')
            .attr('refX', 20)
            .attr('refY', 0)
            .attr('orient', 'auto')
            .attr('markerWidth', 8)
            .attr('markerHeight', 8)
            .append('path')
            .attr('d', 'M 0,-5 L 10,0 L 0,5')
            .attr('fill', '#3b82f6');

          // Use pre-computed positions if available, otherwise use force simulation
          if (mindMap.nodes.every(function(n) { return n.position; })) {
            renderWithPositions(g, mindMap, width, height);
          } else {
            renderWithForce(g, mindMap, width, height);
          }

          // Store simulation reference
          graphSimulation = { svg: svg, zoom: zoom, g: g };
        }

        function renderWithPositions(g, mindMap, width, height) {
          // Render edges
          var link = g.append('g')
            .selectAll('line')
            .data(mindMap.edges)
            .join('line')
            .attr('class', function(d) { return 'graph-edge ' + d.kind; })
            .attr('x1', function(d) {
              var source = mindMap.nodes.find(function(n) { return n.id === d.source; });
              return source ? source.position.x : 0;
            })
            .attr('y1', function(d) {
              var source = mindMap.nodes.find(function(n) { return n.id === d.source; });
              return source ? source.position.y : 0;
            })
            .attr('x2', function(d) {
              var target = mindMap.nodes.find(function(n) { return n.id === d.target; });
              return target ? target.position.x : 0;
            })
            .attr('y2', function(d) {
              var target = mindMap.nodes.find(function(n) { return n.id === d.target; });
              return target ? target.position.y : 0;
            });

          // Render nodes
          var node = g.append('g')
            .selectAll('g')
            .data(mindMap.nodes)
            .join('g')
            .attr('class', function(d) { return 'graph-node' + (d.is_center ? ' center' : ''); })
            .attr('transform', function(d) {
              return 'translate(' + (d.position ? d.position.x : 0) + ',' + (d.position ? d.position.y : 0) + ')';
            })
            .on('click', function(event, d) {
              // Find and select the memory
              var mem = memories.find(function(m) { return m.id === d.id; });
              if (mem) selectMemory(mem);
            });

          node.append('circle')
            .attr('class', 'node-circle')
            .attr('r', function(d) { return d.size * 20 + 10; })
            .attr('fill', function(d) { return d.color; });

          node.append('text')
            .attr('class', 'node-label')
            .attr('dy', function(d) { return d.size * 20 + 25; })
            .text(function(d) { return d.label.length > 20 ? d.label.substring(0, 18) + '...' : d.label; });
        }

        function renderWithForce(g, mindMap, width, height) {
          var simulation = d3.forceSimulation(mindMap.nodes)
            .force('link', d3.forceLink(mindMap.edges).id(function(d) { return d.id; }).distance(100))
            .force('charge', d3.forceManyBody().strength(-300))
            .force('center', d3.forceCenter(width / 2, height / 2))
            .force('collision', d3.forceCollide().radius(40));

          // Render edges
          var link = g.append('g')
            .selectAll('line')
            .data(mindMap.edges)
            .join('line')
            .attr('class', function(d) { return 'graph-edge ' + d.kind; });

          // Render nodes
          var node = g.append('g')
            .selectAll('g')
            .data(mindMap.nodes)
            .join('g')
            .attr('class', function(d) { return 'graph-node' + (d.is_center ? ' center' : ''); })
            .on('click', function(event, d) {
              var mem = memories.find(function(m) { return m.id === d.id; });
              if (mem) selectMemory(mem);
            })
            .call(d3.drag()
              .on('start', function(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
              })
              .on('drag', function(event, d) {
                d.fx = event.x;
                d.fy = event.y;
              })
              .on('end', function(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
              }));

          node.append('circle')
            .attr('class', 'node-circle')
            .attr('r', function(d) { return d.size * 20 + 10; })
            .attr('fill', function(d) { return d.color; });

          node.append('text')
            .attr('class', 'node-label')
            .attr('dy', function(d) { return d.size * 20 + 25; })
            .text(function(d) { return d.label.length > 20 ? d.label.substring(0, 18) + '...' : d.label; });

          simulation.on('tick', function() {
            link
              .attr('x1', function(d) { return d.source.x; })
              .attr('y1', function(d) { return d.source.y; })
              .attr('x2', function(d) { return d.target.x; })
              .attr('y2', function(d) { return d.target.y; });

            node.attr('transform', function(d) { return 'translate(' + d.x + ',' + d.y + ')'; });
          });
        }

        function renderCodeGraphD3(codeGraph) {
          if (!window.d3) {
            showGraphEmptyState('D3.js library not loaded');
            return;
          }

          var container = document.getElementById('graphSvg');
          var width = container.clientWidth || 800;
          var height = container.clientHeight || 600;

          container.innerHTML = '';

          var svg = d3.select('#graphSvg')
            .append('svg')
            .attr('width', width)
            .attr('height', height)
            .attr('viewBox', [0, 0, width, height]);

          var g = svg.append('g');
          var zoom = d3.zoom()
            .scaleExtent([0.1, 4])
            .on('zoom', function(event) {
              g.attr('transform', event.transform);
            });
          svg.call(zoom);

          // Define arrowhead marker
          svg.append('defs').append('marker')
            .attr('id', 'arrowhead')
            .attr('viewBox', '-0 -5 10 10')
            .attr('refX', 20)
            .attr('refY', 0)
            .attr('orient', 'auto')
            .attr('markerWidth', 8)
            .attr('markerHeight', 8)
            .append('path')
            .attr('d', 'M 0,-5 L 10,0 L 0,5')
            .attr('fill', '#3b82f6');

          var simulation = d3.forceSimulation(codeGraph.nodes)
            .force('link', d3.forceLink(codeGraph.edges).id(function(d) { return d.id; }).distance(120))
            .force('charge', d3.forceManyBody().strength(-400))
            .force('center', d3.forceCenter(width / 2, height / 2))
            .force('collision', d3.forceCollide().radius(50));

          var link = g.append('g')
            .selectAll('line')
            .data(codeGraph.edges)
            .join('line')
            .attr('class', function(d) { return 'graph-edge ' + d.kind; });

          var node = g.append('g')
            .selectAll('g')
            .data(codeGraph.nodes)
            .join('g')
            .attr('class', 'graph-node')
            .on('click', function(event, d) {
              var mem = memories.find(function(m) { return m.id === d.id; });
              if (mem) selectMemory(mem);
            })
            .call(d3.drag()
              .on('start', function(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
              })
              .on('drag', function(event, d) {
                d.fx = event.x;
                d.fy = event.y;
              })
              .on('end', function(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
              }));

          node.append('circle')
            .attr('class', 'node-circle')
            .attr('r', 25)
            .attr('fill', function(d) { return d.color; });

          node.append('text')
            .attr('class', 'node-label')
            .attr('dy', 40)
            .text(function(d) { return d.label.length > 15 ? d.label.substring(0, 13) + '...' : d.label; });

          simulation.on('tick', function() {
            link
              .attr('x1', function(d) { return d.source.x; })
              .attr('y1', function(d) { return d.source.y; })
              .attr('x2', function(d) { return d.target.x; })
              .attr('y2', function(d) { return d.target.y; });

            node.attr('transform', function(d) { return 'translate(' + d.x + ',' + d.y + ')'; });
          });

          graphSimulation = { svg: svg, zoom: zoom, simulation: simulation };
        }

        function zoomIn() {
          if (graphSimulation && graphSimulation.svg) {
            graphSimulation.svg.transition().call(
              graphSimulation.zoom.scaleBy, 1.3
            );
          }
        }

        function zoomOut() {
          if (graphSimulation && graphSimulation.svg) {
            graphSimulation.svg.transition().call(
              graphSimulation.zoom.scaleBy, 0.7
            );
          }
        }

        function resetZoom() {
          if (graphSimulation && graphSimulation.svg) {
            graphSimulation.svg.transition().call(
              graphSimulation.zoom.transform,
              d3.zoomIdentity
            );
          }
        }
        // ===== END GRAPH VISUALIZATION FUNCTIONS =====

        function bulkToggleFavorite() {
          if (selectedIds.length === 0) return;
          var pending = selectedIds.length;
          var successCount = 0;

          selectedIds.forEach(function(id) {
            invoke('toggle_favorite', { memoryId: id }).then(function(isFav) {
              memories.forEach(function(m) {
                if (m.id === id) m.is_favorite = isFav;
              });
              successCount++;
              pending--;
              if (pending === 0) {
                showToast(successCount + ' files updated', 'success');
                clearSelection();
              }
            }).catch(function() {
              pending--;
              if (pending === 0) {
                showToast(successCount + ' files updated', 'success');
                clearSelection();
              }
            });
          });
        }

        function openTagModal() {
          document.getElementById('tagModal').classList.add('open');
          document.getElementById('bulkTagInput').value = '';
          document.getElementById('bulkTagInput').focus();
        }

        function closeTagModal() {
          document.getElementById('tagModal').classList.remove('open');
        }

        function bulkAddTag() {
          var tag = document.getElementById('bulkTagInput').value.trim().toLowerCase();
          if (!tag || selectedIds.length === 0) return;

          invoke('bulk_add_tag', { memoryIds: selectedIds, tag: tag }).then(function(result) {
            showToast(result, 'success');
            // Update local memory objects
            memories.forEach(function(m) {
              if (selectedIds.indexOf(m.id) !== -1) {
                if (!m.tags) m.tags = [];
                if (!m.tags.some(function(t) { return t.name === tag; })) {
                  m.tags.push({ name: tag, source: 'User' });
                }
              }
            });
            closeTagModal();
            clearSelection();
            invoke('get_tags').then(function(tags) {
              allTags = tags || [];
              renderTagBar();
            });
          }).catch(function(err) {
            showToast('Failed to add tag: ' + err, 'error');
          });
        }

        function bulkDeleteFiles() {
          if (selectedIds.length === 0) return;

          var count = selectedIds.length;
          if (!confirm('Are you sure you want to delete ' + count + ' file' + (count === 1 ? '' : 's') + '? This will remove them from the index.')) {
            return;
          }

          invoke('bulk_delete', { memoryIds: selectedIds }).then(function(result) {
            showToast(result, 'success');
            // Remove deleted memories from local array
            memories = memories.filter(function(m) {
              return selectedIds.indexOf(m.id) === -1;
            });
            clearSelection();
            renderFiles();
          }).catch(function(err) {
            showToast('Failed to delete files: ' + err, 'error');
          });
        }

        // ==================== AI Features ====================

        function openSettings() {
          document.getElementById('settingsOverlay').classList.add('open');
          document.getElementById('apiKeyInput').value = apiKey;
          document.getElementById('defaultSearchMode').value = searchMode;
          document.getElementById('aiProvider').value = aiProvider;
          document.getElementById('autoTagEnabled').checked = autoTagEnabled;
          updateProviderUI();
          checkOllamaStatus();
        }

        function closeSettings() {
          document.getElementById('settingsOverlay').classList.remove('open');
        }

        function saveSettings() {
          apiKey = document.getElementById('apiKeyInput').value.trim();
          searchMode = document.getElementById('defaultSearchMode').value;
          aiProvider = document.getElementById('aiProvider').value;
          autoTagEnabled = document.getElementById('autoTagEnabled').checked;
          localStorage.setItem('hippo-api-key', apiKey);
          localStorage.setItem('hippo-search-mode', searchMode);
          localStorage.setItem('hippo-ai-provider', aiProvider);
          localStorage.setItem('hippo-auto-tag', autoTagEnabled.toString());
          setSearchMode(searchMode);
          closeSettings();
          showToast('Settings saved', 'success');
        }

        function updateProviderUI() {
          var isOllama = document.getElementById('aiProvider').value === 'ollama';
          document.getElementById('ollamaSettings').style.display = isOllama ? 'block' : 'none';
          document.getElementById('claudeSettings').style.display = isOllama ? 'none' : 'block';
        }

        function checkOllamaStatus() {
          var statusIcon = document.getElementById('ollamaStatusIcon');
          var statusText = document.getElementById('ollamaStatusText');
          var statusSection = statusIcon.parentElement.parentElement;

          statusText.textContent = 'Checking...';
          statusIcon.innerHTML = icons.refresh;
          statusIcon.style.color = '#78716c';

          invoke('ollama_status').then(function(status) {
            ollamaAvailable = status.available;
            if (status.available) {
              statusIcon.innerHTML = icons.checkCircle;
              statusIcon.style.color = '#22c55e';
              statusText.textContent = 'Running';
              statusText.style.color = '#22c55e';
              statusSection.style.background = '#f0fdf4';
              loadOllamaModels();
            } else {
              statusIcon.innerHTML = icons.alertCircle;
              statusIcon.style.color = '#ef4444';
              statusText.textContent = 'Not running';
              statusText.style.color = '#ef4444';
              statusSection.style.background = '#fef2f2';
              document.getElementById('installedModels').innerHTML = '<span style="color:#ef4444;">Start Ollama to see installed models</span>';
            }
          }).catch(function(e) {
            statusIcon.innerHTML = icons.alertCircle;
            statusIcon.style.color = '#ef4444';
            statusText.textContent = 'Error';
            statusText.style.color = '#ef4444';
          });
        }

        function loadOllamaModels() {
          invoke('ollama_list_models').then(function(models) {
            ollamaModels = models;
            var html = '';
            if (models.length === 0) {
              html = '<span style="color:#f59e0b;">No models installed. Pull one below.</span>';
            } else {
              models.forEach(function(m) {
                html += '<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #e7e5e4;">';
                html += '<span style="font-weight:500;color:#292524;">' + esc(m.name) + '</span>';
                html += '<span style="color:#78716c;">' + m.size_formatted + '</span>';
                html += '</div>';
              });
            }
            document.getElementById('installedModels').innerHTML = html;
          }).catch(function(e) {
            document.getElementById('installedModels').innerHTML = '<span style="color:#ef4444;">Failed to load models</span>';
          });
        }

        function pullModel() {
          var modelName = document.getElementById('modelToPull').value;
          var btn = document.getElementById('pullModelBtn');
          var progress = document.getElementById('pullProgress');

          btn.disabled = true;
          btn.textContent = 'Pulling...';
          progress.style.display = 'block';
          progress.textContent = 'Downloading ' + modelName + '... This may take a few minutes.';

          invoke('ollama_pull_model', { name: modelName }).then(function() {
            btn.disabled = false;
            btn.textContent = 'Pull Model';
            progress.style.display = 'none';
            showToast('Model ' + modelName + ' installed!', 'success');
            loadOllamaModels();
          }).catch(function(e) {
            btn.disabled = false;
            btn.textContent = 'Pull Model';
            progress.textContent = 'Error: ' + e;
            progress.style.color = '#ef4444';
            showToast('Failed to pull model: ' + e, 'error');
          });
        }

        // ==================== Chat Functions ====================

        // Chat context for file-based queries
        var chatContextFiles = [];

        function openChat() {
          chatOpen = true;
          document.getElementById('chatBubble').classList.add('hidden');
          document.getElementById('chatWindow').classList.add('open');
          document.getElementById('chatInput').focus();
          updateChatStatus();
          updateChatContextBar();
        }

        function closeChat() {
          chatOpen = false;
          document.getElementById('chatWindow').classList.remove('open');
          document.getElementById('chatBubble').classList.remove('hidden');
        }

        function toggleChat() {
          if (chatOpen) {
            closeChat();
          } else {
            openChat();
          }
        }

        function clearChatHistory() {
          chatMessages = [];
          var container = document.getElementById('chatMessages');
          container.innerHTML = '<div class="chat-welcome">' +
            '<span class="welcome-icon"></span>' +
            '<h3>Chat with your files</h3>' +
            '<p>Ask questions about your documents and I\'ll find answers using local AI.</p>' +
            '<div class="quick-actions">' +
            '<button class="quick-action-btn" data-action="summarize"><span class="icon icon-sm" id="qaSum"></span> Summarize recent</button>' +
            '<button class="quick-action-btn" data-action="find-duplicates"><span class="icon icon-sm" id="qaDup"></span> Find duplicates</button>' +
            '<button class="quick-action-btn" data-action="organize"><span class="icon icon-sm" id="qaOrg"></span> Suggest organization</button>' +
            '</div></div>';
          // Re-add icons
          document.getElementById('qaSum').innerHTML = icons.doc;
          document.getElementById('qaDup').innerHTML = icons.file;
          document.getElementById('qaOrg').innerHTML = icons.folder;
          // Re-attach quick action handlers
          attachQuickActionHandlers();
        }

        function updateChatStatus() {
          var statusDot = document.getElementById('ollamaStatusDot');
          var statusText = document.getElementById('chatStatusText');

          invoke('ollama_status').then(function(status) {
            if (status.available) {
              statusDot.className = 'status-dot online';
              statusText.textContent = 'Ollama ready';
              ollamaAvailable = true;
            } else {
              statusDot.className = 'status-dot offline';
              statusText.textContent = 'Ollama offline';
              ollamaAvailable = false;
            }
          }).catch(function() {
            statusDot.className = 'status-dot error';
            statusText.textContent = 'Connection error';
            ollamaAvailable = false;
          });
        }

        function updateChatContextBar() {
          var contextBar = document.getElementById('chatContextBar');
          var contextText = document.getElementById('contextText');
          var attachBtn = document.getElementById('attachFileBtn');

          if (selectedIds.length > 0) {
            contextBar.style.display = 'flex';
            contextText.textContent = selectedIds.length + ' file' + (selectedIds.length > 1 ? 's' : '') + ' selected';
            chatContextFiles = selectedIds.slice(); // Copy selected files to context
            attachBtn.classList.add('has-files');
          } else if (chatContextFiles.length > 0) {
            contextBar.style.display = 'flex';
            contextText.textContent = chatContextFiles.length + ' file' + (chatContextFiles.length > 1 ? 's' : '') + ' in context';
            attachBtn.classList.add('has-files');
          } else {
            contextBar.style.display = 'none';
            attachBtn.classList.remove('has-files');
          }
        }

        function clearChatContext() {
          chatContextFiles = [];
          updateChatContextBar();
        }

        function attachSelectedFiles() {
          if (selectedIds.length > 0) {
            chatContextFiles = selectedIds.slice();
            updateChatContextBar();
            showToast(chatContextFiles.length + ' files attached to chat', 'success');
          } else {
            showToast('No files selected. Select files first.', 'info');
          }
        }

        function analyzeSelectedFiles() {
          var filesToAnalyze = chatContextFiles.length > 0 ? chatContextFiles : selectedIds;
          if (filesToAnalyze.length === 0) {
            showToast('No files to analyze', 'info');
            return;
          }

          // Get file paths for analysis
          var filePaths = filesToAnalyze.map(function(id) {
            var mem = memories.find(function(m) { return m.id === id; });
            return mem ? mem.path : null;
          }).filter(Boolean);

          if (filePaths.length === 0) return;

          // Open chat if not open
          if (!chatOpen) openChat();

          var fileNames = filePaths.map(function(p) { return p.split('/').pop(); });
          var query = 'Analyze ' + (filePaths.length === 1 ? fileNames[0] : filePaths.length + ' files: ' + fileNames.slice(0, 3).join(', ') + (fileNames.length > 3 ? '...' : ''));
          addChatMessage('user', query);

          document.getElementById('chatInput').disabled = true;
          document.getElementById('chatSendBtn').disabled = true;
          showAiProgress('Analyzing ' + filePaths.length + ' file' + (filePaths.length > 1 ? 's' : '') + '...');
          addChatLoading();

          // Use ollama_analyze for file analysis
          invoke('ollama_analyze', { filePaths: filePaths }).then(function(response) {
            hideAiProgress();
            removeChatLoading();
            addChatMessage('assistant', response);
            document.getElementById('chatInput').disabled = false;
            document.getElementById('chatSendBtn').disabled = false;
          }).catch(function(e) {
            hideAiProgress();
            removeChatLoading();
            addChatMessage('assistant', 'Analysis failed: ' + e);
            document.getElementById('chatInput').disabled = false;
            document.getElementById('chatSendBtn').disabled = false;
          });
        }

        function summarizeSelectedFiles() {
          var filesToSummarize = chatContextFiles.length > 0 ? chatContextFiles : selectedIds;
          if (filesToSummarize.length === 0) {
            showToast('No files to summarize', 'info');
            return;
          }

          var filePaths = filesToSummarize.map(function(id) {
            var mem = memories.find(function(m) { return m.id === id; });
            return mem ? mem.path : null;
          }).filter(Boolean);

          if (filePaths.length === 0) return;

          if (!chatOpen) openChat();

          var fileNames = filePaths.map(function(p) { return p.split('/').pop(); });
          var query = 'Summarize ' + (filePaths.length === 1 ? fileNames[0] : filePaths.length + ' files');
          addChatMessage('user', query);

          document.getElementById('chatInput').disabled = true;
          document.getElementById('chatSendBtn').disabled = true;
          showAiProgress('Summarizing ' + filePaths.length + ' file' + (filePaths.length > 1 ? 's' : '') + '...');
          addChatLoading();

          invoke('ollama_summarize', { filePaths: filePaths }).then(function(response) {
            hideAiProgress();
            removeChatLoading();
            addChatMessage('assistant', response);
            document.getElementById('chatInput').disabled = false;
            document.getElementById('chatSendBtn').disabled = false;
          }).catch(function(e) {
            hideAiProgress();
            removeChatLoading();
            addChatMessage('assistant', 'Summarization failed: ' + e);
            document.getElementById('chatInput').disabled = false;
            document.getElementById('chatSendBtn').disabled = false;
          });
        }

        // AI Progress Indicator Functions
        function showAiProgress(text) {
          var container = document.getElementById('aiProgressContainer');
          var progressText = document.getElementById('aiProgressText');
          progressText.textContent = text || 'Processing...';
          container.style.display = 'block';
          document.getElementById('chatBubble').classList.add('processing');
        }

        function updateAiProgress(text) {
          document.getElementById('aiProgressText').textContent = text;
        }

        function hideAiProgress() {
          document.getElementById('aiProgressContainer').style.display = 'none';
          document.getElementById('chatBubble').classList.remove('processing');
        }

        function handleQuickAction(action) {
          if (!chatOpen) openChat();

          var query = '';
          var progressText = '';
          switch(action) {
            case 'summarize':
              query = 'Give me a brief overview of my file collection. What types of files do I have and what are the main themes or content areas?';
              progressText = 'Analyzing your collection...';
              break;
            case 'find-duplicates':
              query = 'Look through my files and identify any that might be duplicates or very similar to each other. Group them by similarity.';
              progressText = 'Scanning for duplicates...';
              break;
            case 'organize':
              query = 'Based on my current files, suggest a better folder structure or organization system. What categories would work best?';
              progressText = 'Generating suggestions...';
              break;
            case 'extract-insights':
              query = 'What are the main themes, topics, or patterns you can identify across my files? Extract key insights.';
              progressText = 'Extracting insights...';
              break;
            case 'code-review':
              query = 'Review my code files for quality, potential issues, and improvements. Focus on the most important findings.';
              progressText = 'Reviewing code...';
              break;
            case 'search-help':
              query = 'Help me search my files. What kind of queries can I ask? Give me examples of useful searches.';
              progressText = 'Preparing search tips...';
              break;
            default:
              return;
          }

          sendChatQuery(query, progressText);
        }

        function attachQuickActionHandlers() {
          document.querySelectorAll('.quick-action-btn').forEach(function(btn) {
            btn.onclick = function() {
              handleQuickAction(btn.dataset.action);
            };
          });
        }

        function sendChatMessage() {
          var input = document.getElementById('chatInput');
          var query = input.value.trim();
          if (!query) return;
          sendChatQuery(query);
          input.value = '';
        }

        function sendChatQuery(query, progressText) {
          var input = document.getElementById('chatInput');

          // Add user message
          addChatMessage('user', query);
          input.disabled = true;
          document.getElementById('chatSendBtn').disabled = true;

          // Show progress indicator
          showAiProgress(progressText || 'Thinking...');
          addChatLoading();

          // Use RAG query for local AI with timeout
          var timeoutId = setTimeout(function() {
            updateAiProgress('Still processing...');
          }, 5000);

          invoke('ollama_rag_query', { query: query }).then(function(data) {
            clearTimeout(timeoutId);
            hideAiProgress();
            removeChatLoading();
            // Handle new JSON response format with files and stats
            var response = typeof data === 'object' ? data.response : data;
            var files = typeof data === 'object' ? data.files : null;
            var stats = typeof data === 'object' ? data.stats : null;
            addChatMessage('assistant', response, files, stats);
            input.disabled = false;
            document.getElementById('chatSendBtn').disabled = false;
            input.focus();
          }).catch(function(e) {
            clearTimeout(timeoutId);
            hideAiProgress();
            removeChatLoading();
            var errorMsg = String(e);
            if (errorMsg.includes('connection') || errorMsg.includes('refused')) {
              addChatMessage('assistant', 'Ollama is not running. Start it with: ollama serve');
            } else if (errorMsg.includes('model')) {
              addChatMessage('assistant', 'Model not found. Run: ollama pull llama3.2:3b');
            } else {
              addChatMessage('assistant', 'Error: ' + errorMsg);
            }
            input.disabled = false;
            document.getElementById('chatSendBtn').disabled = false;
            input.focus();
          });
        }

        function getFileTypeFromPath(filePath, fileType) {
          if (fileType) {
            if (fileType === 'image') return 'image';
            if (fileType.startsWith('code:')) return 'code';
            if (fileType === 'document') return 'document';
            if (fileType === 'video') return 'video';
            if (fileType === 'audio') return 'audio';
          }
          var ext = filePath.split('.').pop().toLowerCase();
          if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp', 'svg', 'ico'].includes(ext)) return 'image';
          if (['mp4', 'mov', 'avi', 'mkv', 'webm'].includes(ext)) return 'video';
          if (['mp3', 'wav', 'ogg', 'flac', 'm4a'].includes(ext)) return 'audio';
          if (['js', 'ts', 'jsx', 'tsx', 'py', 'rs', 'go', 'java', 'c', 'cpp', 'h', 'css', 'html', 'json', 'yaml', 'yml', 'sh', 'bash', 'rb', 'php', 'swift', 'kt'].includes(ext)) return 'code';
          if (['pdf', 'doc', 'docx', 'txt', 'md', 'rtf', 'odt'].includes(ext)) return 'document';
          return 'file';
        }

        function getFileIcon(fileType) {
          switch(fileType) {
            case 'image': return icons.image;
            case 'video': return icons.video;
            case 'audio': return icons.audio;
            case 'code': return icons.code;
            case 'document': return icons.doc;
            default: return icons.file;
          }
        }

        function renderFilePreviewCards(files) {
          if (!files || files.length === 0) return '';

          var html = '<div class="chat-file-previews">';
          html += '<div class="chat-files-header" style="width:100%"><span class="icon">' + icons.folder + '</span> Referenced Files</div>';

          files.forEach(function(file) {
            var fileType = getFileTypeFromPath(file.path, file.type);
            var isImage = fileType === 'image';
            var thumbContent = isImage
              ? '<img src="' + esc(file.path) + '" alt="' + esc(file.name) + '" onerror="this.style.display=\'none\'; this.parentNode.innerHTML=\'' + getFileIcon(fileType).replace(/'/g, "\\'") + '\'">'
              : '<span class="icon icon-sm">' + getFileIcon(fileType) + '</span>';

            var sizeStr = file.size ? formatBytes(file.size) : '';
            var relevance = file.relevance || 'low';

            html += '<div class="chat-file-card" data-path="' + esc(file.path) + '" onclick="openChatFile(\'' + esc(file.path).replace(/'/g, "\\'") + '\')">';
            html += '<div class="chat-file-thumb ' + fileType + '">' + thumbContent + '</div>';
            html += '<div class="chat-file-info">';
            html += '<span class="chat-file-name" title="' + esc(file.name) + '">' + esc(file.name) + '</span>';
            html += '<span class="chat-file-meta"><span class="chat-file-relevance ' + relevance + '"></span>' + sizeStr + '</span>';
            html += '</div>';
            html += '</div>';
          });

          html += '</div>';
          return html;
        }

        function openChatFile(path) {
          invoke('open_file', { path: path }).catch(function(e) {
            showToast('Failed to open file', 'error');
          });
        }

        // Parse markdown-like content for rich formatting
        function parseMessageContent(text) {
          if (!text) return '';

          var html = text;

          // Escape HTML first
          html = esc(html);

          // Code blocks (```lang\ncode```)
          html = html.replace(/```(\w*)\n([\s\S]*?)```/g, function(match, lang, code) {
            var langLabel = lang || 'code';
            var codeId = 'code_' + Math.random().toString(36).substr(2, 9);
            return '<div class="msg-code-block">' +
              '<div class="msg-code-header">' +
              '<span class="msg-code-lang">' + langLabel + '</span>' +
              '<button class="msg-code-copy" onclick="copyCodeBlock(\'' + codeId + '\')">' +
              '<span class="icon">' + icons.file + '</span>Copy</button>' +
              '</div>' +
              '<pre class="msg-code-pre" id="' + codeId + '">' + code.trim() + '</pre>' +
              '</div>';
          });

          // Inline code (`code`)
          html = html.replace(/`([^`]+)`/g, '<code>$1</code>');

          // Bold (**text** or __text__)
          html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
          html = html.replace(/__([^_]+)__/g, '<strong>$1</strong>');

          // Italic (*text* or _text_)
          html = html.replace(/\*([^*]+)\*/g, '<em>$1</em>');
          html = html.replace(/_([^_]+)_/g, '<em>$1</em>');

          // Headers
          html = html.replace(/^### (.+)$/gm, '<div class="msg-h3">$1</div>');
          html = html.replace(/^## (.+)$/gm, '<div class="msg-h2">$1</div>');
          html = html.replace(/^# (.+)$/gm, '<div class="msg-h1">$1</div>');

          // Bullet lists (- item or * item)
          var listPattern = /^[\-\*] .+(\n[\-\*] .+)*/gm;
          html = html.replace(listPattern, function(match) {
            var items = match.split('\n').map(function(line) {
              return '<li>' + line.replace(/^[\-\*] /, '') + '</li>';
            }).join('');
            return '<ul class="msg-list">' + items + '</ul>';
          });

          // Numbered lists (1. item)
          var numListPattern = /^\d+\. .+(\n\d+\. .+)*/gm;
          html = html.replace(numListPattern, function(match) {
            var items = match.split('\n').map(function(line) {
              return '<li>' + line.replace(/^\d+\. /, '') + '</li>';
            }).join('');
            return '<ul class="msg-list numbered">' + items + '</ul>';
          });

          // Highlight boxes (> info: text, > tip: text, etc.)
          html = html.replace(/^&gt; (info|tip|warning|success): (.+)$/gm, function(match, type, text) {
            var icon = type === 'info' ? icons.alertCircle :
                       type === 'tip' ? icons.zap :
                       type === 'warning' ? icons.alertCircle :
                       icons.checkCircle;
            return '<div class="msg-highlight ' + type + '">' +
              '<div class="msg-highlight-title"><span class="icon">' + icon + '</span>' + type.charAt(0).toUpperCase() + type.slice(1) + '</div>' +
              text + '</div>';
          });

          // File mentions (detect file paths or filenames)
          html = html.replace(/\b([\w\-\.]+\.(png|jpg|jpeg|gif|pdf|doc|docx|txt|md|js|ts|py|rs|go|json|yaml|yml|html|css|svg))\b/gi, function(match, filename) {
            return '<span class="msg-file-mention" onclick="searchForFile(\'' + filename + '\')">' +
              '<span class="icon">' + icons.file + '</span>' + filename + '</span>';
          });

          // Convert newlines to paragraphs (but not inside code blocks or lists)
          var lines = html.split('\n');
          var result = [];
          var inCodeBlock = false;

          for (var i = 0; i < lines.length; i++) {
            var line = lines[i];
            if (line.includes('msg-code-block')) inCodeBlock = true;
            if (line.includes('</div>') && inCodeBlock) inCodeBlock = false;

            if (!inCodeBlock && line.trim() && !line.startsWith('<ul') && !line.startsWith('<li') && !line.startsWith('</ul') && !line.startsWith('<div class="msg-')) {
              result.push('<p>' + line + '</p>');
            } else {
              result.push(line);
            }
          }

          return '<div class="msg-content">' + result.join('\n') + '</div>';
        }

        function generateActionButtons(content, files, stats) {
          var actions = [];
          var contentLower = content.toLowerCase();

          // Always add a "Copy" button
          actions.push({
            label: 'Copy',
            icon: icons.file,
            action: 'copyResponse',
            primary: false
          });

          // Add contextual actions based on content
          if (contentLower.includes('screenshot') || contentLower.includes('image')) {
            actions.push({
              label: 'Show Images',
              icon: icons.image,
              action: 'filterImages',
              primary: false
            });
          }

          if (contentLower.includes('code') || contentLower.includes('function') || contentLower.includes('script')) {
            actions.push({
              label: 'Show Code Files',
              icon: icons.code,
              action: 'filterCode',
              primary: false
            });
          }

          if (contentLower.includes('document') || contentLower.includes('pdf') || contentLower.includes('text')) {
            actions.push({
              label: 'Show Documents',
              icon: icons.doc,
              action: 'filterDocs',
              primary: false
            });
          }

          if (contentLower.includes('duplicate') || contentLower.includes('similar')) {
            actions.push({
              label: 'Find Duplicates',
              icon: icons.file,
              action: 'findDuplicates',
              primary: true
            });
          }

          if (contentLower.includes('organize') || contentLower.includes('folder') || contentLower.includes('structure')) {
            actions.push({
              label: 'Smart Organize',
              icon: icons.folder,
              action: 'smartOrganize',
              primary: true
            });
          }

          // Always offer to ask follow-up
          actions.push({
            label: 'Ask Follow-up',
            icon: icons.messageCircle,
            action: 'askFollowup',
            primary: true
          });

          // Build HTML
          var html = '<div class="msg-actions">';
          actions.slice(0, 4).forEach(function(action) {
            html += '<button class="msg-action-btn' + (action.primary ? ' primary' : '') + '" ' +
              'onclick="handleMsgAction(\'' + action.action + '\')">' +
              '<span class="icon">' + action.icon + '</span>' + action.label + '</button>';
          });
          html += '</div>';

          return html;
        }

        function handleMsgAction(action) {
          switch(action) {
            case 'copyResponse':
              var lastMsg = chatMessages[chatMessages.length - 1];
              if (lastMsg && lastMsg.role === 'assistant') {
                navigator.clipboard.writeText(lastMsg.content).then(function() {
                  showToast('Response copied!', 'success');
                });
              }
              break;
            case 'filterImages':
              filterType = 'image';
              render();
              showToast('Filtered to images', 'success');
              break;
            case 'filterCode':
              filterType = 'code';
              render();
              showToast('Filtered to code files', 'success');
              break;
            case 'filterDocs':
              filterType = 'document';
              render();
              showToast('Filtered to documents', 'success');
              break;
            case 'findDuplicates':
              sendChatQuery('Find all duplicate or very similar files in my collection and group them together.', 'Finding duplicates...');
              break;
            case 'smartOrganize':
              sendChatQuery('Suggest a smart folder organization structure for my files based on their types and content.', 'Generating organization plan...');
              break;
            case 'askFollowup':
              document.getElementById('chatInput').focus();
              break;
          }
        }

        function copyCodeBlock(codeId) {
          var codeEl = document.getElementById(codeId);
          if (codeEl) {
            navigator.clipboard.writeText(codeEl.textContent).then(function() {
              showToast('Code copied!', 'success');
            });
          }
        }

        function searchForFile(filename) {
          document.getElementById('searchInput').value = filename;
          handleSearch();
          showToast('Searching for ' + filename, 'info');
        }

        // Expose functions to global scope immediately for onclick handlers
        window.handleMsgAction = handleMsgAction;
        window.copyCodeBlock = copyCodeBlock;
        window.searchForFile = searchForFile;

        function addChatMessage(role, content, files, stats) {
          var container = document.getElementById('chatMessages');
          // Remove welcome message if present
          var welcome = container.querySelector('.chat-welcome');
          if (welcome) welcome.remove();

          var msgDiv = document.createElement('div');
          msgDiv.className = 'chat-message ' + role;

          var bubbleContent = '<div class="bubble">';

          // Parse content for rich formatting (only for assistant messages)
          if (role === 'assistant') {
            bubbleContent += parseMessageContent(content);
          } else {
            bubbleContent += '<div class="msg-content"><p>' + esc(content) + '</p></div>';
          }

          // Add file previews for assistant messages
          if (role === 'assistant' && files && files.length > 0) {
            bubbleContent += renderFilePreviewCards(files);
          }

          // Add stats as nice cards for assistant messages
          if (role === 'assistant' && stats) {
            bubbleContent += '<div class="msg-stat-cards">';
            if (stats.total_files) {
              bubbleContent += '<div class="msg-stat-card"><div class="msg-stat-value">' + stats.total_files + '</div><div class="msg-stat-label">Files Analyzed</div></div>';
            }
            if (stats.context_size) {
              var kb = Math.round(stats.context_size / 100) / 10;
              bubbleContent += '<div class="msg-stat-card"><div class="msg-stat-value">' + kb + '</div><div class="msg-stat-label">KB Context</div></div>';
            }
            bubbleContent += '</div>';
          }

          // Add action buttons for assistant messages
          if (role === 'assistant') {
            bubbleContent += generateActionButtons(content, files, stats);
          }

          bubbleContent += '</div>';
          msgDiv.innerHTML = bubbleContent;
          container.appendChild(msgDiv);
          container.scrollTop = container.scrollHeight;
          chatMessages.push({ role: role, content: content, files: files });
        }

        function addChatLoading() {
          var container = document.getElementById('chatMessages');
          var loadingDiv = document.createElement('div');
          loadingDiv.className = 'chat-message assistant';
          loadingDiv.id = 'chatLoading';
          loadingDiv.innerHTML = '<div class="chat-loading"><span></span><span></span><span></span></div>';
          container.appendChild(loadingDiv);
          container.scrollTop = container.scrollHeight;
        }

        function removeChatLoading() {
          var loading = document.getElementById('chatLoading');
          if (loading) loading.remove();
        }

        function setSearchMode(mode) {
          searchMode = mode;
          document.querySelectorAll('.search-mode-btn').forEach(function(btn) {
            btn.classList.toggle('active', btn.dataset.mode === mode);
          });
          // Update placeholder
          var input = document.getElementById('searchInput');
          if (mode === 'text') {
            input.placeholder = 'Search files... (Tab to add tag)';
          } else if (mode === 'semantic') {
            input.placeholder = 'Ask anything about your files...';
          } else if (mode === 'symbol') {
            input.placeholder = 'Search functions, classes, imports...';
          }
        }

        function handleAISearch(query) {
          if (!query.trim()) {
            document.getElementById('symbolResults').style.display = 'none';
            return;
          }

          if (searchMode === 'semantic') {
            performSemanticSearch(query);
          } else if (searchMode === 'symbol') {
            performSymbolSearch(query);
          }
        }

        function performSemanticSearch(query) {
          if (!apiKey) {
            showToast('Set your API key in AI Settings first', 'error');
            return;
          }
          if (!qdrantAvailable) {
            showToast('Semantic search requires Qdrant. Install it in AI Settings.', 'warning');
            return;
          }
          if (qdrantVectorCount === 0) {
            showToast('No files indexed for semantic search. Index files first.', 'warning');
            return;
          }
          showToast('Searching with AI...', 'info');
          invoke('semantic_search', { query: query, limit: 30 }).then(function(results) {
            // Update memories with semantic results
            if (results && results.length > 0) {
              var semanticMemories = results.map(function(r) { return r.memory; });
              memories = semanticMemories;
              renderFiles();
              showToast('Found ' + results.length + ' similar files', 'success');
            } else {
              showToast('No similar files found', 'info');
            }
          }).catch(function(e) {
            showToast('Semantic search failed: ' + e, 'error');
          });
        }

        function performSymbolSearch(query) {
          invoke('search_symbols', { query: query }).then(function(results) {
            symbolResults = results || [];
            renderSymbolResults();
          }).catch(function(e) {
            showToast('Symbol search failed: ' + e, 'error');
          });
        }

        // Natural Language Search Detection
        function isNaturalLanguageQuery(query) {
          if (!query || query.trim().length < 5) return false;

          var lower = query.toLowerCase();

          // Detect NL trigger phrases
          var triggerPhrases = ['show me', 'find', 'search for', 'get me', 'look for', 'display'];
          if (triggerPhrases.some(function(phrase) { return lower.includes(phrase); })) {
            return true;
          }

          // Detect file type words
          var fileTypeWords = ['images', 'photos', 'videos', 'documents', 'code', 'music', 'audio', 'pictures', 'pics', 'photo', 'image', 'video', 'doc', 'docs', 'pdf'];
          var hasFileType = fileTypeWords.some(function(word) { return lower.includes(word); });

          // Detect date words
          var dateWords = ['today', 'yesterday', 'last week', 'this week', 'last month', 'this month', 'last year', 'this year'];
          var hasDate = dateWords.some(function(word) { return lower.includes(word); });

          // If query has file type or date words, it's likely NL
          return hasFileType || hasDate;
        }

        function performNaturalLanguageSearch(query) {
          showToast('Parsing your query...', 'info');

          invoke('natural_language_search', { query: query }).then(function(result) {
            var parsed = result.parsed;
            var searchResults = result.results;

            // Show interpretation
            if (parsed && parsed.interpretation) {
              var interpDiv = document.getElementById('nlInterpretation');
              interpDiv.innerHTML = '<span class="nl-interpretation-label">Searching for:</span>' + esc(parsed.interpretation);
              interpDiv.classList.add('show');
            }

            // Update memories with results
            if (searchResults && searchResults.memories) {
              memories = searchResults.memories.map(function(x) { return x.memory; });
              renderFiles();
              showToast('Found ' + memories.length + ' files', 'success');
            } else {
              memories = [];
              renderFiles();
              showToast('No files found', 'info');
            }
          }).catch(function(e) {
            showToast('Natural language search failed: ' + e, 'error');
            hideNLBadge();
          });
        }

        function showNLBadge() {
          document.getElementById('nlBadge').style.display = 'inline-flex';
        }

        function hideNLBadge() {
          document.getElementById('nlBadge').style.display = 'none';
          var interpDiv = document.getElementById('nlInterpretation');
          interpDiv.classList.remove('show');
        }

        function renderSymbolResults() {
          var container = document.getElementById('symbolResults');
          if (symbolResults.length === 0) {
            container.style.display = 'none';
            return;
          }

          var html = '';
          symbolResults.slice(0, 20).forEach(function(sym) {
            html += '<div class="symbol-item" data-file="' + esc(sym.file) + '" data-line="' + (sym.line || 1) + '">';
            html += '<span class="symbol-name">' + esc(sym.name) + '</span>';
            html += '<span class="symbol-type ' + sym.type + '">' + sym.type + '</span>';
            html += '<div class="symbol-file">' + esc(sym.file) + (sym.line ? ':' + sym.line : '') + '</div>';
            html += '</div>';
          });

          container.innerHTML = html;
          container.style.display = 'block';

          // Bind click handlers
          container.querySelectorAll('.symbol-item').forEach(function(item) {
            item.onclick = function() {
              var file = item.dataset.file;
              invoke('open_file', { path: file }).catch(function() {});
              container.style.display = 'none';
            };
          });
        }

        function analyzeWithAI() {
          if (!selectedMemory) return;
          if (!apiKey) {
            showToast('Set your API key in AI Settings first', 'error');
            openSettings();
            return;
          }

          var btn = document.getElementById('aiAnalyzeBtn');
          btn.classList.add('loading');
          btn.disabled = true;

          invoke('analyze_file', { memoryId: selectedMemory.id, apiKey: apiKey }).then(function(analysis) {
            btn.classList.remove('loading');
            btn.disabled = false;

            // Show results
            document.getElementById('aiResults').style.display = 'block';
            document.getElementById('aiSummaryText').textContent = analysis.description || 'No description generated';

            var topicsHtml = '';
            if (analysis.tags && analysis.tags.length > 0) {
              analysis.tags.forEach(function(tag) {
                topicsHtml += '<span class="ai-topic">' + esc(tag.name) + '</span>';
              });
            }
            document.getElementById('aiTopics').innerHTML = topicsHtml;

            // Refresh tags
            invoke('get_tags').then(function(tags) {
              allTags = tags || [];
              renderTagBar();
            });

            // Refresh the detail panel tags
            var tagsHtml = '';
            if (selectedMemory.tags) {
              selectedMemory.tags.forEach(function(t) {
                tagsHtml += '<span class="detail-tag">' + esc(t.name) + '</span>';
              });
            }
            document.getElementById('detailTags').innerHTML = tagsHtml || '<span style="color:#a8a29e;font-size:12px;">No tags</span>';

            showToast('AI analysis complete!', 'success');
          }).catch(function(e) {
            btn.classList.remove('loading');
            btn.disabled = false;
            showToast('Analysis failed: ' + e, 'error');
          });
        }

        function aiSuggestTags() {
          if (!selectedMemory) return;

          var btn = document.getElementById('aiSuggestTagsBtn');
          btn.classList.add('loading');
          btn.disabled = true;
          var resultsDiv = document.getElementById('aiActionResults');
          resultsDiv.innerHTML = '';
          resultsDiv.style.display = 'none';

          invoke('ai_suggest_tags', { filePath: selectedMemory.path }).then(function(result) {
            btn.classList.remove('loading');
            btn.disabled = false;

            if (result.suggested_tags && result.suggested_tags.length > 0) {
              var html = '<div class="ai-results-panel">';
              html += '<div class="ai-results-title"><span class="icon">' + icons.tag + '</span> Suggested Tags</div>';
              html += '<div class="ai-tag-suggestions">';
              result.suggested_tags.forEach(function(tag) {
                html += '<button class="ai-tag-suggestion" onclick="addSuggestedTag(\'' + esc(tag).replace(/'/g, "\\'") + '\')">' + esc(tag) + '</button>';
              });
              html += '</div></div>';
              resultsDiv.innerHTML = html;
              resultsDiv.style.display = 'block';
            } else {
              showToast('No tag suggestions found', 'info');
            }
          }).catch(function(e) {
            btn.classList.remove('loading');
            btn.disabled = false;
            showToast('Tag suggestion failed: ' + e, 'error');
          });
        }

        function addSuggestedTag(tagName) {
          if (!selectedMemory) return;
          invoke('add_tag', { memoryId: selectedMemory.id, tag: tagName }).then(function() {
            showToast('Tag "' + tagName + '" added!', 'success');
            // Refresh tags
            refreshData();
            // Remove the button
            document.querySelectorAll('.ai-tag-suggestion').forEach(function(btn) {
              if (btn.textContent === tagName) {
                btn.remove();
              }
            });
          }).catch(function(e) {
            showToast('Failed to add tag: ' + e, 'error');
          });
        }

        function aiFindSimilar() {
          if (!selectedMemory) return;

          var btn = document.getElementById('aiFindSimilarBtn');
          btn.classList.add('loading');
          btn.disabled = true;
          var resultsDiv = document.getElementById('aiActionResults');
          resultsDiv.innerHTML = '';
          resultsDiv.style.display = 'none';

          invoke('ai_find_similar', { filePath: selectedMemory.path }).then(function(result) {
            btn.classList.remove('loading');
            btn.disabled = false;

            if (result.similar && result.similar.length > 0) {
              var html = '<div class="ai-results-panel">';
              html += '<div class="ai-results-title"><span class="icon">' + icons.file + '</span> Similar Files</div>';
              html += '<div class="ai-similar-files">';
              result.similar.slice(0, 5).forEach(function(file) {
                var icon = getFileIcon(getFileTypeFromPath(file.path, file.type));
                var reasons = file.reasons ? file.reasons.join(', ') : '';
                html += '<div class="ai-similar-file" onclick="openSimilarFile(\'' + esc(file.path).replace(/'/g, "\\'") + '\')">';
                html += '<span class="icon">' + icon + '</span>';
                html += '<div class="ai-similar-file-info">';
                html += '<div class="ai-similar-file-name" title="' + esc(file.name) + '">' + esc(file.name) + '</div>';
                html += '<div class="ai-similar-file-reasons">' + esc(reasons) + '</div>';
                html += '</div></div>';
              });
              html += '</div></div>';
              resultsDiv.innerHTML = html;
              resultsDiv.style.display = 'block';
            } else {
              showToast('No similar files found', 'info');
            }
          }).catch(function(e) {
            btn.classList.remove('loading');
            btn.disabled = false;
            showToast('Find similar failed: ' + e, 'error');
          });
        }

        function openSimilarFile(path) {
          // Find the memory by path and select it
          var mem = memories.find(function(m) { return m.path === path; });
          if (mem) {
            selectMemory(mem);
          } else {
            invoke('open_in_finder', { path: path }).catch(function() {
              showToast('Could not locate file', 'error');
            });
          }
        }

        function aiSmartRename() {
          if (!selectedMemory) return;

          var btn = document.getElementById('aiSmartRenameBtn');
          btn.classList.add('loading');
          btn.disabled = true;
          var resultsDiv = document.getElementById('aiActionResults');
          resultsDiv.innerHTML = '';
          resultsDiv.style.display = 'none';

          invoke('ai_smart_rename', { filePath: selectedMemory.path }).then(function(result) {
            btn.classList.remove('loading');
            btn.disabled = false;

            if (result.suggestions && result.suggestions.length > 0) {
              var html = '<div class="ai-results-panel">';
              html += '<div class="ai-results-title"><span class="icon">' + icons.doc + '</span> Rename Suggestions</div>';
              html += '<div class="ai-rename-suggestions">';
              result.suggestions.forEach(function(name) {
                html += '<div class="ai-rename-suggestion">';
                html += '<span title="' + esc(name) + '">' + esc(name) + '</span>';
                html += '<button onclick="copyToClipboard(\'' + esc(name).replace(/'/g, "\\'") + '\')">Copy</button>';
                html += '</div>';
              });
              html += '</div></div>';
              resultsDiv.innerHTML = html;
              resultsDiv.style.display = 'block';
            } else {
              showToast('No rename suggestions found', 'info');
            }
          }).catch(function(e) {
            btn.classList.remove('loading');
            btn.disabled = false;
            showToast('Smart rename failed: ' + e, 'error');
          });
        }

        function copyToClipboard(text) {
          navigator.clipboard.writeText(text).then(function() {
            showToast('Copied to clipboard!', 'success');
          }).catch(function() {
            showToast('Failed to copy', 'error');
          });
        }

        function aiAskAboutFile() {
          if (!selectedMemory) return;
          // Open chat and pre-fill with a question about this file
          if (!chatOpen) openChat();
          var filename = selectedMemory.path.split('/').pop();
          var input = document.getElementById('chatInput');
          input.value = 'Tell me about the file "' + filename + '"';
          input.focus();
        }

        function generateCaption() {
          if (!selectedMemory) return;
          var btn = document.getElementById('generateCaptionBtn');
          var captionDiv = document.getElementById('captionText');

          btn.disabled = true;
          btn.textContent = 'Generating...';
          captionDiv.textContent = '';

          invoke('caption_image', { path: selectedMemory.path }).then(function(caption) {
            btn.disabled = false;
            btn.textContent = 'Generate Caption';
            captionDiv.textContent = caption;

            // Store caption in memory object
            if (!selectedMemory.metadata) selectedMemory.metadata = {};
            selectedMemory.metadata.ai_caption = caption;

            showToast('Caption generated!', 'success');
          }).catch(function(e) {
            btn.disabled = false;
            btn.textContent = 'Generate Caption';
            captionDiv.textContent = '';
            showToast('Caption failed: ' + e, 'error');
          });
        }

        function selectMemory(mem) {
          if (!mem) return;
          selectedMemory = mem;
          var panel = document.getElementById('detailPanel');
          panel.classList.add('open');

          var title = (mem.metadata && mem.metadata.title) || mem.path.split('/').pop();
          document.getElementById('detailTitle').textContent = title;
          document.getElementById('detailPath').textContent = mem.path;
          document.getElementById('detailType').textContent = getTypeName(mem.kind);
          document.getElementById('detailSize').textContent = formatSize(mem.metadata ? mem.metadata.file_size : 0);
          document.getElementById('detailDate').textContent = mem.modified_at ? new Date(mem.modified_at).toLocaleDateString() : '-';

          // Star button
          var starBtn = document.getElementById('starBtn');
          document.getElementById('starIcon').innerHTML = mem.is_favorite ? icons.starFilled : icons.star;
          starBtn.className = 'action-btn secondary star' + (mem.is_favorite ? ' active' : '');

          // Tags
          var tagsHtml = '';
          if (mem.tags && mem.tags.length > 0) {
            mem.tags.forEach(function(t) {
              tagsHtml += '<span class="detail-tag" data-tag="' + esc(t.name) + '">' + esc(t.name) + '</span>';
            });
          } else {
            tagsHtml = '<span style="color:#a8a29e;font-size:12px;">No tags</span>';
          }
          document.getElementById('detailTags').innerHTML = tagsHtml;
          document.querySelectorAll('.detail-tag').forEach(function(tag) {
            tag.onclick = function() {
              var tagName = tag.dataset.tag;
              if (activeTags.indexOf(tagName) === -1) {
                activeTags.push(tagName);
                renderActiveTags();
                renderTagBar();
                search(document.getElementById('searchInput').value);
              }
            };
          });

          // Preview
          var preview = document.getElementById('detailPreview');
          var type = getType(mem.kind);
          preview.style.background = getColor(mem.kind);

          if (type === 'image' && convertFileSrc) {
            preview.innerHTML = '<img src="' + convertFileSrc(mem.path) + '" onerror="this.style.display=\'none\'">' + getIcon(mem.kind, '2xl');
          } else if (type === 'video' && convertFileSrc) {
            preview.innerHTML = '<video src="' + convertFileSrc(mem.path) + '" controls onerror="this.style.display=\'none\'"></video>' + getIcon(mem.kind, '2xl');
          } else {
            preview.innerHTML = getIcon(mem.kind, '2xl');
          }

          // Caption section (only for images)
          var captionSection = document.getElementById('captionSection');
          var captionText = document.getElementById('captionText');
          if (type === 'image') {
            captionSection.style.display = 'block';
            var existingCaption = mem.metadata && mem.metadata.ai_caption;
            if (existingCaption) {
              captionText.textContent = existingCaption;
            } else {
              captionText.textContent = '';
            }
          } else {
            captionSection.style.display = 'none';
          }

          // Load virtual paths and similar files
          loadVirtualPaths(mem.id);
          loadSimilarMemories(mem.id);
        }

        function toggleFavorite(id) {
          invoke('toggle_favorite', { memoryId: id }).then(function(isFav) {
            showToast(isFav ? 'Added to favorites' : 'Removed from favorites', 'success');
            memories.forEach(function(m) {
              if (m.id === id) m.is_favorite = isFav;
            });
            if (selectedMemory && selectedMemory.id === id) {
              selectedMemory.is_favorite = isFav;
              selectMemory(selectedMemory);
            }
            renderFiles();
          }).catch(function(e) {
            showToast('Failed: ' + e, 'error');
          });
        }

        function addTagToMemory(tag) {
          if (!selectedMemory || !tag) return;
          invoke('add_tag', { memoryId: selectedMemory.id, tag: tag }).then(function() {
            showToast('Tag added', 'success');
            if (!selectedMemory.tags) selectedMemory.tags = [];
            selectedMemory.tags.push({ name: tag, source: 'User' });
            selectMemory(selectedMemory);
            invoke('get_tags').then(function(tags) {
              allTags = tags || [];
              renderTagBar();
            });
          }).catch(function(e) {
            showToast('Failed: ' + e, 'error');
          });
        }

        // Event listeners
        document.getElementById('closeDetail').onclick = function() {
          document.getElementById('detailPanel').classList.remove('open');
          selectedMemory = null;
        };

        document.getElementById('openBtn').onclick = function() {
          if (selectedMemory) invoke('open_file', { path: selectedMemory.path });
        };

        document.getElementById('revealBtn').onclick = function() {
          if (selectedMemory) invoke('open_in_finder', { path: selectedMemory.path });
        };

        document.getElementById('starBtn').onclick = function() {
          if (selectedMemory) toggleFavorite(selectedMemory.id);
        };

        document.getElementById('tagAddBtn').onclick = function() {
          var input = document.getElementById('tagInput');
          addTagToMemory(input.value.trim().toLowerCase());
          input.value = '';
        };

        document.getElementById('tagInput').onkeydown = function(e) {
          if (e.key === 'Enter') {
            addTagToMemory(e.target.value.trim().toLowerCase());
            e.target.value = '';
          }
        };

        document.getElementById('generateCaptionBtn').onclick = generateCaption;

        // Add source function - made global for empty state button
        window.addSource = function() {
          if (window.__TAURI__.dialog) {
            window.__TAURI__.dialog.open({ directory: true }).then(function(path) {
              if (path) {
                showToast('Indexing folder...', 'info');
                invoke('add_source', { sourceType: 'local', path: path }).then(function() {
                  var count = 0;
                  var interval = setInterval(function() {
                    loadData();
                    if (++count >= 15) {
                      clearInterval(interval);
                      showToast('Indexing complete!', 'success');
                    }
                  }, 2000);
                }).catch(function(e) {
                  showToast('Failed: ' + e, 'error');
                });
              }
            });
          }
        };

        document.getElementById('addBtn').onclick = window.addSource;

        document.getElementById('discoverBtn').onclick = function() {
          discoverCollections();
        };

        document.getElementById('resetBtn').onclick = function() {
          if (confirm('Reset the entire index? This cannot be undone.')) {
            invoke('reset_index').then(function() {
              showToast('Index reset', 'success');
              memories = [];
              sources = [];
              allTags = [];
              selectedMemory = null;
              document.getElementById('detailPanel').classList.remove('open');
              loadData();
            }).catch(function(e) {
              showToast('Failed: ' + e, 'error');
            });
          }
        };

        // Theme toggle function
        function toggleTheme() {
          darkMode = !darkMode;
          localStorage.setItem('hippo-theme', darkMode ? 'dark' : 'light');
          document.body.classList.toggle('dark', darkMode);

          // Update sidebar button
          document.getElementById('themeIcon').innerHTML = darkMode ? icons.sun : icons.moon;
          document.getElementById('darkModeBtn').title = darkMode ? 'Switch to Light Mode' : 'Switch to Dark Mode';

          // Update header button with rotation animation
          var headerBtn = document.getElementById('themeToggleBtn');
          var headerIcon = document.getElementById('themeToggleIcon');
          headerIcon.innerHTML = darkMode ? icons.sun : icons.moon;
          headerBtn.classList.add('rotating');
          setTimeout(function() {
            headerBtn.classList.remove('rotating');
          }, 500);

          showToast(darkMode ? 'Dark mode enabled' : 'Light mode enabled', '');
        }

        // Sidebar dark mode button
        document.getElementById('darkModeBtn').onclick = toggleTheme;

        // Header theme toggle button
        document.getElementById('themeToggleBtn').onclick = toggleTheme;

        document.getElementById('searchInput').oninput = function(e) {
          var query = e.target.value;

          // Detect if query is natural language
          if (searchMode === 'text' && isNaturalLanguageQuery(query)) {
            showNLBadge();
          } else {
            hideNLBadge();
          }

          if (searchMode === 'text') {
            search(query);
          }
          // AI search is triggered on Enter, not on every keystroke
        };

        document.getElementById('searchInput').addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            var query = e.target.value;

            // If in text mode but query looks like NL, use NL search
            if (searchMode === 'text' && isNaturalLanguageQuery(query)) {
              e.preventDefault();
              performNaturalLanguageSearch(query);
            } else if (searchMode !== 'text') {
              e.preventDefault();
              handleAISearch(query);
            }
          }
        });

        document.getElementById('searchInput').onkeydown = function(e) {
          if (e.key === 'Tab' && e.target.value.trim()) {
            e.preventDefault();
            var tag = e.target.value.trim().toLowerCase();
            if (activeTags.indexOf(tag) === -1) {
              activeTags.push(tag);
              renderActiveTags();
              renderTagBar();
            }
            e.target.value = '';
            search('');
          }
        };

        document.getElementById('searchInput').addEventListener('focus', function() {
          if (searchDropdownBlurTimeout) {
            clearTimeout(searchDropdownBlurTimeout);
            searchDropdownBlurTimeout = null;
          }
          if (!this.value || this.value.trim() === '') {
            showSearchDropdown();
          }
        });

        document.getElementById('searchInput').addEventListener('blur', function() {
          searchDropdownBlurTimeout = setTimeout(function() {
            hideSearchDropdown();
          }, 200);
        });

        document.getElementById('searchInput').addEventListener('input', function() {
          if (this.value && this.value.trim()) {
            hideSearchDropdown();
            var saveBtn = document.getElementById('saveSearchBtn');
            if (saveBtn) saveBtn.style.display = 'flex';
          } else {
            showSearchDropdown();
            var saveBtn = document.getElementById('saveSearchBtn');
            if (saveBtn) saveBtn.style.display = 'none';
          }
        });

        document.getElementById('saveSearchBtn').onclick = promptSaveSearch;

        document.getElementById('recentSearchesDropdown').addEventListener('mousedown', function(e) {
          if (searchDropdownBlurTimeout) {
            clearTimeout(searchDropdownBlurTimeout);
            searchDropdownBlurTimeout = null;
          }
        });

        document.querySelectorAll('.filter-btn').forEach(function(btn) {
          btn.onclick = function() {
            document.querySelectorAll('.filter-btn').forEach(function(b) { b.classList.remove('active'); });
            btn.classList.add('active');
            filterType = btn.dataset.filter;
            keyboardFocusIndex = -1; // Reset keyboard focus on filter change
            renderFiles();
          };
        });

        // Date filter buttons
        document.querySelectorAll('.date-filter-btn').forEach(function(btn) {
          btn.onclick = function() {
            document.querySelectorAll('.date-filter-btn').forEach(function(b) { b.classList.remove('active'); });
            btn.classList.add('active');
            dateFilter = btn.dataset.date;
            keyboardFocusIndex = -1; // Reset keyboard focus
            renderFiles();
          };
        });

        document.getElementById('gridViewBtn').onclick = function() {
          viewMode = 'grid';
          document.getElementById('gridViewBtn').classList.add('active');
          document.getElementById('listViewBtn').classList.remove('active');
          document.getElementById('graphViewBtn').classList.remove('active');
          renderFiles();
        };

        document.getElementById('listViewBtn').onclick = function() {
          viewMode = 'list';
          document.getElementById('listViewBtn').classList.add('active');
          document.getElementById('gridViewBtn').classList.remove('active');
          document.getElementById('graphViewBtn').classList.remove('active');
          renderFiles();
        };

        document.getElementById('graphViewBtn').onclick = function() {
          viewMode = 'graph';
          document.getElementById('graphViewBtn').classList.add('active');
          document.getElementById('gridViewBtn').classList.remove('active');
          document.getElementById('listViewBtn').classList.remove('active');
          renderFiles();
        };

        document.getElementById('multiSelectToggle').onclick = function() {
          isMultiSelectMode = !isMultiSelectMode;
          if (isMultiSelectMode) {
            document.getElementById('multiSelectToggle').classList.add('active');
          } else {
            document.getElementById('multiSelectToggle').classList.remove('active');
            clearSelection();
          }
          renderFiles();
        };

        // Settings event bindings
        document.getElementById('settingsBtn').onclick = openSettings;
        document.getElementById('closeSettings').onclick = closeSettings;
        document.getElementById('settingsCancel').onclick = closeSettings;
        document.getElementById('settingsSave').onclick = saveSettings;
        document.getElementById('settingsOverlay').onclick = function(e) {
          if (e.target === this) closeSettings();
        };
        document.getElementById('aiProvider').onchange = updateProviderUI;
        document.getElementById('refreshOllamaStatus').onclick = checkOllamaStatus;
        document.getElementById('pullModelBtn').onclick = pullModel;

        // Chat event bindings
        document.getElementById('chatBtn').onclick = openChat;
        document.getElementById('chatBubble').onclick = openChat;
        document.getElementById('chatMinimizeBtn').onclick = closeChat;
        document.getElementById('chatClearBtn').onclick = clearChatHistory;
        document.getElementById('chatSettingsBtn').onclick = openSettings;
        document.getElementById('chatSendBtn').onclick = sendChatMessage;
        document.getElementById('chatInput').onkeypress = function(e) {
          if (e.key === 'Enter') sendChatMessage();
        };
        // File context actions
        document.getElementById('analyzeSelectedBtn').onclick = analyzeSelectedFiles;
        document.getElementById('summarizeSelectedBtn').onclick = summarizeSelectedFiles;
        document.getElementById('clearContextBtn').onclick = clearChatContext;
        document.getElementById('attachFileBtn').onclick = attachSelectedFiles;
        // Quick action handlers
        attachQuickActionHandlers();

        // Search mode buttons
        document.querySelectorAll('.search-mode-btn').forEach(function(btn) {
          btn.onclick = function() {
            setSearchMode(btn.dataset.mode);
            var query = document.getElementById('searchInput').value.trim();
            if (query && searchMode !== 'text') {
              handleAISearch(query);
            }
          };
        });

        // AI analyze button
        document.getElementById('aiAnalyzeBtn').onclick = analyzeWithAI;

        // AI action buttons
        document.getElementById('aiSuggestTagsBtn').onclick = aiSuggestTags;
        document.getElementById('aiFindSimilarBtn').onclick = aiFindSimilar;
        document.getElementById('aiSmartRenameBtn').onclick = aiSmartRename;
        document.getElementById('aiAskAboutBtn').onclick = aiAskAboutFile;

        // Initialize search mode from saved preference
        setSearchMode(searchMode);

        // Bulk action bar event bindings
        document.getElementById('bulkFavorite').onclick = function() {
          bulkToggleFavorite();
        };

        document.getElementById('bulkTag').onclick = function() {
          openTagModal();
        };

        document.getElementById('bulkDelete').onclick = function() {
          bulkDeleteFiles();
        };

        document.getElementById('bulkSelectAll').onclick = function() {
          var filtered = getFiltered();
          if (selectedIds.length === filtered.length) {
            clearSelection();
          } else {
            selectAll();
          }
        };

        document.getElementById('bulkClose').onclick = function() {
          clearSelection();
        };

        // Tag modal event bindings
        document.getElementById('tagModalCancel').onclick = function() {
          closeTagModal();
        };

        document.getElementById('tagModalConfirm').onclick = function() {
          bulkAddTag();
        };

        document.getElementById('bulkTagInput').onkeydown = function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            bulkAddTag();
          } else if (e.key === 'Escape') {
            closeTagModal();
          }
        };

        document.getElementById('tagModal').onclick = function(e) {
          if (e.target === this) closeTagModal();
        };

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
          // Command palette
          if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
            e.preventDefault();
            openCommandPalette();
            return;
          }
          // Quick shortcuts (only when not typing)
          var isTyping = document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA';
          if (!isTyping) {
            if ((e.metaKey || e.ctrlKey) && e.key === 'd') {
              e.preventDefault();
              document.getElementById('darkModeBtn').click();
            }
            if ((e.metaKey || e.ctrlKey) && e.key === 'o') {
              e.preventDefault();
              document.getElementById('addBtn').click();
            }
            if ((e.metaKey || e.ctrlKey) && e.key === 'f') {
              e.preventDefault();
              document.getElementById('searchInput').focus();
            }
            // Select all with Cmd+A
            if ((e.metaKey || e.ctrlKey) && e.key === 'a') {
              e.preventDefault();
              selectAll();
            }
          }
          if (e.key === 'Escape') {
            // Close modals in order of priority
            if (document.getElementById('tagModal').classList.contains('open')) {
              closeTagModal();
            } else if (document.getElementById('cmdOverlay').classList.contains('open')) {
              closeCommandPalette();
            } else if (selectedIds.length > 0) {
              clearSelection();
            } else if (keyboardFocusIndex >= 0) {
              keyboardFocusIndex = -1;
              updateKeyboardFocus();
            } else {
              document.getElementById('detailPanel').classList.remove('open');
              selectedMemory = null;
            }
          }
          // Arrow key navigation for grid/list
          if (!isTyping && (e.key === 'ArrowUp' || e.key === 'ArrowDown' || e.key === 'ArrowLeft' || e.key === 'ArrowRight')) {
            e.preventDefault();
            handleArrowNavigation(e.key);
          }
          // Enter/Space to open focused item
          if (!isTyping && (e.key === 'Enter' || e.key === ' ') && keyboardFocusIndex >= 0) {
            e.preventDefault();
            var displayed = getDisplayedMemories();
            if (displayed[keyboardFocusIndex]) {
              openDetail(displayed[keyboardFocusIndex]);
            }
          }
        });

        // Drag and drop file upload
        var dragCounter = 0;
        var dropZoneEl = document.getElementById('dropZone');
        var dropZoneIconEl = document.getElementById('dropZoneIcon');

        document.addEventListener('dragenter', function(e) {
          e.preventDefault();
          dragCounter++;
          if (dragCounter === 1) {
            dropZoneEl.classList.add('active');
            dropZoneIconEl.innerHTML = icons.folderPlus;
          }
        });

        document.addEventListener('dragover', function(e) {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'copy';
        });

        document.addEventListener('dragleave', function(e) {
          e.preventDefault();
          dragCounter--;
          if (dragCounter === 0) {
            dropZoneEl.classList.remove('active');
          }
        });

        document.addEventListener('drop', function(e) {
          e.preventDefault();
          dragCounter = 0;
          dropZoneEl.classList.remove('active');

          // In Tauri, we need to use the event system to get dropped file paths
          // The file paths will be handled by the Tauri window event listener below
        });

        // Listen for Tauri file drop events
        if (window.__TAURI__ && window.__TAURI__.event) {
          window.__TAURI__.event.listen('tauri://file-drop', function(event) {
            var paths = event.payload;
            if (paths && paths.length > 0) {
              handleDroppedPaths(paths);
            }
          }).catch(function(err) {
            console.error('Failed to set up file drop listener:', err);
          });
        }

        function handleDroppedPaths(paths) {
          if (paths.length === 0) return;

          // Filter to only directories - we'll check each path
          var folderCount = 0;
          var completed = 0;

          showToast('Processing ' + paths.length + ' item(s)...', 'info');

          paths.forEach(function(path) {
            // Try to add each path as a source
            // The backend will validate if it's a directory
            invoke('add_source', { sourceType: 'local', path: path }).then(function() {
              folderCount++;
              completed++;

              if (completed === paths.length) {
                if (folderCount > 0) {
                  var count = 0;
                  var interval = setInterval(function() {
                    loadData();
                    if (++count >= 15) {
                      clearInterval(interval);
                      showToast('Indexing complete! Added ' + folderCount + ' folder(s)', 'success');
                    }
                  }, 2000);
                } else {
                  showToast('No valid folders were dropped. Please drop directories to index.', 'error');
                }
              }
            }).catch(function(e) {
              completed++;
              console.error('Failed to add source:', path, e);

              if (completed === paths.length && folderCount === 0) {
                showToast('Please drop folders (not individual files) to index', 'error');
              }
            });
          });
        }

        // Expose for inline handlers
        window.openInFinder = function(path) {
          invoke('open_in_finder', { path: path });
        };
        window.addSuggestedTag = addSuggestedTag;
        window.openSimilarFile = openSimilarFile;
        window.copyToClipboard = copyToClipboard;
        window.openChatFile = openChatFile;
        window.handleMsgAction = handleMsgAction;
        window.copyCodeBlock = copyCodeBlock;
        window.searchForFile = searchForFile;
      });

      // Helpers
      function getType(kind) {
        if (!kind) return 'other';
        if (kind.Image) return 'image';
        if (kind.Video) return 'video';
        if (kind.Audio) return 'audio';
        if (kind.Code) return 'code';
        if (kind.Document) return 'document';
        return 'other';
      }

      function getTypeName(kind) {
        if (!kind) return 'File';
        if (kind.Image) return 'Image (' + kind.Image.width + 'x' + kind.Image.height + ')';
        if (kind.Video) return 'Video';
        if (kind.Audio) return 'Audio';
        if (kind.Code) return kind.Code.language + ' (' + kind.Code.lines + ' lines)';
        if (kind.Document) return 'Document';
        return 'File';
      }

      function getColor(kind) {
        if (!kind) return '#E5E7EB';
        if (kind.Image) return '#FEE2E2';
        if (kind.Video) return '#DBEAFE';
        if (kind.Audio) return '#F3E8FF';
        if (kind.Code) return '#DCFCE7';
        if (kind.Document) return '#FEF3C7';
        return '#E5E7EB';
      }

      function getIcon(kind, size) {
        size = size || 'xl';
        var iconName = 'file';
        if (kind) {
          if (kind.Image) iconName = 'image';
          else if (kind.Video) iconName = 'video';
          else if (kind.Audio) iconName = 'audio';
          else if (kind.Code) iconName = 'code';
          else if (kind.Document) iconName = 'doc';
        }
        return '<span class="icon icon-' + size + '" style="color:#666;">' + icons[iconName] + '</span>';
      }

      function formatSize(bytes) {
        if (!bytes) return '0 B';
        var k = 1024, sizes = ['B', 'KB', 'MB', 'GB'];
        var i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i)) + ' ' + sizes[i];
      }

      // Alias for formatSize
      function formatBytes(bytes) {
        return formatSize(bytes);
      }

      function esc(s) {
        return s ? s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;') : '';
      }
    })();
  </script>
  <!-- Prism.js scripts -->
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-javascript.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-typescript.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-python.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-rust.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-go.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-java.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-markup.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-css.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-json.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-yaml.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-markdown.min.js"></script>
</body>
</html>
